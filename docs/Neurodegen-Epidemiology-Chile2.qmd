---
title: "Neurodegenerative Diseases"
author:
  - name: "Amaru Simón Agüero Jiménez"
    email: "aaguero@miaundes.cl"
    orcid: "0000-0001-7336-1833"
date: "today"
format:
  html:
    embed-resources: false
    smooth-scroll: true
    toc: true
    toc-depth: 6
    toc-location: right
    number-sections: true
    number-depth: 6
    code-fold: true
    theme: cosmo
    fig-cap-location: bottom
execute:
  warning: false
  message: false
  fig-width: 12
  fig-height: 10
---

# Results - Neurodegenerative Diseases Analysis

```{python}
#| label: setup
#| include: false

import sys
import subprocess
import importlib
from subprocess import DEVNULL

def _pip_install(requirement: str):
    subprocess.check_call([sys.executable, "-m", "pip", "install", "--upgrade", requirement],
                          stdout=DEVNULL, stderr=DEVNULL)

try:
    from packaging.requirements import Requirement
except Exception:
    _pip_install("packaging")
    from packaging.requirements import Requirement

def ensure(requirement: str, import_name: str = None):
    req = Requirement(requirement)
    name = import_name or req.name
    try:
        mod = importlib.import_module(name)
        ver = getattr(mod, "__version__", None)
        if ver is not None and req.specifier and not req.specifier.contains(ver, prereleases=True):
            raise ImportError()
        return mod
    except Exception:
        _pip_install(requirement)
        return importlib.import_module(name)

ensure("numpy")
ensure("scipy")
ensure("pandas>=2.0.0", "pandas")
ensure("pyarrow>=10.0.0", "pyarrow")
ensure("matplotlib")
ensure("seaborn")
ensure("requests")
ensure("geopandas")
ensure("libpysal")
ensure("esda")
ensure("splot")

import pandas as pd
import numpy as np
import os
import glob
import warnings
import matplotlib.pyplot as plt
import seaborn as sns
import geopandas as gpd
from IPython.display import display

warnings.filterwarnings('ignore')
plt.rcParams['figure.dpi'] = 100
plt.rcParams['savefig.dpi'] = 150
sns.set_style("whitegrid")
pd.set_option('display.max_columns', None)
pd.set_option('display.precision', 2)

base_path = os.path.dirname(os.getcwd())
data_path = os.path.join(base_path, 'data')
output_path = os.path.join(base_path, 'output_files')
figures_path = os.path.join(output_path, 'figures')

os.makedirs(output_path, exist_ok=True)
os.makedirs(figures_path, exist_ok=True)
```

```{python}
#| label: constants
#| include: false

# WHO Standard Population for direct standardization
WHO_STANDARD_POPULATION = {
    '0-4': 8860, '5-9': 8690, '10-14': 8600, '15-19': 8470,
    '20-24': 8220, '25-29': 7930, '30-34': 7610, '35-39': 7150,
    '40-44': 6590, '45-49': 6040, '50-54': 5370, '55-59': 4550,
    '60-64': 3720, '65-69': 2960, '70-74': 2210, '75-79': 1520,
    '80+': 1540
}

TOTAL_WHO_WEIGHT = sum(WHO_STANDARD_POPULATION.values())

# =============================================================================
# SPECIFIC ICD-10 CODES FOR NEURODEGENERATIVE DISEASES ANALYSIS
# =============================================================================

# F-codes: Dementia and organic mental disorders
# F00, F01, F03, F04: All subcodes accepted
# F02: Only F02.0 and F02.3
# F06: Only F06.7
NEURODEG_CODES_F = {
    'F00': 'Dementia in Alzheimer disease',
    'F01': 'Vascular dementia',
    'F02': 'Dementia in other diseases classified elsewhere',
    'F03': 'Unspecified dementia',
    'F04': 'Organic amnesic syndrome',
    'F06.7': 'Mild cognitive disorder'
}

# G-codes: Neurological degenerative diseases
# G20, G30, G31, G32: All subcodes accepted
NEURODEG_CODES_G = {
    'G20': 'Parkinson disease',
    'G30': 'Alzheimer disease',
    'G31': 'Other degenerative diseases of nervous system',
    'G32': 'Other degenerative disorders of nervous system in diseases classified elsewhere'
}

ALL_NEURODEG_CODES = {**NEURODEG_CODES_F, **NEURODEG_CODES_G}

# Lists for filtering
F_CODES_LIST = ['F00', 'F01', 'F02', 'F03', 'F04', 'F06.7']
G_CODES_LIST = ['G20', 'G30', 'G31', 'G32']

AGE_GROUPS_TUPLES = [
    (0, 4), (5, 9), (10, 14), (15, 19), (20, 24), (25, 29),
    (30, 34), (35, 39), (40, 44), (45, 49), (50, 54), (55, 59),
    (60, 64), (65, 69), (70, 74), (75, 79)
]

YEARS = [2019, 2020, 2021, 2022, 2023, 2024]
```

```{python}
#| label: functions
#| include: false

def assign_age_group(age):
    if pd.isna(age) or age is None:
        return None
    try:
        age = int(float(age))
    except (ValueError, TypeError):
        return None
    if age < 0:
        return None
    if age >= 80:
        return '80+'
    for start, end in AGE_GROUPS_TUPLES:
        if start <= age <= end:
            return f"{start}-{end}"
    return None


def parse_date(date_str, year=None):
    if pd.isna(date_str) or date_str == '':
        return pd.NaT
    date_str = str(date_str).strip()
    for fmt in ['%Y-%m-%d', '%d-%m-%Y']:
        try:
            return pd.to_datetime(date_str, format=fmt)
        except:
            pass
    try:
        return pd.to_datetime(date_str)
    except:
        return pd.NaT


def calculate_age(birth_date_str, admission_date_str, year=None):
    birth_date = parse_date(birth_date_str)
    admission_date = parse_date(admission_date_str, year)
    if pd.isna(birth_date) or pd.isna(admission_date):
        return None
    age = (admission_date - birth_date).days / 365.25
    if age < 0 or age > 120:
        return None
    return int(round(age))


def is_valid_neurodeg_code(code_str):
    """
    Validate ICD-10 codes according to study specifications:
    - F00, F01, F03, F04: all subcodes accepted
    - F02: only F02.0 and F02.3
    - F06: only F06.7
    - G20, G30, G31, G32: all subcodes accepted
    
    Returns: (is_valid, code_group)
    """
    if pd.isna(code_str) or code_str == '':
        return False, None
    
    code = str(code_str).upper().strip().replace('.', '')
    code_3char = code[:3]
    
    # F-codes that accept all subcodes
    if code_3char in ['F00', 'F01', 'F03', 'F04']:
        return True, code_3char
    
    # F02: only F02.0 and F02.3
    if code_3char == 'F02':
        if len(code) >= 4 and code[:4] in ['F020', 'F023']:
            return True, 'F02'
        return False, None
    
    # F06: only F06.7
    if code_3char == 'F06':
        if len(code) >= 4 and code[:4] == 'F067':
            return True, 'F06.7'
        return False, None
    
    # G-codes that accept all subcodes
    if code_3char in ['G20', 'G30', 'G31', 'G32']:
        return True, code_3char
    
    return False, None


def get_neurodeg_codes_from_row(row, diag_cols):
    codes_found = set()
    for col in diag_cols:
        v = row.get(col)
        is_valid, code_group = is_valid_neurodeg_code(v)
        if is_valid:
            codes_found.add(code_group)
    return codes_found


def load_and_filter_neurodeg_data(years=YEARS, chunksize=100000):
    all_records = []
    
    for year in years:
        pattern = f"GRD_PUBLICO_*{year}*.csv"
        files = glob.glob(os.path.join(data_path, pattern))
        if not files:
            continue
        
        for chunk in pd.read_csv(files[0], delimiter='|', dtype=str, 
                                  low_memory=False, chunksize=chunksize):
            diag_cols = [col for col in chunk.columns if col.startswith('DIAGNOSTICO')]
            if not diag_cols:
                continue
            
            for _, row in chunk.iterrows():
                codes_found = get_neurodeg_codes_from_row(row, diag_cols)
                if not codes_found:
                    continue
                
                age = calculate_age(row.get('FECHA_NACIMIENTO'), row.get('FECHA_INGRESO'), year)
                sex_val = str(row.get('SEXO', '')).strip().upper()
                sex = 'Male' if sex_val in ['1', 'HOMBRE'] else ('Female' if sex_val in ['2', 'MUJER'] else None)
                age_group = assign_age_group(age)
                
                for code in codes_found:
                    all_records.append({
                        'year': year,
                        'age': age,
                        'age_group': age_group,
                        'sex': sex,
                        'icd_code': code
                    })
    
    if not all_records:
        return pd.DataFrame(columns=['year', 'age', 'age_group', 'sex', 'icd_code', 'hospitalizations'])
    
    df = pd.DataFrame(all_records)
    df_counts = df.groupby(['year', 'age_group', 'sex', 'icd_code']).size().reset_index(name='hospitalizations')
    return df_counts


def _normalize_txt(x):
    if pd.isna(x):
        return None
    s = str(x).strip().lower()
    repl = str.maketrans({'á': 'a', 'é': 'e', 'í': 'i', 'ó': 'o', 'ú': 'u', 'ñ': 'n'})
    return s.translate(repl)


def _standardize_sex(x):
    if pd.isna(x):
        return None
    v = _normalize_txt(x)
    if v is None:
        return None
    v = v.replace('.', '').replace('-', ' ').replace('_', ' ').strip()
    if v in {'1', 'm', 'male', 'masculino', 'hombre', 'hombres', 'varon', 'varones'}:
        return 'Male'
    if v in {'2', 'f', 'female', 'femenino', 'mujer', 'mujeres'}:
        return 'Female'
    return None


def _find_first_existing(paths):
    for p in paths:
        if p and os.path.exists(p):
            return p
    return None


PARQUET_TO_STANDARD_REGION = {
    'Arica y Parinacota': 'Arica y Parinacota',
    'Tarapacá': 'Tarapacá',
    'Antofagasta': 'Antofagasta',
    'Atacama': 'Atacama',
    'Coquimbo': 'Coquimbo',
    'Valparaíso': 'Valparaíso',
    'Metropolitana de Santiago': 'Metropolitana',
    "Libertador General Bernardo O'Higgins": "O'Higgins",
    'Maule': 'Maule',
    'Ñuble': 'Ñuble',
    'Biobío': 'Biobío',
    'La Araucanía': 'La Araucanía',
    'Los Ríos': 'Los Ríos',
    'Los Lagos': 'Los Lagos',
    'Aysén del General Carlos Ibáñez del Campo': 'Aysén',
    'Magallanes y de la Antártica Chilena': 'Magallanes'
}


def normalize_region_to_standard(region_name):
    if pd.isna(region_name):
        return None
    name = str(region_name).strip()
    return PARQUET_TO_STANDARD_REGION.get(name, name)


def load_population_data(years=YEARS):
    candidate_paths = [
        os.path.join(data_path, 'censo_proyecciones_ano_edad_genero.parquet'),
        os.path.join(data_path, 'censo_proyecciones_año_edad_genero.parquet'),
        os.path.join(base_path, 'censo_proyecciones_ano_edad_genero.parquet'),
        os.path.join(base_path, 'censo_proyecciones_año_edad_genero.parquet'),
    ]
    
    pop_file = _find_first_existing(candidate_paths)
    if pop_file is None:
        patterns = [os.path.join(data_path, '**', 'censo_proyecciones*edad_genero*.parquet')]
        matches = []
        for pat in patterns:
            matches.extend(glob.glob(pat, recursive=True))
        pop_file = matches[0] if matches else None
    
    if pop_file is None:
        raise FileNotFoundError("Population projections file not found.")
    
    df = pd.read_parquet(pop_file, engine="pyarrow")
    df.columns = [str(c).strip() for c in df.columns]
    cols_norm = {_normalize_txt(c): c for c in df.columns}
    
    year_col = cols_norm.get('ano') or cols_norm.get('anio') or cols_norm.get('year')
    age_col = cols_norm.get('edad') or cols_norm.get('age')
    sex_col = cols_norm.get('genero') or cols_norm.get('sexo') or cols_norm.get('sex')
    pop_col = cols_norm.get('poblacion') or cols_norm.get('population')
    region_col = cols_norm.get('region')
    comuna_col = cols_norm.get('comuna')
    
    keep_cols = [year_col, age_col, sex_col, pop_col]
    if region_col:
        keep_cols.append(region_col)
    if comuna_col:
        keep_cols.append(comuna_col)
    
    pop = df[keep_cols].copy()
    rename_map = {year_col: 'year', age_col: 'age', sex_col: 'sex', pop_col: 'population'}
    if region_col:
        rename_map[region_col] = 'region'
    if comuna_col:
        rename_map[comuna_col] = 'comuna'
    pop.rename(columns=rename_map, inplace=True)
    
    pop['year'] = pd.to_numeric(pop['year'], errors='coerce').astype('Int64')
    pop = pop[pop['year'].isin(years)]
    pop['population'] = pd.to_numeric(pop['population'], errors='coerce')
    pop['sex'] = pop['sex'].apply(_standardize_sex)
    pop['age_group'] = pop['age'].apply(assign_age_group)
    pop = pop.dropna(subset=['year', 'sex', 'age_group', 'population'])
    pop = pop[pop['population'] > 0]
    
    if 'region' in pop.columns:
        pop['region'] = pop['region'].apply(normalize_region_to_standard)
    
    group_cols = [c for c in ['region', 'comuna', 'year', 'age_group', 'sex'] if c in pop.columns]
    pop_agg = pop.groupby(group_cols, as_index=False)['population'].sum()
    return pop_agg


def calculate_asr_by_sex(hosp, pop, per=100000):
    who_weights = pd.DataFrame([
        {'age_group': k, 'who_weight': v} for k, v in WHO_STANDARD_POPULATION.items()
    ])
    
    hosp_agg = hosp.groupby(['year', 'age_group', 'sex'])['hospitalizations'].sum().reset_index()
    pop_agg = pop.groupby(['year', 'age_group', 'sex'])['population'].sum().reset_index()
    
    merged = hosp_agg.merge(pop_agg, on=['year', 'age_group', 'sex'], how='left')
    merged = merged.dropna(subset=['population'])
    merged = merged[merged['population'] > 0]
    merged['age_specific_rate'] = (merged['hospitalizations'] / merged['population']) * per
    merged = merged.merge(who_weights, on='age_group', how='left')
    merged['weighted_rate'] = merged['age_specific_rate'] * merged['who_weight']
    
    result = merged.groupby(['year', 'sex']).agg({
        'hospitalizations': 'sum',
        'population': 'sum',
        'weighted_rate': 'sum'
    }).reset_index()
    
    result['crude_rate'] = ((result['hospitalizations'] / result['population']) * per).round(2)
    result['asr'] = (result['weighted_rate'] / TOTAL_WHO_WEIGHT).round(2)
    result.drop(columns=['weighted_rate'], inplace=True)
    
    return result[['year', 'sex', 'hospitalizations', 'population', 'crude_rate', 'asr']]


def calculate_asr_sex_columns(hosp, pop, per=100000):
    who_weights = pd.DataFrame([
        {'age_group': k, 'who_weight': v} for k, v in WHO_STANDARD_POPULATION.items()
    ])
    
    hosp_agg = hosp.groupby(['year', 'age_group', 'sex'])['hospitalizations'].sum().reset_index()
    pop_agg = pop.groupby(['year', 'age_group', 'sex'])['population'].sum().reset_index()
    
    merged = hosp_agg.merge(pop_agg, on=['year', 'age_group', 'sex'], how='left')
    merged = merged.dropna(subset=['population'])
    merged = merged[merged['population'] > 0]
    merged['age_specific_rate'] = (merged['hospitalizations'] / merged['population']) * per
    merged = merged.merge(who_weights, on='age_group', how='left')
    merged['weighted_rate'] = merged['age_specific_rate'] * merged['who_weight']
    
    by_sex = merged.groupby(['year', 'sex']).agg({
        'hospitalizations': 'sum',
        'population': 'sum',
        'weighted_rate': 'sum'
    }).reset_index()
    
    by_sex['crude_rate'] = ((by_sex['hospitalizations'] / by_sex['population']) * per).round(2)
    by_sex['asr'] = (by_sex['weighted_rate'] / TOTAL_WHO_WEIGHT).round(2)
    
    hosp_total = hosp.groupby(['year', 'age_group'])['hospitalizations'].sum().reset_index()
    pop_total = pop.groupby(['year', 'age_group'])['population'].sum().reset_index()
    
    merged_total = hosp_total.merge(pop_total, on=['year', 'age_group'], how='left')
    merged_total = merged_total.dropna(subset=['population'])
    merged_total = merged_total[merged_total['population'] > 0]
    merged_total['age_specific_rate'] = (merged_total['hospitalizations'] / merged_total['population']) * per
    merged_total = merged_total.merge(who_weights, on='age_group', how='left')
    merged_total['weighted_rate'] = merged_total['age_specific_rate'] * merged_total['who_weight']
    
    total_agg = merged_total.groupby('year').agg({
        'hospitalizations': 'sum',
        'population': 'sum',
        'weighted_rate': 'sum'
    }).reset_index()
    
    total_agg['crude_rate'] = ((total_agg['hospitalizations'] / total_agg['population']) * per).round(2)
    total_agg['asr'] = (total_agg['weighted_rate'] / TOTAL_WHO_WEIGHT).round(2)
    
    male = by_sex[by_sex['sex'] == 'Male'][['year', 'hospitalizations', 'population', 'crude_rate', 'asr']].copy()
    male.columns = ['year', 'hosp_male', 'pop_male', 'crude_rate_male', 'asr_male']
    
    female = by_sex[by_sex['sex'] == 'Female'][['year', 'hospitalizations', 'population', 'crude_rate', 'asr']].copy()
    female.columns = ['year', 'hosp_female', 'pop_female', 'crude_rate_female', 'asr_female']
    
    total = total_agg[['year', 'hospitalizations', 'population', 'crude_rate', 'asr']].copy()
    total.columns = ['year', 'hosp_total', 'pop_total', 'crude_rate_total', 'asr_total']
    
    result = male.merge(female, on='year', how='outer').merge(total, on='year', how='outer')
    result.sort_values('year', inplace=True)
    result.reset_index(drop=True, inplace=True)
    
    return result


def calculate_asr_by_icd(hosp, pop, per=100000):
    who_weights = pd.DataFrame([
        {'age_group': k, 'who_weight': v} for k, v in WHO_STANDARD_POPULATION.items()
    ])
    
    hosp_agg = hosp.groupby(['year', 'age_group', 'sex', 'icd_code'])['hospitalizations'].sum().reset_index()
    pop_agg = pop.groupby(['year', 'age_group', 'sex'])['population'].sum().reset_index()
    
    merged = hosp_agg.merge(pop_agg, on=['year', 'age_group', 'sex'], how='left')
    merged = merged.dropna(subset=['population'])
    merged = merged[merged['population'] > 0]
    merged['age_specific_rate'] = (merged['hospitalizations'] / merged['population']) * per
    merged = merged.merge(who_weights, on='age_group', how='left')
    merged['weighted_rate'] = merged['age_specific_rate'] * merged['who_weight']
    
    by_sex = merged.groupby(['year', 'icd_code', 'sex']).agg({
        'hospitalizations': 'sum',
        'weighted_rate': 'sum'
    }).reset_index()
    by_sex['asr'] = (by_sex['weighted_rate'] / TOTAL_WHO_WEIGHT).round(2)
    
    hosp_total = hosp.groupby(['year', 'age_group', 'icd_code'])['hospitalizations'].sum().reset_index()
    pop_total = pop.groupby(['year', 'age_group'])['population'].sum().reset_index()
    
    merged_total = hosp_total.merge(pop_total, on=['year', 'age_group'], how='left')
    merged_total = merged_total.dropna(subset=['population'])
    merged_total = merged_total[merged_total['population'] > 0]
    merged_total['age_specific_rate'] = (merged_total['hospitalizations'] / merged_total['population']) * per
    merged_total = merged_total.merge(who_weights, on='age_group', how='left')
    merged_total['weighted_rate'] = merged_total['age_specific_rate'] * merged_total['who_weight']
    
    total_agg = merged_total.groupby(['year', 'icd_code']).agg({
        'hospitalizations': 'sum',
        'weighted_rate': 'sum'
    }).reset_index()
    total_agg['asr'] = (total_agg['weighted_rate'] / TOTAL_WHO_WEIGHT).round(2)
    
    male = by_sex[by_sex['sex'] == 'Male'][['year', 'icd_code', 'hospitalizations', 'asr']].copy()
    male.columns = ['year', 'icd_code', 'hosp_male', 'asr_male']
    
    female = by_sex[by_sex['sex'] == 'Female'][['year', 'icd_code', 'hospitalizations', 'asr']].copy()
    female.columns = ['year', 'icd_code', 'hosp_female', 'asr_female']
    
    total = total_agg[['year', 'icd_code', 'hospitalizations', 'asr']].copy()
    total.columns = ['year', 'icd_code', 'hosp_total', 'asr_total']
    
    result = male.merge(female, on=['year', 'icd_code'], how='outer')
    result = result.merge(total, on=['year', 'icd_code'], how='outer')
    result['description'] = result['icd_code'].map(ALL_NEURODEG_CODES)
    
    cols = ['year', 'icd_code', 'description', 'hosp_male', 'hosp_female', 'hosp_total',
            'asr_male', 'asr_female', 'asr_total']
    result = result[cols]
    result.sort_values(['year', 'icd_code'], inplace=True)
    result.reset_index(drop=True, inplace=True)
    
    return result


def save_figure(fig, filename):
    filepath = os.path.join(figures_path, filename)
    fig.savefig(filepath, dpi=150, bbox_inches='tight', facecolor='white')
```

```{python}
#| label: load-data
#| include: false

hospitalizations = load_and_filter_neurodeg_data(years=YEARS, chunksize=100000)
population_detail = load_population_data(years=YEARS)
population = population_detail.groupby(['year', 'age_group', 'sex'])['population'].sum().reset_index()

if 'region' in population_detail.columns:
    population_regional = population_detail.groupby(['region', 'year', 'age_group', 'sex'])['population'].sum().reset_index()
else:
    population_regional = None

hospitalizations.to_csv(os.path.join(output_path, 'hospitalizations_neurodeg.csv'), index=False)
population.to_csv(os.path.join(output_path, 'population_chile.csv'), index=False)
if population_regional is not None:
    population_regional.to_csv(os.path.join(output_path, 'population_chile_by_region.csv'), index=False)

asr_by_sex = calculate_asr_by_sex(hospitalizations, population)
asr_sex_cols = calculate_asr_sex_columns(hospitalizations, population)
asr_by_icd = calculate_asr_by_icd(hospitalizations, population)

asr_by_sex.to_csv(os.path.join(output_path, 'asr_by_sex.csv'), index=False)
asr_sex_cols.to_csv(os.path.join(output_path, 'asr_sex_columns.csv'), index=False)
asr_by_icd.to_csv(os.path.join(output_path, 'asr_by_icd.csv'), index=False)
```

## Age-Standardized Rates Analysis

### Standardized Rates by Sex and Age

```{python}
#| label: tbl-asr-by-sex
#| tbl-cap: "Age-standardized hospitalization rates by sex (per 100,000)"
#| tbl-cap-location: bottom

asr_by_sex.style.format({
    'hospitalizations': '{:,.0f}',
    'population': '{:,.0f}',
    'crude_rate': '{:.2f}',
    'asr': '{:.2f}'
}).hide(axis="index")
```

```{python}
#| label: fig-asr-by-sex
#| fig-cap: "Age-standardized rates by sex (2019-2024)"
#| fig-width: 12
#| fig-height: 5

fig, axes = plt.subplots(1, 2, figsize=(12, 5))

ax1 = axes[0]
for sex in asr_by_sex['sex'].unique():
    df_sex = asr_by_sex[asr_by_sex['sex'] == sex]
    ax1.plot(df_sex['year'], df_sex['asr'], marker='o', linewidth=2, markersize=8, label=sex)

ax1.set_xlabel('Year')
ax1.set_ylabel('ASR (per 100,000)')
ax1.set_title('Age-Standardized Rate by Sex', fontweight='bold')
ax1.legend()
ax1.grid(True, alpha=0.3)
ax1.set_xticks(YEARS)

ax2 = axes[1]
for sex in asr_by_sex['sex'].unique():
    df_sex = asr_by_sex[asr_by_sex['sex'] == sex]
    ax2.plot(df_sex['year'], df_sex['crude_rate'], marker='s', linewidth=2, markersize=8, label=sex)

ax2.set_xlabel('Year')
ax2.set_ylabel('Crude Rate (per 100,000)')
ax2.set_title('Crude Rate by Sex', fontweight='bold')
ax2.legend()
ax2.grid(True, alpha=0.3)
ax2.set_xticks(YEARS)

plt.tight_layout()
save_figure(fig, 'asr_by_sex.png')
plt.show()
```

\newpage

### Standardized Rates by Age (Sex in Columns)

```{python}
#| label: tbl-asr-sex-columns
#| tbl-cap: "Age-standardized rates with sex as columns (per 100,000)"
#| tbl-cap-location: bottom

asr_sex_cols.style.format({
    'hosp_male': '{:,.0f}',
    'hosp_female': '{:,.0f}',
    'hosp_total': '{:,.0f}',
    'pop_male': '{:,.0f}',
    'pop_female': '{:,.0f}',
    'pop_total': '{:,.0f}',
    'crude_rate_male': '{:.2f}',
    'crude_rate_female': '{:.2f}',
    'crude_rate_total': '{:.2f}',
    'asr_male': '{:.2f}',
    'asr_female': '{:.2f}',
    'asr_total': '{:.2f}'
}).hide(axis="index")
```

```{python}
#| label: fig-asr-sex-columns
#| fig-cap: "Age-standardized rates comparison (2019-2024)"
#| fig-width: 14
#| fig-height: 5

fig, axes = plt.subplots(1, 3, figsize=(14, 5))

ax1 = axes[0]
ax1.plot(asr_sex_cols['year'], asr_sex_cols['asr_male'], marker='o', linewidth=2, 
         markersize=8, label='Male', color='steelblue')
ax1.plot(asr_sex_cols['year'], asr_sex_cols['asr_female'], marker='s', linewidth=2, 
         markersize=8, label='Female', color='coral')
ax1.plot(asr_sex_cols['year'], asr_sex_cols['asr_total'], marker='^', linewidth=2, 
         markersize=8, label='Total', color='forestgreen', linestyle='--')
ax1.set_xlabel('Year')
ax1.set_ylabel('ASR (per 100,000)')
ax1.set_title('Age-Standardized Rate', fontweight='bold')
ax1.legend()
ax1.grid(True, alpha=0.3)
ax1.set_xticks(YEARS)

ax2 = axes[1]
ax2.plot(asr_sex_cols['year'], asr_sex_cols['crude_rate_male'], marker='o', linewidth=2, 
         markersize=8, label='Male', color='steelblue')
ax2.plot(asr_sex_cols['year'], asr_sex_cols['crude_rate_female'], marker='s', linewidth=2, 
         markersize=8, label='Female', color='coral')
ax2.plot(asr_sex_cols['year'], asr_sex_cols['crude_rate_total'], marker='^', linewidth=2, 
         markersize=8, label='Total', color='forestgreen', linestyle='--')
ax2.set_xlabel('Year')
ax2.set_ylabel('Crude Rate (per 100,000)')
ax2.set_title('Crude Rate', fontweight='bold')
ax2.legend()
ax2.grid(True, alpha=0.3)
ax2.set_xticks(YEARS)

ax3 = axes[2]
ax3.plot(asr_sex_cols['year'], asr_sex_cols['hosp_male'], marker='o', linewidth=2, 
         markersize=8, label='Male', color='steelblue')
ax3.plot(asr_sex_cols['year'], asr_sex_cols['hosp_female'], marker='s', linewidth=2, 
         markersize=8, label='Female', color='coral')
ax3.plot(asr_sex_cols['year'], asr_sex_cols['hosp_total'], marker='^', linewidth=2, 
         markersize=8, label='Total', color='forestgreen', linestyle='--')
ax3.set_xlabel('Year')
ax3.set_ylabel('Hospitalizations (N)')
ax3.set_title('Total Hospitalizations', fontweight='bold')
ax3.legend()
ax3.grid(True, alpha=0.3)
ax3.set_xticks(YEARS)

plt.tight_layout()
save_figure(fig, 'asr_sex_columns.png')
plt.show()
```

\newpage

### Standardized Rates by ICD-10 Code

```{python}
#| label: tbl-asr-by-icd
#| tbl-cap: "Age-standardized rates by ICD-10 code - Latest year (per 100,000)"
#| tbl-cap-location: bottom

latest_year = asr_by_icd['year'].max()
asr_latest = asr_by_icd[asr_by_icd['year'] == latest_year].copy()

asr_latest.style.format({
    'hosp_male': '{:,.0f}',
    'hosp_female': '{:,.0f}',
    'hosp_total': '{:,.0f}',
    'asr_male': '{:.2f}',
    'asr_female': '{:.2f}',
    'asr_total': '{:.2f}'
}).hide(axis="index")
```

```{python}
#| label: fig-asr-by-icd-f
#| fig-cap: "ASR trends for F-codes (Dementia)"
#| fig-width: 16
#| fig-height: 8

f_codes = [c for c in F_CODES_LIST if c in asr_by_icd['icd_code'].unique()]
asr_f_codes = asr_by_icd[asr_by_icd['icd_code'].isin(f_codes)]

n_codes = len(f_codes)
ncols = 3
nrows = max(1, (n_codes + ncols - 1) // ncols)

fig, axes = plt.subplots(nrows, ncols, figsize=(16, 4*nrows))
if n_codes > 1:
    axes = axes.flatten()
else:
    axes = [axes]

for idx, code in enumerate(f_codes):
    ax = axes[idx]
    df_code = asr_f_codes[asr_f_codes['icd_code'] == code]
    
    if not df_code.empty:
        ax.plot(df_code['year'], df_code['asr_male'], marker='o', linewidth=2, 
                markersize=6, label='Male', color='steelblue')
        ax.plot(df_code['year'], df_code['asr_female'], marker='s', linewidth=2, 
                markersize=6, label='Female', color='coral')
        ax.plot(df_code['year'], df_code['asr_total'], marker='^', linewidth=2, 
                markersize=6, label='Total', color='forestgreen', linestyle='--')
    
    desc = ALL_NEURODEG_CODES.get(code, code)[:35]
    ax.set_title(f'{code}: {desc}', fontsize=10, fontweight='bold')
    ax.set_xlabel('Year')
    ax.set_ylabel('ASR')
    ax.legend(fontsize=8)
    ax.grid(True, alpha=0.3)
    ax.set_xticks(YEARS)
    ax.tick_params(axis='x', rotation=45)

for idx in range(len(f_codes), len(axes)):
    axes[idx].set_visible(False)

plt.suptitle('Age-Standardized Rates - F-codes (Dementia)', fontsize=14, fontweight='bold')
plt.tight_layout()
save_figure(fig, 'asr_f_codes.png')
plt.show()
```

```{python}
#| label: fig-asr-by-icd-g
#| fig-cap: "ASR trends for G-codes (Neurological)"
#| fig-width: 16
#| fig-height: 8

g_codes = [c for c in G_CODES_LIST if c in asr_by_icd['icd_code'].unique()]
asr_g_codes = asr_by_icd[asr_by_icd['icd_code'].isin(g_codes)]

n_codes = len(g_codes)
ncols = 3
nrows = max(1, (n_codes + ncols - 1) // ncols)

fig, axes = plt.subplots(nrows, ncols, figsize=(16, 4*nrows))
if n_codes > 1:
    axes = axes.flatten()
else:
    axes = [axes]

for idx, code in enumerate(g_codes):
    ax = axes[idx]
    df_code = asr_g_codes[asr_g_codes['icd_code'] == code]
    
    if not df_code.empty:
        ax.plot(df_code['year'], df_code['asr_male'], marker='o', linewidth=2, 
                markersize=6, label='Male', color='steelblue')
        ax.plot(df_code['year'], df_code['asr_female'], marker='s', linewidth=2, 
                markersize=6, label='Female', color='coral')
        ax.plot(df_code['year'], df_code['asr_total'], marker='^', linewidth=2, 
                markersize=6, label='Total', color='forestgreen', linestyle='--')
    
    desc = ALL_NEURODEG_CODES.get(code, code)[:35]
    ax.set_title(f'{code}: {desc}', fontsize=10, fontweight='bold')
    ax.set_xlabel('Year')
    ax.set_ylabel('ASR')
    ax.legend(fontsize=8)
    ax.grid(True, alpha=0.3)
    ax.set_xticks(YEARS)
    ax.tick_params(axis='x', rotation=45)

for idx in range(len(g_codes), len(axes)):
    axes[idx].set_visible(False)

plt.suptitle('Age-Standardized Rates - G-codes (Neurological)', fontsize=14, fontweight='bold')
plt.tight_layout()
save_figure(fig, 'asr_g_codes.png')
plt.show()
```

\newpage

### Summary Table - All ICD Codes by Year

```{python}
#| label: tbl-summary-pivot
#| tbl-cap: "ASR summary by ICD code and year (Total)"
#| tbl-cap-location: bottom

summary_pivot = asr_by_icd.pivot_table(
    index=['icd_code', 'description'],
    columns='year',
    values='asr_total',
    aggfunc='first'
).reset_index()

summary_pivot.columns.name = None
summary_pivot.to_csv(os.path.join(output_path, 'asr_summary_pivot.csv'), index=False)

year_cols = [c for c in summary_pivot.columns if isinstance(c, int) or (isinstance(c, str) and c.isdigit())]
format_dict = {col: '{:.2f}' for col in year_cols}

summary_pivot.style.format(format_dict, na_rep='-').hide(axis="index")
```

```{python}
#| label: fig-heatmap-asr
#| fig-cap: "Heatmap of ASR by ICD code and year"
#| fig-width: 12
#| fig-height: 8

heatmap_data = asr_by_icd.pivot_table(
    index='icd_code',
    columns='year',
    values='asr_total',
    aggfunc='first'
)

fig, ax = plt.subplots(figsize=(12, 8))
sns.heatmap(heatmap_data, annot=True, fmt='.1f', cmap='YlOrRd', 
            cbar_kws={'label': 'ASR (per 100,000)'}, ax=ax)
ax.set_title('Age-Standardized Rates Heatmap', fontweight='bold', fontsize=14)
ax.set_xlabel('Year')
ax.set_ylabel('ICD-10 Code')

plt.tight_layout()
save_figure(fig, 'asr_heatmap.png')
plt.show()
```

```{python}
#| label: fig-total-trend
#| fig-cap: "Overall neurodegenerative disease hospitalization trends"
#| fig-width: 10
#| fig-height: 6

total_by_year = asr_by_icd.groupby('year').agg({
    'hosp_total': 'sum',
    'asr_total': 'mean'
}).reset_index()

fig, ax1 = plt.subplots(figsize=(10, 6))

color1 = 'steelblue'
ax1.set_xlabel('Year')
ax1.set_ylabel('Total Hospitalizations', color=color1)
ax1.bar(total_by_year['year'], total_by_year['hosp_total'], color=color1, alpha=0.7)
ax1.tick_params(axis='y', labelcolor=color1)
ax1.set_xticks(YEARS)

ax2 = ax1.twinx()
color2 = 'darkred'
ax2.set_ylabel('Mean ASR', color=color2)
ax2.plot(total_by_year['year'], total_by_year['asr_total'], color=color2, 
         marker='o', linewidth=3, markersize=10)
ax2.tick_params(axis='y', labelcolor=color2)

plt.title('Neurodegenerative Diseases: Hospitalizations and ASR Trends', fontweight='bold', fontsize=14)
fig.tight_layout()
save_figure(fig, 'total_trend.png')
plt.show()
```

```{python}
#| label: tbl-summary-stats
#| tbl-cap: "Summary statistics of neurodegenerative disease hospitalizations"
#| tbl-cap-location: bottom

total_hosp = hospitalizations['hospitalizations'].sum()
unique_codes = hospitalizations['icd_code'].nunique()
years_covered = hospitalizations['year'].nunique()

summary_stats = pd.DataFrame({
    'Metric': [
        'Total Hospitalizations',
        'Years Covered',
        'ICD Codes Analyzed',
        'Mean Hospitalizations/Year',
        'F-codes (Dementia)',
        'G-codes (Neurological)'
    ],
    'Value': [
        f"{total_hosp:,.0f}",
        f"{years_covered} ({hospitalizations['year'].min()}-{hospitalizations['year'].max()})",
        unique_codes,
        f"{total_hosp/years_covered:,.0f}",
        len([c for c in hospitalizations['icd_code'].unique() if c.startswith('F')]),
        len([c for c in hospitalizations['icd_code'].unique() if c.startswith('G')])
    ]
})

summary_stats.style.hide(axis="index")
```

\newpage

## Regional Analysis

```{python}
#| label: setup-regional
#| include: false

from subprocess import DEVNULL

SERVICIO_TO_REGION = {
    'ARICA': 'Arica y Parinacota',
    'IQUIQUE': 'Tarapacá',
    'ANTOFAGASTA': 'Antofagasta',
    'ATACAMA': 'Atacama',
    'COQUIMBO': 'Coquimbo',
    'VALPARAISO': 'Valparaíso',
    'VIÑA DEL MAR': 'Valparaíso',
    'ACONCAGUA': 'Valparaíso',
    'OHIGGINS': "O'Higgins",
    'MAULE': 'Maule',
    'ÑUBLE': 'Ñuble',
    'CONCEPCION': 'Biobío',
    'TALCAHUANO': 'Biobío',
    'BIOBIO': 'Biobío',
    'ARAUCANIA NORTE': 'La Araucanía',
    'ARAUCANIA SUR': 'La Araucanía',
    'VALDIVIA': 'Los Ríos',
    'OSORNO': 'Los Lagos',
    'RELONCAVI': 'Los Lagos',
    'CHILOE': 'Los Lagos',
    'AYSEN': 'Aysén',
    'MAGALLANES': 'Magallanes',
    'METROPOLITANO NORTE': 'Metropolitana',
    'METROPOLITANO OCCIDENTE': 'Metropolitana',
    'METROPOLITANO CENTRAL': 'Metropolitana',
    'METROPOLITANO ORIENTE': 'Metropolitana',
    'METROPOLITANO SUR': 'Metropolitana',
    'METROPOLITANO SUR ORIENTE': 'Metropolitana'
}
```

```{python}
#| label: load-regional-data
#| include: false

def load_regional_neurodeg_data(years=YEARS, chunksize=100000):
    all_records = []
    
    for year in years:
        pattern = f"GRD_PUBLICO_*{year}*.csv"
        files = glob.glob(os.path.join(data_path, pattern))
        if not files:
            continue
        
        for chunk in pd.read_csv(files[0], delimiter='|', dtype=str, 
                                  low_memory=False, chunksize=chunksize):
            diag_cols = [col for col in chunk.columns if col.startswith('DIAGNOSTICO')]
            if not diag_cols:
                continue
            
            for _, row in chunk.iterrows():
                codes_found = get_neurodeg_codes_from_row(row, diag_cols)
                if not codes_found:
                    continue
                
                age = calculate_age(row.get('FECHA_NACIMIENTO'), row.get('FECHA_INGRESO'))
                age_group = assign_age_group(age)
                
                sex_val = str(row.get('SEXO', '')).strip().upper()
                sex = 'Male' if sex_val in ['1', 'HOMBRE'] else ('Female' if sex_val in ['2', 'MUJER'] else None)
                
                servicio = str(row.get('SERVICIO_SALUD', '')).strip().upper()
                comuna = str(row.get('COMUNA', '')).strip()
                
                region = None
                for key, val in SERVICIO_TO_REGION.items():
                    if key in servicio:
                        region = val
                        break
                
                for code in codes_found:
                    all_records.append({
                        'year': year,
                        'age': age,
                        'age_group': age_group,
                        'sex': sex,
                        'icd_code': code,
                        'servicio_salud': servicio,
                        'region': region,
                        'comuna': comuna
                    })
    
    if not all_records:
        return pd.DataFrame()
    
    return pd.DataFrame(all_records)

regional_data = load_regional_neurodeg_data()
regional_data.to_csv(os.path.join(output_path, 'hospitalizations_regional.csv'), index=False)
regional_data = regional_data[regional_data['region'].notna()].copy()
```

```{python}
#| label: regional-asr-calculation
#| include: false

REGION_NORM_MAP = {
    'METROPOLITANA': 'METROPOLITANA',
    'METROPOLITANA DE SANTIAGO': 'METROPOLITANA',
    "O'HIGGINS": 'OHIGGINS',
    "OHIGGINS": 'OHIGGINS',
    "LIBERTADOR GENERAL BERNARDO O'HIGGINS": 'OHIGGINS',
    "LIBERTADOR GENERAL BERNARDO OHIGGINS": 'OHIGGINS',
    'AYSEN': 'AYSEN',
    'AYSEN DEL GENERAL CARLOS IBANEZ DEL CAMPO': 'AYSEN',
    'MAGALLANES': 'MAGALLANES',
    'MAGALLANES Y DE LA ANTARTICA CHILENA': 'MAGALLANES',
    'MAGALLANES Y ANTARTICA CHILENA': 'MAGALLANES',
    'ARICA Y PARINACOTA': 'ARICA Y PARINACOTA',
    'TARAPACA': 'TARAPACA',
    'ANTOFAGASTA': 'ANTOFAGASTA',
    'ATACAMA': 'ATACAMA',
    'COQUIMBO': 'COQUIMBO',
    'VALPARAISO': 'VALPARAISO',
    'MAULE': 'MAULE',
    'NUBLE': 'NUBLE',
    'BIOBIO': 'BIOBIO',
    'LA ARAUCANIA': 'LA ARAUCANIA',
    'LOS RIOS': 'LOS RIOS',
    'LOS LAGOS': 'LOS LAGOS'
}

def _normalize_region_basic(x):
    if pd.isna(x):
        return None
    s = str(x).upper().strip()
    replacements = {'Á': 'A', 'É': 'E', 'Í': 'I', 'Ó': 'O', 'Ú': 'U', 'Ñ': 'N'}
    for old, new in replacements.items():
        s = s.replace(old, new)
    s = s.replace('\u2019', "'")
    return REGION_NORM_MAP.get(s, s)


def calculate_regional_asr(regional_df, population_df, per=100000):
    who_weights = pd.DataFrame([
        {'age_group': k, 'who_weight': v} for k, v in WHO_STANDARD_POPULATION.items()
    ])
    
    hosp_agg = regional_df.groupby(['region', 'year', 'age_group', 'sex']).size().reset_index(name='hospitalizations')

    if population_df is not None and 'region' in population_df.columns:
        pop_agg = population_df.groupby(['region', 'year', 'age_group', 'sex'])['population'].sum().reset_index()
        hosp_agg['region_norm'] = hosp_agg['region'].apply(_normalize_region_basic)
        pop_agg['region_norm'] = pop_agg['region'].apply(_normalize_region_basic)
        merged = hosp_agg.merge(
            pop_agg[['region_norm', 'year', 'age_group', 'sex', 'population']],
            on=['region_norm', 'year', 'age_group', 'sex'],
            how='left'
        )
    else:
        pop_agg = population_df.groupby(['year', 'age_group', 'sex'])['population'].sum().reset_index()
        merged = hosp_agg.merge(pop_agg, on=['year', 'age_group', 'sex'], how='left')

    merged = merged.dropna(subset=['population'])
    merged = merged[merged['population'] > 0]
    merged['age_specific_rate'] = (merged['hospitalizations'] / merged['population']) * per
    merged = merged.merge(who_weights, on='age_group', how='left')
    merged['weighted_rate'] = merged['age_specific_rate'] * merged['who_weight']
    
    result = merged.groupby(['region', 'year']).agg({
        'hospitalizations': 'sum',
        'weighted_rate': 'sum'
    }).reset_index()
    
    result['asr'] = (result['weighted_rate'] / TOTAL_WHO_WEIGHT).round(2)
    
    return result[['region', 'year', 'hospitalizations', 'asr']]


def calculate_regional_icd_asr(regional_df, population_df, per=100000):
    who_weights = pd.DataFrame([
        {'age_group': k, 'who_weight': v} for k, v in WHO_STANDARD_POPULATION.items()
    ])
    
    hosp_agg = regional_df.groupby(['region', 'icd_code', 'year', 'age_group', 'sex']).size().reset_index(name='hospitalizations')
    
    if population_df is not None and 'region' in population_df.columns:
        pop_agg = population_df.groupby(['region', 'year', 'age_group', 'sex'])['population'].sum().reset_index()
        hosp_agg['region_norm'] = hosp_agg['region'].apply(_normalize_region_basic)
        pop_agg['region_norm'] = pop_agg['region'].apply(_normalize_region_basic)
        merged = hosp_agg.merge(
            pop_agg[['region_norm', 'year', 'age_group', 'sex', 'population']],
            on=['region_norm', 'year', 'age_group', 'sex'],
            how='left'
        )
    else:
        pop_agg = population_df.groupby(['year', 'age_group', 'sex'])['population'].sum().reset_index()
        merged = hosp_agg.merge(pop_agg, on=['year', 'age_group', 'sex'], how='left')
    
    merged = merged.dropna(subset=['population'])
    merged = merged[merged['population'] > 0]
    merged['age_specific_rate'] = (merged['hospitalizations'] / merged['population']) * per
    merged = merged.merge(who_weights, on='age_group', how='left')
    merged['weighted_rate'] = merged['age_specific_rate'] * merged['who_weight']
    
    result = merged.groupby(['region', 'icd_code']).agg({
        'hospitalizations': 'sum',
        'weighted_rate': 'sum'
    }).reset_index()
    
    result['asr'] = (result['weighted_rate'] / TOTAL_WHO_WEIGHT).round(2)
    result['description'] = result['icd_code'].map(ALL_NEURODEG_CODES)
    
    return result[['region', 'icd_code', 'description', 'hospitalizations', 'asr']]


regional_asr = calculate_regional_asr(regional_data, population_regional if population_regional is not None else population)
regional_icd_asr = calculate_regional_icd_asr(regional_data, population_regional if population_regional is not None else population)

total_by_region = regional_data.groupby('region').size().reset_index(name='total_hospitalizations')
total_by_region = total_by_region.sort_values('total_hospitalizations', ascending=False)

mean_asr_region = regional_asr.groupby('region')['asr'].mean().reset_index()
mean_asr_region.columns = ['region', 'mean_asr']
mean_asr_region = mean_asr_region.sort_values('mean_asr', ascending=False)

main_disease_region = regional_icd_asr.loc[
    regional_icd_asr.groupby('region')['hospitalizations'].idxmax()
][['region', 'icd_code', 'description', 'hospitalizations', 'asr']]
```

### Age-Standardized Rates by Region

```{python}
#| label: tbl-regional-asr
#| tbl-cap: "Age-standardized hospitalization rates by region (per 100,000)"
#| tbl-cap-location: bottom

regional_asr_pivot = regional_asr.pivot_table(
    index='region',
    columns='year',
    values='asr',
    aggfunc='first'
).reset_index()

regional_asr_pivot['Mean ASR'] = regional_asr_pivot[[c for c in regional_asr_pivot.columns if c != 'region']].mean(axis=1).round(2)
regional_asr_pivot = regional_asr_pivot.sort_values('Mean ASR', ascending=False)

year_cols = [c for c in regional_asr_pivot.columns if isinstance(c, (int, float)) and c != 'Mean ASR']
format_dict = {col: '{:.2f}' for col in year_cols + ['Mean ASR']}

regional_asr_pivot.style.format(format_dict, na_rep='-').background_gradient(
    cmap='YlOrRd', subset=['Mean ASR']
).hide(axis="index")
```

```{python}
#| label: fig-regional-asr-trend
#| fig-cap: "Age-standardized rates trend by region (2019-2024)"
#| fig-width: 16
#| fig-height: 8

fig, axes = plt.subplots(1, 2, figsize=(16, 8))

all_regions = mean_asr_region['region'].tolist()

ax1 = axes[0]
for region in all_regions:
    df_reg = regional_asr[regional_asr['region'] == region]
    ax1.plot(df_reg['year'], df_reg['asr'], marker='o', linewidth=2, markersize=5, label=region)

ax1.set_xlabel('Year')
ax1.set_ylabel('ASR (per 100,000)')
ax1.set_title('ASR Trend - All Regions', fontweight='bold')
ax1.legend(bbox_to_anchor=(1.02, 1), loc='upper left', fontsize=8)
ax1.grid(True, alpha=0.3)
ax1.set_xticks(YEARS)

ax2 = axes[1]
data_sorted = mean_asr_region.sort_values('mean_asr', ascending=True)
colors = plt.cm.YlOrRd(data_sorted['mean_asr'] / data_sorted['mean_asr'].max())
ax2.barh(data_sorted['region'], data_sorted['mean_asr'], color=colors)
ax2.set_xlabel('Mean ASR (per 100,000)')
ax2.set_title('Mean ASR by Region (2019-2024)', fontweight='bold')
ax2.grid(True, alpha=0.3, axis='x')

plt.tight_layout()
save_figure(fig, 'regional_asr_trends.png')
plt.show()
```

```{python}
#| label: tbl-regional-summary-complete
#| tbl-cap: "Complete regional summary with ASR and top disease"
#| tbl-cap-location: bottom

regional_complete = total_by_region.merge(mean_asr_region, on='region', how='left')
regional_complete = regional_complete.merge(
    main_disease_region[['region', 'icd_code', 'description']], 
    on='region', 
    how='left'
)
regional_complete.columns = ['Region', 'Total Hosp.', 'Mean ASR', 'Main ICD', 'Main Disease']
regional_complete = regional_complete.sort_values('Mean ASR', ascending=False)

regional_complete.style.format({
    'Total Hosp.': '{:,.0f}',
    'Mean ASR': '{:.2f}'
}).hide(axis="index")
```

\newpage

## Metropolitan Region Analysis

```{python}
#| label: filter-rm-data
#| include: false

rm_comunas_pop = population_detail[population_detail['region'] == 'Metropolitana']['comuna'].unique().tolist()

def normalize_comuna(x):
    if pd.isna(x):
        return None
    s = str(x).upper().strip()
    replacements = {'Á': 'A', 'É': 'E', 'Í': 'I', 'Ó': 'O', 'Ú': 'U', 'Ñ': 'N'}
    for old, new in replacements.items():
        s = s.replace(old, new)
    return s

rm_comunas_norm = set(normalize_comuna(c) for c in rm_comunas_pop if pd.notna(c))

regional_data['comuna_norm'] = regional_data['comuna'].apply(normalize_comuna)
rm_data = regional_data[regional_data['comuna_norm'].isin(rm_comunas_norm)].copy()

total_by_comuna = rm_data.groupby('comuna').size().reset_index(name='total_hospitalizations')
total_by_comuna = total_by_comuna.sort_values('total_hospitalizations', ascending=False)

comuna_counts = rm_data.groupby(['year', 'comuna']).size().reset_index(name='hospitalizations')

pop_rm = population_detail[population_detail['region'] == 'Metropolitana'].copy()
pop_rm['comuna_norm'] = pop_rm['comuna'].apply(normalize_comuna)

def calculate_comuna_asr(df, pop_df, per=100000):
    who_weights = pd.DataFrame([
        {'age_group': k, 'who_weight': v} for k, v in WHO_STANDARD_POPULATION.items()
    ])
    
    df = df.copy()
    df['comuna_norm'] = df['comuna'].apply(normalize_comuna)
    hosp_agg = df.groupby(['comuna_norm', 'year', 'age_group', 'sex']).size().reset_index(name='hospitalizations')
    pop_agg = pop_df.groupby(['comuna_norm', 'year', 'age_group', 'sex'])['population'].sum().reset_index()
    
    merged = hosp_agg.merge(pop_agg, on=['comuna_norm', 'year', 'age_group', 'sex'], how='left')
    merged = merged.dropna(subset=['population'])
    merged = merged[merged['population'] > 0]
    merged['age_specific_rate'] = (merged['hospitalizations'] / merged['population']) * per
    merged = merged.merge(who_weights, on='age_group', how='left')
    merged['weighted_rate'] = merged['age_specific_rate'] * merged['who_weight']
    
    result = merged.groupby('comuna_norm').agg({
        'hospitalizations': 'sum',
        'weighted_rate': 'sum'
    }).reset_index()
    
    result['asr'] = (result['weighted_rate'] / TOTAL_WHO_WEIGHT).round(2)
    
    comuna_map = df.drop_duplicates('comuna_norm')[['comuna', 'comuna_norm']]
    result = result.merge(comuna_map, on='comuna_norm', how='left')
    
    return result[['comuna', 'hospitalizations', 'asr']]


def calculate_comuna_icd_asr(df, pop_df, per=100000):
    who_weights = pd.DataFrame([
        {'age_group': k, 'who_weight': v} for k, v in WHO_STANDARD_POPULATION.items()
    ])
    
    df = df.copy()
    df['comuna_norm'] = df['comuna'].apply(normalize_comuna)
    hosp_agg = df.groupby(['comuna_norm', 'icd_code', 'year', 'age_group', 'sex']).size().reset_index(name='hospitalizations')
    pop_agg = pop_df.groupby(['comuna_norm', 'year', 'age_group', 'sex'])['population'].sum().reset_index()
    
    merged = hosp_agg.merge(pop_agg, on=['comuna_norm', 'year', 'age_group', 'sex'], how='left')
    merged = merged.dropna(subset=['population'])
    merged = merged[merged['population'] > 0]
    merged['age_specific_rate'] = (merged['hospitalizations'] / merged['population']) * per
    merged = merged.merge(who_weights, on='age_group', how='left')
    merged['weighted_rate'] = merged['age_specific_rate'] * merged['who_weight']
    
    result = merged.groupby(['comuna_norm', 'icd_code']).agg({
        'hospitalizations': 'sum',
        'weighted_rate': 'sum'
    }).reset_index()
    
    result['asr'] = (result['weighted_rate'] / TOTAL_WHO_WEIGHT).round(2)
    result['description'] = result['icd_code'].map(ALL_NEURODEG_CODES)
    
    comuna_map = df.drop_duplicates('comuna_norm')[['comuna', 'comuna_norm']]
    result = result.merge(comuna_map, on='comuna_norm', how='left')
    
    return result[['comuna', 'icd_code', 'description', 'hospitalizations', 'asr']]


comuna_asr = calculate_comuna_asr(rm_data, pop_rm)
comuna_icd_asr = calculate_comuna_icd_asr(rm_data, pop_rm)

main_disease_comuna = comuna_icd_asr.loc[
    comuna_icd_asr.groupby('comuna')['hospitalizations'].idxmax()
][['comuna', 'icd_code', 'description', 'hospitalizations', 'asr']]

mean_asr_comuna = comuna_asr.sort_values('asr', ascending=False)
```

### Hospitalizations by Comuna - Metropolitan Region

```{python}
#| label: tbl-rm-summary
#| tbl-cap: "All comunas with ASR - Metropolitan Region"
#| tbl-cap-location: bottom

rm_summary = total_by_comuna.merge(
    mean_asr_comuna[['comuna', 'asr']], 
    on='comuna', 
    how='left'
).merge(
    main_disease_comuna[['comuna', 'icd_code', 'description']], 
    on='comuna', 
    how='left'
)
rm_summary.columns = ['Comuna', 'Total Hosp.', 'ASR', 'Main ICD', 'Main Disease']
rm_summary = rm_summary.sort_values('ASR', ascending=False)

rm_summary.style.format({
    'Total Hosp.': '{:,.0f}',
    'ASR': '{:.2f}'
}, na_rep='-').hide(axis="index")
```

```{python}
#| label: fig-rm-bars
#| fig-cap: "Metropolitan Region hospitalizations by comuna"
#| fig-width: 16
#| fig-height: 14

fig, axes = plt.subplots(1, 2, figsize=(16, 14))

ax1 = axes[0]
data_sorted = total_by_comuna.sort_values('total_hospitalizations', ascending=True)
colors = plt.cm.Blues(np.linspace(0.3, 0.9, len(data_sorted)))
ax1.barh(data_sorted['comuna'], data_sorted['total_hospitalizations'], color=colors)
ax1.set_xlabel('Total Hospitalizations')
ax1.set_title('All Comunas - Metropolitan Region', fontweight='bold')
ax1.grid(True, alpha=0.3, axis='x')

ax2 = axes[1]
all_comunas = total_by_comuna['comuna'].tolist()
for comuna in all_comunas:
    df_com = comuna_counts[comuna_counts['comuna'] == comuna]
    if not df_com.empty:
        ax2.plot(df_com['year'], df_com['hospitalizations'], marker='o', linewidth=1.5, 
                 markersize=4, label=comuna, alpha=0.7)

ax2.set_xlabel('Year')
ax2.set_ylabel('Hospitalizations')
ax2.set_title('Annual Trend - All Comunas', fontweight='bold')
ax2.legend(bbox_to_anchor=(1.02, 1), loc='upper left', fontsize=6, ncol=2)
ax2.grid(True, alpha=0.3)
ax2.set_xticks(YEARS)

plt.tight_layout()
save_figure(fig, 'rm_hospitalizations.png')
plt.show()
```

### Most Prevalent Disease by Comuna

```{python}
#| label: tbl-top-disease-comuna
#| tbl-cap: "Most prevalent disease by comuna - All comunas with ASR"
#| tbl-cap-location: bottom

main_disease_display = main_disease_comuna.merge(total_by_comuna, on='comuna')
main_disease_display = main_disease_display.merge(mean_asr_comuna[['comuna', 'asr']], on='comuna', how='left', suffixes=('_icd', '_total'))
main_disease_display = main_disease_display.sort_values('asr_total', ascending=False)
main_disease_display = main_disease_display[['comuna', 'total_hospitalizations', 'asr_total', 'icd_code', 'description', 'asr_icd']]
main_disease_display.columns = ['Comuna', 'Total Hosp.', 'Mean ASR', 'Main ICD', 'Disease', 'ICD ASR']

main_disease_display.style.format({
    'Total Hosp.': '{:,.0f}',
    'Mean ASR': '{:.2f}',
    'ICD ASR': '{:.2f}'
}, na_rep='-').hide(axis="index")
```

```{python}
#| label: fig-disease-by-comuna
#| fig-cap: "Disease ASR distribution by comuna - All comunas"
#| fig-width: 18
#| fig-height: 16

all_icd_rm = rm_data['icd_code'].unique().tolist()
all_comunas_rm = total_by_comuna['comuna'].tolist()

heatmap_data = comuna_icd_asr.pivot_table(
    index='comuna',
    columns='icd_code',
    values='asr',
    aggfunc='first'
).fillna(0)

order = [c for c in all_comunas_rm if c in heatmap_data.index]
heatmap_data = heatmap_data.loc[order]

fig, axes = plt.subplots(1, 2, figsize=(18, 16))

ax1 = axes[0]
sns.heatmap(heatmap_data, annot=True, fmt='.1f', cmap='YlOrRd', 
            cbar_kws={'label': 'ASR (per 100,000)'}, ax=ax1, annot_kws={'size': 6})
ax1.set_title('Disease ASR by Comuna - All ICD Codes', fontweight='bold')
ax1.set_xlabel('ICD-10 Code')
ax1.set_ylabel('Comuna')

ax2 = axes[1]
heatmap_data.plot(kind='barh', stacked=True, ax=ax2, colormap='Set2')
ax2.set_xlabel('Cumulative ASR (per 100,000)')
ax2.set_title('Disease Composition by Comuna (ASR)', fontweight='bold')
ax2.legend(title='ICD Code', bbox_to_anchor=(1.02, 1), loc='upper left', fontsize=7)
ax2.grid(True, alpha=0.3, axis='x')

plt.tight_layout()
save_figure(fig, 'disease_by_comuna.png')
plt.show()
```

```{python}
#| label: tbl-rm-stats
#| tbl-cap: "Metropolitan Region Summary Statistics"
#| tbl-cap-location: bottom

main_icd_rm = rm_data['icd_code'].value_counts().idxmax() if len(rm_data) > 0 else 'N/A'
main_icd_desc = ALL_NEURODEG_CODES.get(main_icd_rm, 'N/A')

rm_stats = pd.DataFrame({
    'Metric': [
        'Total Hospitalizations',
        'Comunas Analyzed',
        'Years Covered',
        'Mean Hospitalizations/Year',
        'Comuna with Most Cases',
        'Most Common Diagnosis',
        'ICD Codes Present'
    ],
    'Value': [
        f"{len(rm_data):,.0f}",
        rm_data['comuna'].nunique(),
        f"{rm_data['year'].nunique()} ({rm_data['year'].min()}-{rm_data['year'].max()})",
        f"{len(rm_data) / rm_data['year'].nunique():,.0f}",
        total_by_comuna.iloc[0]['comuna'] if len(total_by_comuna) > 0 else 'N/A',
        f"{main_icd_rm} ({main_icd_desc})",
        rm_data['icd_code'].nunique()
    ]
})

rm_stats.style.hide(axis="index")
```

\newpage

## Separate Analysis: F-codes (Dementia) vs G-codes (Neurological)

```{python}
#| label: separate-fg-data
#| include: false

F_CODES = [c for c in F_CODES_LIST if not c.startswith('F06')]
F_CODES.append('F06.7')
G_CODES = G_CODES_LIST

hosp_f = hospitalizations[hospitalizations['icd_code'].isin(F_CODES_LIST)].copy()
hosp_g = hospitalizations[hospitalizations['icd_code'].isin(G_CODES_LIST)].copy()

regional_f = regional_data[regional_data['icd_code'].isin(F_CODES_LIST)].copy()
regional_g = regional_data[regional_data['icd_code'].isin(G_CODES_LIST)].copy()

asr_f = calculate_asr_sex_columns(hosp_f, population)
asr_g = calculate_asr_sex_columns(hosp_g, population)

regional_asr_f = calculate_regional_asr(regional_f, population_regional if population_regional is not None else population)
regional_asr_g = calculate_regional_asr(regional_g, population_regional if population_regional is not None else population)

mean_asr_f = regional_asr_f.groupby('region')['asr'].mean().reset_index()
mean_asr_f.columns = ['region', 'mean_asr_f']

mean_asr_g = regional_asr_g.groupby('region')['asr'].mean().reset_index()
mean_asr_g.columns = ['region', 'mean_asr_g']
```

### F-codes: Dementia and Mental Disorders

```{python}
#| label: tbl-f-codes-list
#| tbl-cap: "F-codes included in analysis"
#| tbl-cap-location: bottom

f_codes_df = pd.DataFrame([
    {'ICD Code': k, 'Description': v} for k, v in NEURODEG_CODES_F.items()
])
f_codes_df.style.hide(axis="index")
```

```{python}
#| label: tbl-asr-f-national
#| tbl-cap: "Age-standardized rates - F-codes (Dementia) - National"
#| tbl-cap-location: bottom

asr_f.style.format({
    'hosp_male': '{:,.0f}', 'hosp_female': '{:,.0f}', 'hosp_total': '{:,.0f}',
    'pop_male': '{:,.0f}', 'pop_female': '{:,.0f}', 'pop_total': '{:,.0f}',
    'crude_rate_male': '{:.2f}', 'crude_rate_female': '{:.2f}', 'crude_rate_total': '{:.2f}',
    'asr_male': '{:.2f}', 'asr_female': '{:.2f}', 'asr_total': '{:.2f}'
}).hide(axis="index")
```

```{python}
#| label: tbl-asr-f-regional
#| tbl-cap: "Mean ASR by region - F-codes (Dementia)"
#| tbl-cap-location: bottom

regional_asr_f_pivot = regional_asr_f.pivot_table(
    index='region', columns='year', values='asr', aggfunc='first'
).reset_index()
regional_asr_f_pivot['Mean ASR'] = regional_asr_f_pivot[[c for c in regional_asr_f_pivot.columns if c != 'region']].mean(axis=1).round(2)
regional_asr_f_pivot = regional_asr_f_pivot.sort_values('Mean ASR', ascending=False)

year_cols = [c for c in regional_asr_f_pivot.columns if isinstance(c, (int, float)) and c != 'Mean ASR']
format_dict = {col: '{:.2f}' for col in year_cols + ['Mean ASR']}
regional_asr_f_pivot.style.format(format_dict, na_rep='-').background_gradient(
    cmap='Blues', subset=['Mean ASR']
).hide(axis="index")
```

```{python}
#| label: fig-asr-f-trend
#| fig-cap: "ASR trend - F-codes (Dementia) by sex"
#| fig-width: 12
#| fig-height: 5

fig, axes = plt.subplots(1, 2, figsize=(12, 5))

ax1 = axes[0]
ax1.plot(asr_f['year'], asr_f['asr_male'], marker='o', linewidth=2, label='Male', color='steelblue')
ax1.plot(asr_f['year'], asr_f['asr_female'], marker='s', linewidth=2, label='Female', color='coral')
ax1.plot(asr_f['year'], asr_f['asr_total'], marker='^', linewidth=2, label='Total', color='forestgreen', linestyle='--')
ax1.set_xlabel('Year')
ax1.set_ylabel('ASR (per 100,000)')
ax1.set_title('F-codes (Dementia) - ASR by Sex', fontweight='bold')
ax1.legend()
ax1.grid(True, alpha=0.3)
ax1.set_xticks(YEARS)

ax2 = axes[1]
all_regions_f = mean_asr_f['region'].tolist()
for region in all_regions_f:
    df_reg = regional_asr_f[regional_asr_f['region'] == region]
    ax2.plot(df_reg['year'], df_reg['asr'], marker='o', linewidth=1.5, markersize=4, label=region)
ax2.set_xlabel('Year')
ax2.set_ylabel('ASR (per 100,000)')
ax2.set_title('F-codes - All Regions', fontweight='bold')
ax2.legend(bbox_to_anchor=(1.02, 1), loc='upper left', fontsize=7)
ax2.grid(True, alpha=0.3)
ax2.set_xticks(YEARS)

plt.tight_layout()
save_figure(fig, 'asr_f_codes_trend.png')
plt.show()
```

\newpage

### G-codes: Neurological Disorders

```{python}
#| label: tbl-g-codes-list
#| tbl-cap: "G-codes included in analysis"
#| tbl-cap-location: bottom

g_codes_df = pd.DataFrame([
    {'ICD Code': k, 'Description': v} for k, v in NEURODEG_CODES_G.items()
])
g_codes_df.style.hide(axis="index")
```

```{python}
#| label: tbl-asr-g-national
#| tbl-cap: "Age-standardized rates - G-codes (Neurological) - National"
#| tbl-cap-location: bottom

asr_g.style.format({
    'hosp_male': '{:,.0f}', 'hosp_female': '{:,.0f}', 'hosp_total': '{:,.0f}',
    'pop_male': '{:,.0f}', 'pop_female': '{:,.0f}', 'pop_total': '{:,.0f}',
    'crude_rate_male': '{:.2f}', 'crude_rate_female': '{:.2f}', 'crude_rate_total': '{:.2f}',
    'asr_male': '{:.2f}', 'asr_female': '{:.2f}', 'asr_total': '{:.2f}'
}).hide(axis="index")
```

```{python}
#| label: tbl-asr-g-regional
#| tbl-cap: "Mean ASR by region - G-codes (Neurological)"
#| tbl-cap-location: bottom

regional_asr_g_pivot = regional_asr_g.pivot_table(
    index='region', columns='year', values='asr', aggfunc='first'
).reset_index()
regional_asr_g_pivot['Mean ASR'] = regional_asr_g_pivot[[c for c in regional_asr_g_pivot.columns if c != 'region']].mean(axis=1).round(2)
regional_asr_g_pivot = regional_asr_g_pivot.sort_values('Mean ASR', ascending=False)

year_cols = [c for c in regional_asr_g_pivot.columns if isinstance(c, (int, float)) and c != 'Mean ASR']
format_dict = {col: '{:.2f}' for col in year_cols + ['Mean ASR']}
regional_asr_g_pivot.style.format(format_dict, na_rep='-').background_gradient(
    cmap='Greens', subset=['Mean ASR']
).hide(axis="index")
```

```{python}
#| label: fig-asr-g-trend
#| fig-cap: "ASR trend - G-codes (Neurological) by sex"
#| fig-width: 14
#| fig-height: 6

fig, axes = plt.subplots(1, 2, figsize=(14, 6))

ax1 = axes[0]
ax1.plot(asr_g['year'], asr_g['asr_male'], marker='o', linewidth=2, label='Male', color='steelblue')
ax1.plot(asr_g['year'], asr_g['asr_female'], marker='s', linewidth=2, label='Female', color='coral')
ax1.plot(asr_g['year'], asr_g['asr_total'], marker='^', linewidth=2, label='Total', color='forestgreen', linestyle='--')
ax1.set_xlabel('Year')
ax1.set_ylabel('ASR (per 100,000)')
ax1.set_title('G-codes (Neurological) - ASR by Sex', fontweight='bold')
ax1.legend()
ax1.grid(True, alpha=0.3)
ax1.set_xticks(YEARS)

ax2 = axes[1]
all_regions_g = mean_asr_g['region'].tolist()
for region in all_regions_g:
    df_reg = regional_asr_g[regional_asr_g['region'] == region]
    ax2.plot(df_reg['year'], df_reg['asr'], marker='o', linewidth=1.5, markersize=4, label=region)
ax2.set_xlabel('Year')
ax2.set_ylabel('ASR (per 100,000)')
ax2.set_title('G-codes - All Regions', fontweight='bold')
ax2.legend(bbox_to_anchor=(1.02, 1), loc='upper left', fontsize=7)
ax2.grid(True, alpha=0.3)
ax2.set_xticks(YEARS)

plt.tight_layout()
save_figure(fig, 'asr_g_codes_trend.png')
plt.show()
```

\newpage

### F vs G Comparison

```{python}
#| label: fig-fg-comparison
#| fig-cap: "Comparison of F-codes (Dementia) vs G-codes (Neurological)"
#| fig-width: 14
#| fig-height: 10

fig, axes = plt.subplots(2, 2, figsize=(14, 10))

ax1 = axes[0, 0]
ax1.plot(asr_f['year'], asr_f['asr_total'], marker='o', linewidth=2, label='F-codes (Dementia)', color='royalblue')
ax1.plot(asr_g['year'], asr_g['asr_total'], marker='s', linewidth=2, label='G-codes (Neurological)', color='seagreen')
ax1.set_xlabel('Year')
ax1.set_ylabel('ASR (per 100,000)')
ax1.set_title('National ASR: F vs G codes', fontweight='bold')
ax1.legend()
ax1.grid(True, alpha=0.3)
ax1.set_xticks(YEARS)

ax2 = axes[0, 1]
comparison = mean_asr_f.merge(mean_asr_g, on='region', how='outer')
comparison = comparison.sort_values('mean_asr_f', ascending=True)
y_pos = range(len(comparison))
ax2.barh([y - 0.2 for y in y_pos], comparison['mean_asr_f'], height=0.4, label='F-codes', color='royalblue')
ax2.barh([y + 0.2 for y in y_pos], comparison['mean_asr_g'], height=0.4, label='G-codes', color='seagreen')
ax2.set_yticks(y_pos)
ax2.set_yticklabels(comparison['region'])
ax2.set_xlabel('Mean ASR (per 100,000)')
ax2.set_title('Regional Comparison: F vs G', fontweight='bold')
ax2.legend()
ax2.grid(True, alpha=0.3, axis='x')

ax3 = axes[1, 0]
heatmap_f = regional_asr_f.pivot_table(index='region', columns='year', values='asr', aggfunc='first').fillna(0)
heatmap_f = heatmap_f.reindex(mean_asr_f.sort_values('mean_asr_f', ascending=False)['region'])
sns.heatmap(heatmap_f, annot=True, fmt='.1f', cmap='Blues', ax=ax3, cbar_kws={'label': 'ASR'})
ax3.set_title('F-codes ASR by Region and Year', fontweight='bold')
ax3.set_xlabel('Year')
ax3.set_ylabel('Region')

ax4 = axes[1, 1]
heatmap_g = regional_asr_g.pivot_table(index='region', columns='year', values='asr', aggfunc='first').fillna(0)
heatmap_g = heatmap_g.reindex(mean_asr_g.sort_values('mean_asr_g', ascending=False)['region'])
sns.heatmap(heatmap_g, annot=True, fmt='.1f', cmap='Greens', ax=ax4, cbar_kws={'label': 'ASR'})
ax4.set_title('G-codes ASR by Region and Year', fontweight='bold')
ax4.set_xlabel('Year')
ax4.set_ylabel('Region')

plt.tight_layout()
save_figure(fig, 'fg_comparison.png')
plt.show()
```

```{python}
#| label: tbl-fg-summary
#| tbl-cap: "Summary comparison F-codes vs G-codes"
#| tbl-cap-location: bottom

total_f = hosp_f['hospitalizations'].sum()
total_g = hosp_g['hospitalizations'].sum()

summary_fg = pd.DataFrame({
    'Category': ['F-codes (Dementia)', 'G-codes (Neurological)'],
    'Total Hospitalizations': [total_f, total_g],
    'Mean Annual ASR (Total)': [asr_f['asr_total'].mean().round(2), asr_g['asr_total'].mean().round(2)],
    'Mean Annual ASR (Male)': [asr_f['asr_male'].mean().round(2), asr_g['asr_male'].mean().round(2)],
    'Mean Annual ASR (Female)': [asr_f['asr_female'].mean().round(2), asr_g['asr_female'].mean().round(2)],
    'Regions with data': [regional_asr_f['region'].nunique(), regional_asr_g['region'].nunique()]
})

summary_fg.style.format({
    'Total Hospitalizations': '{:,.0f}',
    'Mean Annual ASR (Total)': '{:.2f}',
    'Mean Annual ASR (Male)': '{:.2f}',
    'Mean Annual ASR (Female)': '{:.2f}'
}).hide(axis="index")
```

### F vs G - Metropolitan Region Comunas

```{python}
#| label: fg-rm-data
#| include: false

rm_f = rm_data[rm_data['icd_code'].isin(F_CODES_LIST)].copy()
rm_g = rm_data[rm_data['icd_code'].isin(G_CODES_LIST)].copy()

def calculate_comuna_asr_subset(df, pop_df, per=100000):
    who_weights = pd.DataFrame([
        {'age_group': k, 'who_weight': v} for k, v in WHO_STANDARD_POPULATION.items()
    ])
    
    if len(df) == 0:
        return pd.DataFrame(columns=['comuna', 'hospitalizations', 'asr'])
    
    df = df.copy()
    df['comuna_norm'] = df['comuna'].apply(normalize_comuna)
    hosp_agg = df.groupby(['comuna_norm', 'year', 'age_group', 'sex']).size().reset_index(name='hospitalizations')
    pop_agg = pop_df.groupby(['comuna_norm', 'year', 'age_group', 'sex'])['population'].sum().reset_index()
    
    merged = hosp_agg.merge(pop_agg, on=['comuna_norm', 'year', 'age_group', 'sex'], how='left')
    merged = merged.dropna(subset=['population'])
    merged = merged[merged['population'] > 0]
    
    if len(merged) == 0:
        return pd.DataFrame(columns=['comuna', 'hospitalizations', 'asr'])
    
    merged['age_specific_rate'] = (merged['hospitalizations'] / merged['population']) * per
    merged = merged.merge(who_weights, on='age_group', how='left')
    merged['weighted_rate'] = merged['age_specific_rate'] * merged['who_weight']
    
    result = merged.groupby('comuna_norm').agg({
        'hospitalizations': 'sum',
        'weighted_rate': 'sum'
    }).reset_index()
    
    result['asr'] = (result['weighted_rate'] / TOTAL_WHO_WEIGHT).round(2)
    
    comuna_map = df.drop_duplicates('comuna_norm')[['comuna', 'comuna_norm']]
    result = result.merge(comuna_map, on='comuna_norm', how='left')
    
    return result[['comuna', 'hospitalizations', 'asr']]

comuna_asr_f = calculate_comuna_asr_subset(rm_f, pop_rm).sort_values('asr', ascending=False)
comuna_asr_g = calculate_comuna_asr_subset(rm_g, pop_rm).sort_values('asr', ascending=False)
```

```{python}
#| label: tbl-rm-f-comunas
#| tbl-cap: "F-codes (Dementia) ASR by Comuna - Metropolitan Region"
#| tbl-cap-location: bottom

display_f = comuna_asr_f.copy()
display_f.columns = ['Comuna', 'Hospitalizations', 'ASR']
display_f.style.format({'Hospitalizations': '{:,.0f}', 'ASR': '{:.2f}'}, na_rep='-').hide(axis="index")
```

```{python}
#| label: tbl-rm-g-comunas
#| tbl-cap: "G-codes (Neurological) ASR by Comuna - Metropolitan Region"
#| tbl-cap-location: bottom

display_g = comuna_asr_g.copy()
display_g.columns = ['Comuna', 'Hospitalizations', 'ASR']
display_g.style.format({'Hospitalizations': '{:,.0f}', 'ASR': '{:.2f}'}, na_rep='-').hide(axis="index")
```

```{python}
#| label: fig-fg-rm-comparison
#| fig-cap: "F vs G codes comparison - Metropolitan Region Comunas"
#| fig-width: 16
#| fig-height: 14

fig, axes = plt.subplots(1, 2, figsize=(16, 14))

ax1 = axes[0]
if len(comuna_asr_f) > 0:
    all_f = comuna_asr_f.sort_values('asr', ascending=True)
    colors_f = plt.cm.Blues(np.linspace(0.3, 0.9, len(all_f)))
    ax1.barh(all_f['comuna'], all_f['asr'], color=colors_f)
    ax1.set_xlabel('ASR (per 100,000)')
    ax1.set_title('F-codes (Dementia) - All Comunas', fontweight='bold')
    ax1.grid(True, alpha=0.3, axis='x')

ax2 = axes[1]
if len(comuna_asr_g) > 0:
    all_g = comuna_asr_g.sort_values('asr', ascending=True)
    colors_g = plt.cm.Greens(np.linspace(0.3, 0.9, len(all_g)))
    ax2.barh(all_g['comuna'], all_g['asr'], color=colors_g)
    ax2.set_xlabel('ASR (per 100,000)')
    ax2.set_title('G-codes (Neurological) - All Comunas', fontweight='bold')
    ax2.grid(True, alpha=0.3, axis='x')

plt.tight_layout()
save_figure(fig, 'fg_rm_comparison.png')
plt.show()
```

\newpage

## Spatial Analysis - RM

```{python}
#| label: load-spatial-libs
#| include: false

from libpysal.weights import Queen
from esda.moran import Moran, Moran_Local
from splot.esda import moran_scatterplot
from matplotlib.patches import Patch

shp_candidates = [
    os.path.join(data_path, 'comunas.shp'),
    os.path.join(os.getcwd(), 'comunas.shp'),
    os.path.join(os.getcwd(), 'data', 'comunas.shp')
]

shp_path = None
for candidate in shp_candidates:
    if os.path.exists(candidate):
        shp_path = candidate
        break

has_spatial_data = False
gdf_fg = None
pesos = None
has_f_data = False
has_g_data = False

if shp_path:
    gdf_gs = gpd.read_file(shp_path)

    def normalize_comuna_spatial(x):
        if pd.isna(x):
            return None
        s = str(x).upper().strip()
        s = s.encode('latin-1', errors='ignore').decode('latin-1', errors='ignore')
        replacements = {
            'Á': 'A', 'É': 'E', 'Í': 'I', 'Ó': 'O', 'Ú': 'U', 'Ñ': 'N',
            'Ã\x81': 'A', 'Ã\x89': 'E', 'Ã\x8d': 'I', 'Ã\x93': 'O', 'Ã\x9a': 'U',
            'Ã\x91': 'N', 'Ã±': 'N'
        }
        for old, new in replacements.items():
            s = s.replace(old, new)
        s = ''.join(c for c in s if c.isalnum() or c == ' ')
        return s.strip()

    gdf_gs["codregion"] = pd.to_numeric(gdf_gs["codregion"], errors="coerce")
    gdf_gs = gdf_gs[gdf_gs["codregion"] == 13].copy()

    COMUNA_COL = "Comuna"
    gdf_gs["comuna_norm"] = gdf_gs[COMUNA_COL].apply(normalize_comuna_spatial)

    comuna_asr_f_copy = comuna_asr_f.copy()
    comuna_asr_f_copy['comuna_norm'] = comuna_asr_f_copy['comuna'].apply(normalize_comuna_spatial)

    comuna_asr_g_copy = comuna_asr_g.copy()
    comuna_asr_g_copy['comuna_norm'] = comuna_asr_g_copy['comuna'].apply(normalize_comuna_spatial)

    gdf_f = gdf_gs.merge(
        comuna_asr_f_copy[['comuna_norm', 'asr']], 
        on='comuna_norm', 
        how='left'
    ).rename(columns={'asr': 'asr_f'})

    gdf_fg = gdf_f.merge(
        comuna_asr_g_copy[['comuna_norm', 'asr']], 
        on='comuna_norm', 
        how='left'
    ).rename(columns={'asr': 'asr_g'})

    gdf_fg['asr_f'] = gdf_fg['asr_f'].fillna(0)
    gdf_fg['asr_g'] = gdf_fg['asr_g'].fillna(0)

    has_f_data = gdf_fg['asr_f'].sum() > 0
    has_g_data = gdf_fg['asr_g'].sum() > 0
    has_spatial_data = True
    
    pesos = Queen.from_dataframe(gdf_fg)
```

### Choropleth Maps - ASR Distribution

```{python}
#| label: fig-spatial-choropleth
#| fig-cap: "ASR Distribution - F-codes and G-codes - Gran Santiago"
#| fig-width: 16
#| fig-height: 8

if has_spatial_data:
    fig, axes = plt.subplots(1, 2, figsize=(16, 8))

    ax1 = axes[0]
    if has_f_data:
        gdf_fg.plot(column='asr_f', cmap='Blues', linewidth=0.5, ax=ax1, edgecolor='0.5',
                    legend=True, legend_kwds={'label': 'ASR (per 100,000)', 'shrink': 0.6})
        ax1.set_title('F-codes (Dementia) - ASR by Comuna', fontweight='bold', fontsize=12)
    else:
        gdf_fg.plot(ax=ax1, color='lightgrey', edgecolor='0.5', linewidth=0.5)
        ax1.set_title('F-codes - No data', fontweight='bold', fontsize=12)
    ax1.set_axis_off()

    ax2 = axes[1]
    if has_g_data:
        gdf_fg.plot(column='asr_g', cmap='Greens', linewidth=0.5, ax=ax2, edgecolor='0.5',
                    legend=True, legend_kwds={'label': 'ASR (per 100,000)', 'shrink': 0.6})
        ax2.set_title('G-codes (Neurological) - ASR by Comuna', fontweight='bold', fontsize=12)
    else:
        gdf_fg.plot(ax=ax2, color='lightgrey', edgecolor='0.5', linewidth=0.5)
        ax2.set_title('G-codes - No data', fontweight='bold', fontsize=12)
    ax2.set_axis_off()

    plt.suptitle('Age-Standardized Hospitalization Rates - Gran Santiago (2019-2024)', fontsize=14, fontweight='bold', y=1.02)
    plt.tight_layout()
    save_figure(fig, 'spatial_choropleth_fg.png')
    plt.show()
else:
    fig, ax = plt.subplots(figsize=(8, 6))
    ax.text(0.5, 0.5, 'Shapefile not available', ha='center', va='center', fontsize=14)
    ax.set_axis_off()
    plt.show()
```

### Global Moran's I - Spatial Autocorrelation

```{python}
#| label: spatial-moran-global
#| include: false

moran_f = None
moran_g = None

if has_spatial_data and pesos is not None:
    if has_f_data and gdf_fg['asr_f'].var() > 0:
        moran_f = Moran(gdf_fg['asr_f'], pesos)

    if has_g_data and gdf_fg['asr_g'].var() > 0:
        moran_g = Moran(gdf_fg['asr_g'], pesos)
```

```{python}
#| label: tbl-moran-global
#| tbl-cap: "Global Moran's I - Spatial Autocorrelation Test"
#| tbl-cap-location: bottom

moran_results = []

if moran_f is not None:
    moran_results.append({
        'Variable': 'F-codes (Dementia)',
        "Moran's I": round(moran_f.I, 4),
        'E[I]': round(moran_f.EI, 4),
        'Variance': round(moran_f.VI_norm, 6),
        'Z-score': round(moran_f.z_norm, 4),
        'P-value': round(moran_f.p_norm, 4),
        'Interpretation': 'Clustered' if moran_f.I > 0 and moran_f.p_norm < 0.05 else ('Dispersed' if moran_f.I < 0 and moran_f.p_norm < 0.05 else 'Random')
    })

if moran_g is not None:
    moran_results.append({
        'Variable': 'G-codes (Neurological)',
        "Moran's I": round(moran_g.I, 4),
        'E[I]': round(moran_g.EI, 4),
        'Variance': round(moran_g.VI_norm, 6),
        'Z-score': round(moran_g.z_norm, 4),
        'P-value': round(moran_g.p_norm, 4),
        'Interpretation': 'Clustered' if moran_g.I > 0 and moran_g.p_norm < 0.05 else ('Dispersed' if moran_g.I < 0 and moran_g.p_norm < 0.05 else 'Random')
    })

if moran_results:
    moran_df = pd.DataFrame(moran_results)
    display(moran_df.style.format({
        "Moran's I": '{:.4f}',
        'E[I]': '{:.4f}',
        'Variance': '{:.6f}',
        'Z-score': '{:.4f}',
        'P-value': '{:.4f}'
    }).hide(axis="index"))
else:
    display(pd.DataFrame({'Message': ['Insufficient data for Moran analysis']}).style.hide(axis="index"))
```

```{python}
#| label: fig-moran-scatterplot
#| fig-cap: "Moran Scatterplot - Spatial Autocorrelation Visualization"
#| fig-width: 14
#| fig-height: 6

fig, axes = plt.subplots(1, 2, figsize=(14, 6))

if moran_f is not None:
    moran_scatterplot(moran_f, zstandard=True, ax=axes[0])
    axes[0].set_title(f"F-codes - Moran's I = {moran_f.I:.4f} (p = {moran_f.p_norm:.4f})", fontweight='bold')
else:
    axes[0].text(0.5, 0.5, 'Insufficient F-code data\nfor Moran analysis', ha='center', va='center', transform=axes[0].transAxes, fontsize=12)
    axes[0].set_title('F-codes (Dementia)', fontweight='bold')

if moran_g is not None:
    moran_scatterplot(moran_g, zstandard=True, ax=axes[1])
    axes[1].set_title(f"G-codes - Moran's I = {moran_g.I:.4f} (p = {moran_g.p_norm:.4f})", fontweight='bold')
else:
    axes[1].text(0.5, 0.5, 'Insufficient G-code data\nfor Moran analysis', ha='center', va='center', transform=axes[1].transAxes, fontsize=12)
    axes[1].set_title('G-codes (Neurological)', fontweight='bold')

plt.suptitle("Global Moran's I - Spatial Autocorrelation", fontsize=14, fontweight='bold', y=1.02)
plt.tight_layout()
save_figure(fig, 'moran_scatterplot_fg.png')
plt.show()
```

\newpage

### LISA - Local Indicators of Spatial Association

```{python}
#| label: lisa-calculation
#| include: false

def clasificar_lisa(lisa, data):
    significativo = lisa.p_sim < 0.05
    q = lisa.q
    cluster_labels = ['Not significant'] * len(data)
    for i in range(len(data)):
        if significativo[i]:
            if q[i] == 1: 
                cluster_labels[i] = 'High-High (Hot Spot)'
            elif q[i] == 2: 
                cluster_labels[i] = 'Low-High'
            elif q[i] == 3: 
                cluster_labels[i] = 'Low-Low (Cold Spot)'
            elif q[i] == 4: 
                cluster_labels[i] = 'High-Low'
    return cluster_labels

lisa_f = None
lisa_g = None

if has_spatial_data and pesos is not None:
    if has_f_data and gdf_fg['asr_f'].var() > 0:
        lisa_f = Moran_Local(gdf_fg['asr_f'], pesos)
        gdf_fg['cluster_f'] = clasificar_lisa(lisa_f, gdf_fg)
        gdf_fg['lisa_p_f'] = lisa_f.p_sim
    else:
        gdf_fg['cluster_f'] = 'No data'
        gdf_fg['lisa_p_f'] = 1.0

    if has_g_data and gdf_fg['asr_g'].var() > 0:
        lisa_g = Moran_Local(gdf_fg['asr_g'], pesos)
        gdf_fg['cluster_g'] = clasificar_lisa(lisa_g, gdf_fg)
        gdf_fg['lisa_p_g'] = lisa_g.p_sim
    else:
        gdf_fg['cluster_g'] = 'No data'
        gdf_fg['lisa_p_g'] = 1.0
```

```{python}
#| label: tbl-lisa-clusters-f
#| tbl-cap: "LISA Clusters - F-codes (Dementia)"
#| tbl-cap-location: bottom

if has_spatial_data and 'cluster_f' in gdf_fg.columns:
    clusters_f = gdf_fg.groupby('cluster_f').size().reset_index(name='N Comunas')
    clusters_f.columns = ['Cluster', 'N Comunas']
    clusters_f = clusters_f.sort_values('N Comunas', ascending=False)
    display(clusters_f.style.hide(axis="index"))
else:
    display(pd.DataFrame({'Message': ['No spatial data available']}).style.hide(axis="index"))
```

```{python}
#| label: tbl-lisa-clusters-g
#| tbl-cap: "LISA Clusters - G-codes (Neurological)"
#| tbl-cap-location: bottom

if has_spatial_data and 'cluster_g' in gdf_fg.columns:
    clusters_g = gdf_fg.groupby('cluster_g').size().reset_index(name='N Comunas')
    clusters_g.columns = ['Cluster', 'N Comunas']
    clusters_g = clusters_g.sort_values('N Comunas', ascending=False)
    display(clusters_g.style.hide(axis="index"))
else:
    display(pd.DataFrame({'Message': ['No spatial data available']}).style.hide(axis="index"))
```

```{python}
#| label: fig-lisa-maps
#| fig-cap: "LISA Cluster Maps - F-codes and G-codes"
#| fig-width: 16
#| fig-height: 8

colors_dict = {
    'High-High (Hot Spot)': '#d73027',
    'Low-Low (Cold Spot)': '#4575b4',
    'High-Low': '#fdae61',
    'Low-High': '#abd9e9',
    'Not significant': '#f0f0f0',
    'No data': '#d9d9d9'
}

if has_spatial_data and 'cluster_f' in gdf_fg.columns:
    fig, axes = plt.subplots(1, 2, figsize=(16, 8))

    ax1 = axes[0]
    gdf_fg.plot(ax=ax1, color=gdf_fg['cluster_f'].map(colors_dict), edgecolor='gray', linewidth=0.5)
    ax1.set_title('LISA Clusters - F-codes (Dementia)', fontsize=12, fontweight='bold')
    ax1.set_axis_off()

    ax2 = axes[1]
    gdf_fg.plot(ax=ax2, color=gdf_fg['cluster_g'].map(colors_dict), edgecolor='gray', linewidth=0.5)
    ax2.set_title('LISA Clusters - G-codes (Neurological)', fontsize=12, fontweight='bold')
    ax2.set_axis_off()

    legend_elements = [Patch(facecolor=color, edgecolor='black', label=label) 
                       for label, color in colors_dict.items() if label != 'No data']
    fig.legend(handles=legend_elements, loc='lower center', ncol=5, fontsize=10, 
               frameon=True, bbox_to_anchor=(0.5, -0.02))

    plt.suptitle('Local Indicators of Spatial Association (LISA)\nGran Santiago - Neurodegenerative Disease ASR (2019-2024)', 
                 fontsize=14, fontweight='bold', y=1.02)
    plt.tight_layout()
    save_figure(fig, 'lisa_clusters_fg.png')
    plt.show()
else:
    fig, ax = plt.subplots(figsize=(8, 6))
    ax.text(0.5, 0.5, 'Spatial data not available', ha='center', va='center', fontsize=14)
    ax.set_axis_off()
    plt.show()
```

```{python}
#| label: tbl-lisa-hotspots
#| tbl-cap: "Significant LISA Clusters - Comunas Detail"
#| tbl-cap-location: bottom

if has_spatial_data and 'cluster_f' in gdf_fg.columns:
    significant_clusters = gdf_fg[
        (gdf_fg['cluster_f'] != 'Not significant') | (gdf_fg['cluster_g'] != 'Not significant')
    ][['Comuna', 'asr_f', 'cluster_f', 'lisa_p_f', 'asr_g', 'cluster_g', 'lisa_p_g']].copy()
    significant_clusters.columns = ['Comuna', 'ASR F', 'Cluster F', 'P-value F', 'ASR G', 'Cluster G', 'P-value G']
    significant_clusters = significant_clusters.sort_values('ASR F', ascending=False)

    display(significant_clusters.style.format({
        'ASR F': '{:.2f}',
        'P-value F': '{:.4f}',
        'ASR G': '{:.2f}',
        'P-value G': '{:.4f}'
    }, na_rep='-').hide(axis="index"))
else:
    display(pd.DataFrame({'Message': ['No significant clusters found']}).style.hide(axis="index"))
```

```{python}
#| label: fig-lisa-significance
#| fig-cap: "LISA Significance Maps (p < 0.05)"
#| fig-width: 16
#| fig-height: 8

if has_spatial_data and 'lisa_p_f' in gdf_fg.columns:
    fig, axes = plt.subplots(1, 2, figsize=(16, 8))

    gdf_fg['sig_f'] = gdf_fg['lisa_p_f'] < 0.05
    gdf_fg.plot(column='sig_f', cmap='RdYlGn_r', ax=axes[0], edgecolor='gray', linewidth=0.5, legend=False)
    for idx, row in gdf_fg[gdf_fg['sig_f']].iterrows():
        centroid = row.geometry.centroid
        axes[0].annotate(row['Comuna'][:8], xy=(centroid.x, centroid.y), fontsize=6, ha='center', fontweight='bold')
    axes[0].set_title('F-codes - Significant Clusters (p < 0.05)', fontsize=12, fontweight='bold')
    axes[0].set_axis_off()

    gdf_fg['sig_g'] = gdf_fg['lisa_p_g'] < 0.05
    gdf_fg.plot(column='sig_g', cmap='RdYlGn_r', ax=axes[1], edgecolor='gray', linewidth=0.5, legend=False)
    for idx, row in gdf_fg[gdf_fg['sig_g']].iterrows():
        centroid = row.geometry.centroid
        axes[1].annotate(row['Comuna'][:8], xy=(centroid.x, centroid.y), fontsize=6, ha='center', fontweight='bold')
    axes[1].set_title('G-codes - Significant Clusters (p < 0.05)', fontsize=12, fontweight='bold')
    axes[1].set_axis_off()

    plt.suptitle('LISA Significance Maps - Gran Santiago', fontsize=14, fontweight='bold', y=1.02)
    plt.tight_layout()
    save_figure(fig, 'lisa_significance_fg.png')
    plt.show()
else:
    fig, ax = plt.subplots(figsize=(8, 6))
    ax.text(0.5, 0.5, 'Spatial data not available', ha='center', va='center', fontsize=14)
    ax.set_axis_off()
    plt.show()
```

### Spatial Analysis Summary

```{python}
#| label: tbl-spatial-summary
#| tbl-cap: "Spatial Analysis Summary - F and G codes"
#| tbl-cap-location: bottom

if has_spatial_data:
    spatial_summary = pd.DataFrame({
        'Metric': [
            'Comunas analyzed',
            'Comunas with F-code data',
            'Comunas with G-code data',
            'Mean ASR F-codes',
            'Mean ASR G-codes',
            "Moran's I (F-codes)",
            "Moran's I (G-codes)",
            'F-codes Hot Spots',
            'F-codes Cold Spots',
            'G-codes Hot Spots',
            'G-codes Cold Spots'
        ],
        'Value': [
            len(gdf_fg),
            (gdf_fg['asr_f'] > 0).sum(),
            (gdf_fg['asr_g'] > 0).sum(),
            f"{gdf_fg['asr_f'].mean():.2f}",
            f"{gdf_fg['asr_g'].mean():.2f}",
            f"{moran_f.I:.4f} (p={moran_f.p_norm:.4f})" if moran_f else 'N/A',
            f"{moran_g.I:.4f} (p={moran_g.p_norm:.4f})" if moran_g else 'N/A',
            (gdf_fg['cluster_f'] == 'High-High (Hot Spot)').sum() if 'cluster_f' in gdf_fg.columns else 0,
            (gdf_fg['cluster_f'] == 'Low-Low (Cold Spot)').sum() if 'cluster_f' in gdf_fg.columns else 0,
            (gdf_fg['cluster_g'] == 'High-High (Hot Spot)').sum() if 'cluster_g' in gdf_fg.columns else 0,
            (gdf_fg['cluster_g'] == 'Low-Low (Cold Spot)').sum() if 'cluster_g' in gdf_fg.columns else 0
        ]
    })

    display(spatial_summary.style.hide(axis="index"))
else:
    display(pd.DataFrame({'Message': ['Spatial analysis not available - shapefile not found']}).style.hide(axis="index"))
```


\newpage

## Disease-Specific Analysis - Metropolitan Region Comunas

```{python}
#| label: disease-specific-setup
#| include: false

# Calculate ASR by comuna for each specific ICD code
def calculate_comuna_asr_by_icd(df, pop_df, icd_code, per=100000):
    """Calculate ASR for a specific ICD code by comuna."""
    who_weights = pd.DataFrame([
        {'age_group': k, 'who_weight': v} for k, v in WHO_STANDARD_POPULATION.items()
    ])
    
    df_filtered = df[df['icd_code'] == icd_code].copy()
    
    if len(df_filtered) == 0:
        return pd.DataFrame(columns=['comuna', 'hospitalizations', 'asr'])
    
    df_filtered['comuna_norm'] = df_filtered['comuna'].apply(normalize_comuna)
    hosp_agg = df_filtered.groupby(['comuna_norm', 'year', 'age_group', 'sex']).size().reset_index(name='hospitalizations')
    pop_agg = pop_df.groupby(['comuna_norm', 'year', 'age_group', 'sex'])['population'].sum().reset_index()
    
    merged = hosp_agg.merge(pop_agg, on=['comuna_norm', 'year', 'age_group', 'sex'], how='left')
    merged = merged.dropna(subset=['population'])
    merged = merged[merged['population'] > 0]
    
    if len(merged) == 0:
        return pd.DataFrame(columns=['comuna', 'hospitalizations', 'asr'])
    
    merged['age_specific_rate'] = (merged['hospitalizations'] / merged['population']) * per
    merged = merged.merge(who_weights, on='age_group', how='left')
    merged['weighted_rate'] = merged['age_specific_rate'] * merged['who_weight']
    
    result = merged.groupby('comuna_norm').agg({
        'hospitalizations': 'sum',
        'weighted_rate': 'sum'
    }).reset_index()
    
    result['asr'] = (result['weighted_rate'] / TOTAL_WHO_WEIGHT).round(2)
    
    comuna_map = df_filtered.drop_duplicates('comuna_norm')[['comuna', 'comuna_norm']]
    result = result.merge(comuna_map, on='comuna_norm', how='left')
    
    return result[['comuna', 'hospitalizations', 'asr']]


# Get all unique ICD codes present in RM data
icd_codes_in_rm = rm_data['icd_code'].unique().tolist()
icd_codes_in_rm.sort()

# Calculate ASR for each disease
disease_asr_by_comuna = {}
for icd in icd_codes_in_rm:
    disease_asr_by_comuna[icd] = calculate_comuna_asr_by_icd(rm_data, pop_rm, icd)

# Prepare GeoDataFrame for each disease if spatial data available
disease_gdf = {}
disease_moran = {}
disease_lisa = {}

if has_spatial_data and gdf_fg is not None:
    for icd in icd_codes_in_rm:
        asr_data = disease_asr_by_comuna[icd].copy()
        if len(asr_data) > 0:
            asr_data['comuna_norm'] = asr_data['comuna'].apply(normalize_comuna_spatial)
            
            gdf_disease = gdf_gs.copy()
            gdf_disease = gdf_disease.merge(
                asr_data[['comuna_norm', 'asr']], 
                on='comuna_norm', 
                how='left'
            )
            gdf_disease['asr'] = gdf_disease['asr'].fillna(0)
            disease_gdf[icd] = gdf_disease
            
            # Calculate Moran's I if enough variance
            if gdf_disease['asr'].var() > 0 and gdf_disease['asr'].sum() > 0:
                try:
                    disease_moran[icd] = Moran(gdf_disease['asr'], pesos)
                    disease_lisa[icd] = Moran_Local(gdf_disease['asr'], pesos)
                except:
                    pass
```

### Disease Distribution Overview

```{python}
#| label: tbl-disease-overview-rm
#| tbl-cap: "Disease-specific hospitalization summary - Metropolitan Region"
#| tbl-cap-location: bottom

overview_data = []
for icd in icd_codes_in_rm:
    asr_data = disease_asr_by_comuna[icd]
    if len(asr_data) > 0:
        overview_data.append({
            'ICD Code': icd,
            'Description': ALL_NEURODEG_CODES.get(icd, 'Unknown'),
            'Total Hosp.': asr_data['hospitalizations'].sum(),
            'Comunas with Cases': len(asr_data[asr_data['hospitalizations'] > 0]),
            'Mean ASR': asr_data['asr'].mean().round(2),
            'Max ASR': asr_data['asr'].max(),
            'Top Comuna': asr_data.loc[asr_data['asr'].idxmax(), 'comuna'] if len(asr_data) > 0 else 'N/A'
        })

overview_df = pd.DataFrame(overview_data)
overview_df = overview_df.sort_values('Total Hosp.', ascending=False)

display(overview_df.style.format({
    'Total Hosp.': '{:,.0f}',
    'Mean ASR': '{:.2f}',
    'Max ASR': '{:.2f}'
}).hide(axis="index"))
```

```{python}
#| label: fig-disease-overview-bars
#| fig-cap: "Disease distribution comparison - Metropolitan Region"
#| fig-width: 16
#| fig-height: 6

fig, axes = plt.subplots(1, 3, figsize=(16, 6))

# Total hospitalizations by disease
ax1 = axes[0]
disease_totals = overview_df.sort_values('Total Hosp.', ascending=True)
colors = plt.cm.viridis(np.linspace(0.2, 0.8, len(disease_totals)))
ax1.barh(disease_totals['ICD Code'], disease_totals['Total Hosp.'], color=colors)
ax1.set_xlabel('Total Hospitalizations')
ax1.set_title('Total Hospitalizations by Disease', fontweight='bold')
ax1.grid(True, alpha=0.3, axis='x')

# Mean ASR by disease
ax2 = axes[1]
disease_asr = overview_df.sort_values('Mean ASR', ascending=True)
colors = plt.cm.YlOrRd(disease_asr['Mean ASR'] / disease_asr['Mean ASR'].max())
ax2.barh(disease_asr['ICD Code'], disease_asr['Mean ASR'], color=colors)
ax2.set_xlabel('Mean ASR (per 100,000)')
ax2.set_title('Mean ASR by Disease', fontweight='bold')
ax2.grid(True, alpha=0.3, axis='x')

# Comunas with cases
ax3 = axes[2]
disease_comunas = overview_df.sort_values('Comunas with Cases', ascending=True)
ax3.barh(disease_comunas['ICD Code'], disease_comunas['Comunas with Cases'], color='steelblue')
ax3.set_xlabel('Number of Comunas')
ax3.set_title('Geographic Spread (Comunas with Cases)', fontweight='bold')
ax3.grid(True, alpha=0.3, axis='x')

plt.tight_layout()
save_figure(fig, 'disease_overview_rm.png')
plt.show()
```

\newpage

### Alzheimer Disease (F00 + G30)

```{python}
#| label: alzheimer-analysis
#| include: false

# Combine F00 and G30 for Alzheimer analysis
alzheimer_codes = ['F00', 'G30']
alzheimer_data = rm_data[rm_data['icd_code'].isin(alzheimer_codes)].copy()

alzheimer_asr = calculate_comuna_asr_subset(alzheimer_data, pop_rm)
alzheimer_asr = alzheimer_asr.sort_values('asr', ascending=False)

# Spatial analysis for Alzheimer
gdf_alzheimer = None
moran_alzheimer = None
lisa_alzheimer = None

if has_spatial_data and len(alzheimer_asr) > 0:
    alzheimer_asr_copy = alzheimer_asr.copy()
    alzheimer_asr_copy['comuna_norm'] = alzheimer_asr_copy['comuna'].apply(normalize_comuna_spatial)
    
    gdf_alzheimer = gdf_gs.copy()
    gdf_alzheimer = gdf_alzheimer.merge(
        alzheimer_asr_copy[['comuna_norm', 'asr']], 
        on='comuna_norm', 
        how='left'
    )
    gdf_alzheimer['asr'] = gdf_alzheimer['asr'].fillna(0)
    
    if gdf_alzheimer['asr'].var() > 0:
        try:
            moran_alzheimer = Moran(gdf_alzheimer['asr'], pesos)
            lisa_alzheimer = Moran_Local(gdf_alzheimer['asr'], pesos)
            gdf_alzheimer['cluster'] = clasificar_lisa(lisa_alzheimer, gdf_alzheimer)
            gdf_alzheimer['lisa_p'] = lisa_alzheimer.p_sim
        except:
            pass
```

```{python}
#| label: tbl-alzheimer-comunas
#| tbl-cap: "Alzheimer Disease (F00 + G30) - ASR by Comuna"
#| tbl-cap-location: bottom

if len(alzheimer_asr) > 0:
    display_alz = alzheimer_asr.copy()
    display_alz.columns = ['Comuna', 'Hospitalizations', 'ASR']
    display(display_alz.style.format({
        'Hospitalizations': '{:,.0f}',
        'ASR': '{:.2f}'
    }).hide(axis="index"))
else:
    display(pd.DataFrame({'Message': ['No Alzheimer cases in RM']}).style.hide(axis="index"))
```

```{python}
#| label: fig-alzheimer-spatial
#| fig-cap: "Alzheimer Disease (F00 + G30) - Spatial Analysis"
#| fig-width: 16
#| fig-height: 12

if gdf_alzheimer is not None and gdf_alzheimer['asr'].sum() > 0:
    fig, axes = plt.subplots(2, 2, figsize=(16, 12))
    
    # Choropleth map
    ax1 = axes[0, 0]
    gdf_alzheimer.plot(column='asr', cmap='Reds', linewidth=0.5, ax=ax1, edgecolor='0.5',
                       legend=True, legend_kwds={'label': 'ASR (per 100,000)', 'shrink': 0.6})
    ax1.set_title('Alzheimer Disease - ASR Distribution', fontweight='bold', fontsize=12)
    ax1.set_axis_off()
    
    # Moran scatterplot
    ax2 = axes[0, 1]
    if moran_alzheimer is not None:
        moran_scatterplot(moran_alzheimer, zstandard=True, ax=ax2)
        ax2.set_title(f"Moran's I = {moran_alzheimer.I:.4f} (p = {moran_alzheimer.p_norm:.4f})", fontweight='bold')
    else:
        ax2.text(0.5, 0.5, 'Insufficient data for Moran analysis', ha='center', va='center', transform=ax2.transAxes)
        ax2.set_title('Moran Scatterplot', fontweight='bold')
    
    # LISA clusters
    ax3 = axes[1, 0]
    if 'cluster' in gdf_alzheimer.columns:
        gdf_alzheimer.plot(ax=ax3, color=gdf_alzheimer['cluster'].map(colors_dict), edgecolor='gray', linewidth=0.5)
        ax3.set_title('LISA Clusters - Alzheimer Disease', fontweight='bold', fontsize=12)
    else:
        gdf_alzheimer.plot(ax=ax3, color='lightgrey', edgecolor='gray', linewidth=0.5)
        ax3.set_title('LISA Clusters - No significant clusters', fontweight='bold', fontsize=12)
    ax3.set_axis_off()
    
    # Bar chart of top comunas
    ax4 = axes[1, 1]
    top_alz = alzheimer_asr.head(15).sort_values('asr', ascending=True)
    colors_bar = plt.cm.Reds(top_alz['asr'] / top_alz['asr'].max())
    ax4.barh(top_alz['comuna'], top_alz['asr'], color=colors_bar)
    ax4.set_xlabel('ASR (per 100,000)')
    ax4.set_title('Top 15 Comunas - Alzheimer ASR', fontweight='bold')
    ax4.grid(True, alpha=0.3, axis='x')
    
    plt.suptitle('Alzheimer Disease (F00 + G30) - Metropolitan Region Analysis', fontsize=14, fontweight='bold', y=1.02)
    plt.tight_layout()
    save_figure(fig, 'alzheimer_spatial_rm.png')
    plt.show()
else:
    fig, ax = plt.subplots(figsize=(8, 6))
    ax.text(0.5, 0.5, 'Insufficient Alzheimer data for spatial analysis', ha='center', va='center', fontsize=14)
    ax.set_axis_off()
    plt.show()
```

```{python}
#| label: tbl-alzheimer-spatial-stats
#| tbl-cap: "Alzheimer Disease - Spatial Statistics Summary"
#| tbl-cap-location: bottom

if gdf_alzheimer is not None and moran_alzheimer is not None:
    alz_stats = pd.DataFrame({
        'Metric': [
            'Total Hospitalizations',
            'Comunas with Cases',
            'Mean ASR',
            'Max ASR',
            'Top Comuna',
            "Moran's I",
            'P-value',
            'Spatial Pattern',
            'Hot Spots',
            'Cold Spots'
        ],
        'Value': [
            f"{alzheimer_asr['hospitalizations'].sum():,.0f}",
            len(alzheimer_asr[alzheimer_asr['hospitalizations'] > 0]),
            f"{alzheimer_asr['asr'].mean():.2f}",
            f"{alzheimer_asr['asr'].max():.2f}",
            alzheimer_asr.iloc[0]['comuna'],
            f"{moran_alzheimer.I:.4f}",
            f"{moran_alzheimer.p_norm:.4f}",
            'Clustered' if moran_alzheimer.I > 0 and moran_alzheimer.p_norm < 0.05 else ('Dispersed' if moran_alzheimer.I < 0 and moran_alzheimer.p_norm < 0.05 else 'Random'),
            (gdf_alzheimer['cluster'] == 'High-High (Hot Spot)').sum() if 'cluster' in gdf_alzheimer.columns else 0,
            (gdf_alzheimer['cluster'] == 'Low-Low (Cold Spot)').sum() if 'cluster' in gdf_alzheimer.columns else 0
        ]
    })
    display(alz_stats.style.hide(axis="index"))
else:
    display(pd.DataFrame({'Message': ['Spatial statistics not available for Alzheimer']}).style.hide(axis="index"))
```

\newpage

### Parkinson Disease (G20)

```{python}
#| label: parkinson-analysis
#| include: false

parkinson_data = rm_data[rm_data['icd_code'] == 'G20'].copy()
parkinson_asr = calculate_comuna_asr_subset(parkinson_data, pop_rm)
parkinson_asr = parkinson_asr.sort_values('asr', ascending=False)

gdf_parkinson = None
moran_parkinson = None
lisa_parkinson = None

if has_spatial_data and len(parkinson_asr) > 0:
    parkinson_asr_copy = parkinson_asr.copy()
    parkinson_asr_copy['comuna_norm'] = parkinson_asr_copy['comuna'].apply(normalize_comuna_spatial)
    
    gdf_parkinson = gdf_gs.copy()
    gdf_parkinson = gdf_parkinson.merge(
        parkinson_asr_copy[['comuna_norm', 'asr']], 
        on='comuna_norm', 
        how='left'
    )
    gdf_parkinson['asr'] = gdf_parkinson['asr'].fillna(0)
    
    if gdf_parkinson['asr'].var() > 0:
        try:
            moran_parkinson = Moran(gdf_parkinson['asr'], pesos)
            lisa_parkinson = Moran_Local(gdf_parkinson['asr'], pesos)
            gdf_parkinson['cluster'] = clasificar_lisa(lisa_parkinson, gdf_parkinson)
            gdf_parkinson['lisa_p'] = lisa_parkinson.p_sim
        except:
            pass
```

```{python}
#| label: tbl-parkinson-comunas
#| tbl-cap: "Parkinson Disease (G20) - ASR by Comuna"
#| tbl-cap-location: bottom

if len(parkinson_asr) > 0:
    display_park = parkinson_asr.copy()
    display_park.columns = ['Comuna', 'Hospitalizations', 'ASR']
    display(display_park.style.format({
        'Hospitalizations': '{:,.0f}',
        'ASR': '{:.2f}'
    }).hide(axis="index"))
else:
    display(pd.DataFrame({'Message': ['No Parkinson cases in RM']}).style.hide(axis="index"))
```

```{python}
#| label: fig-parkinson-spatial
#| fig-cap: "Parkinson Disease (G20) - Spatial Analysis"
#| fig-width: 16
#| fig-height: 12

if gdf_parkinson is not None and gdf_parkinson['asr'].sum() > 0:
    fig, axes = plt.subplots(2, 2, figsize=(16, 12))
    
    ax1 = axes[0, 0]
    gdf_parkinson.plot(column='asr', cmap='Purples', linewidth=0.5, ax=ax1, edgecolor='0.5',
                       legend=True, legend_kwds={'label': 'ASR (per 100,000)', 'shrink': 0.6})
    ax1.set_title('Parkinson Disease - ASR Distribution', fontweight='bold', fontsize=12)
    ax1.set_axis_off()
    
    ax2 = axes[0, 1]
    if moran_parkinson is not None:
        moran_scatterplot(moran_parkinson, zstandard=True, ax=ax2)
        ax2.set_title(f"Moran's I = {moran_parkinson.I:.4f} (p = {moran_parkinson.p_norm:.4f})", fontweight='bold')
    else:
        ax2.text(0.5, 0.5, 'Insufficient data for Moran analysis', ha='center', va='center', transform=ax2.transAxes)
        ax2.set_title('Moran Scatterplot', fontweight='bold')
    
    ax3 = axes[1, 0]
    if 'cluster' in gdf_parkinson.columns:
        gdf_parkinson.plot(ax=ax3, color=gdf_parkinson['cluster'].map(colors_dict), edgecolor='gray', linewidth=0.5)
        ax3.set_title('LISA Clusters - Parkinson Disease', fontweight='bold', fontsize=12)
    else:
        gdf_parkinson.plot(ax=ax3, color='lightgrey', edgecolor='gray', linewidth=0.5)
        ax3.set_title('LISA Clusters - No significant clusters', fontweight='bold', fontsize=12)
    ax3.set_axis_off()
    
    ax4 = axes[1, 1]
    top_park = parkinson_asr.head(15).sort_values('asr', ascending=True)
    colors_bar = plt.cm.Purples(top_park['asr'] / top_park['asr'].max())
    ax4.barh(top_park['comuna'], top_park['asr'], color=colors_bar)
    ax4.set_xlabel('ASR (per 100,000)')
    ax4.set_title('Top 15 Comunas - Parkinson ASR', fontweight='bold')
    ax4.grid(True, alpha=0.3, axis='x')
    
    plt.suptitle('Parkinson Disease (G20) - Metropolitan Region Analysis', fontsize=14, fontweight='bold', y=1.02)
    plt.tight_layout()
    save_figure(fig, 'parkinson_spatial_rm.png')
    plt.show()
else:
    fig, ax = plt.subplots(figsize=(8, 6))
    ax.text(0.5, 0.5, 'Insufficient Parkinson data for spatial analysis', ha='center', va='center', fontsize=14)
    ax.set_axis_off()
    plt.show()
```

```{python}
#| label: tbl-parkinson-spatial-stats
#| tbl-cap: "Parkinson Disease - Spatial Statistics Summary"
#| tbl-cap-location: bottom

if gdf_parkinson is not None and moran_parkinson is not None:
    park_stats = pd.DataFrame({
        'Metric': [
            'Total Hospitalizations',
            'Comunas with Cases',
            'Mean ASR',
            'Max ASR',
            'Top Comuna',
            "Moran's I",
            'P-value',
            'Spatial Pattern',
            'Hot Spots',
            'Cold Spots'
        ],
        'Value': [
            f"{parkinson_asr['hospitalizations'].sum():,.0f}",
            len(parkinson_asr[parkinson_asr['hospitalizations'] > 0]),
            f"{parkinson_asr['asr'].mean():.2f}",
            f"{parkinson_asr['asr'].max():.2f}",
            parkinson_asr.iloc[0]['comuna'] if len(parkinson_asr) > 0 else 'N/A',
            f"{moran_parkinson.I:.4f}",
            f"{moran_parkinson.p_norm:.4f}",
            'Clustered' if moran_parkinson.I > 0 and moran_parkinson.p_norm < 0.05 else ('Dispersed' if moran_parkinson.I < 0 and moran_parkinson.p_norm < 0.05 else 'Random'),
            (gdf_parkinson['cluster'] == 'High-High (Hot Spot)').sum() if 'cluster' in gdf_parkinson.columns else 0,
            (gdf_parkinson['cluster'] == 'Low-Low (Cold Spot)').sum() if 'cluster' in gdf_parkinson.columns else 0
        ]
    })
    display(park_stats.style.hide(axis="index"))
else:
    display(pd.DataFrame({'Message': ['Spatial statistics not available for Parkinson']}).style.hide(axis="index"))
```

\newpage

### Vascular Dementia (F01)

```{python}
#| label: vascular-dementia-analysis
#| include: false

vascular_data = rm_data[rm_data['icd_code'] == 'F01'].copy()
vascular_asr = calculate_comuna_asr_subset(vascular_data, pop_rm)
vascular_asr = vascular_asr.sort_values('asr', ascending=False)

gdf_vascular = None
moran_vascular = None
lisa_vascular = None

if has_spatial_data and len(vascular_asr) > 0:
    vascular_asr_copy = vascular_asr.copy()
    vascular_asr_copy['comuna_norm'] = vascular_asr_copy['comuna'].apply(normalize_comuna_spatial)
    
    gdf_vascular = gdf_gs.copy()
    gdf_vascular = gdf_vascular.merge(
        vascular_asr_copy[['comuna_norm', 'asr']], 
        on='comuna_norm', 
        how='left'
    )
    gdf_vascular['asr'] = gdf_vascular['asr'].fillna(0)
    
    if gdf_vascular['asr'].var() > 0:
        try:
            moran_vascular = Moran(gdf_vascular['asr'], pesos)
            lisa_vascular = Moran_Local(gdf_vascular['asr'], pesos)
            gdf_vascular['cluster'] = clasificar_lisa(lisa_vascular, gdf_vascular)
            gdf_vascular['lisa_p'] = lisa_vascular.p_sim
        except:
            pass
```

```{python}
#| label: tbl-vascular-comunas
#| tbl-cap: "Vascular Dementia (F01) - ASR by Comuna"
#| tbl-cap-location: bottom

if len(vascular_asr) > 0:
    display_vasc = vascular_asr.copy()
    display_vasc.columns = ['Comuna', 'Hospitalizations', 'ASR']
    display(display_vasc.style.format({
        'Hospitalizations': '{:,.0f}',
        'ASR': '{:.2f}'
    }).hide(axis="index"))
else:
    display(pd.DataFrame({'Message': ['No Vascular Dementia cases in RM']}).style.hide(axis="index"))
```

```{python}
#| label: fig-vascular-spatial
#| fig-cap: "Vascular Dementia (F01) - Spatial Analysis"
#| fig-width: 16
#| fig-height: 12

if gdf_vascular is not None and gdf_vascular['asr'].sum() > 0:
    fig, axes = plt.subplots(2, 2, figsize=(16, 12))
    
    ax1 = axes[0, 0]
    gdf_vascular.plot(column='asr', cmap='Oranges', linewidth=0.5, ax=ax1, edgecolor='0.5',
                      legend=True, legend_kwds={'label': 'ASR (per 100,000)', 'shrink': 0.6})
    ax1.set_title('Vascular Dementia - ASR Distribution', fontweight='bold', fontsize=12)
    ax1.set_axis_off()
    
    ax2 = axes[0, 1]
    if moran_vascular is not None:
        moran_scatterplot(moran_vascular, zstandard=True, ax=ax2)
        ax2.set_title(f"Moran's I = {moran_vascular.I:.4f} (p = {moran_vascular.p_norm:.4f})", fontweight='bold')
    else:
        ax2.text(0.5, 0.5, 'Insufficient data for Moran analysis', ha='center', va='center', transform=ax2.transAxes)
        ax2.set_title('Moran Scatterplot', fontweight='bold')
    
    ax3 = axes[1, 0]
    if 'cluster' in gdf_vascular.columns:
        gdf_vascular.plot(ax=ax3, color=gdf_vascular['cluster'].map(colors_dict), edgecolor='gray', linewidth=0.5)
        ax3.set_title('LISA Clusters - Vascular Dementia', fontweight='bold', fontsize=12)
    else:
        gdf_vascular.plot(ax=ax3, color='lightgrey', edgecolor='gray', linewidth=0.5)
        ax3.set_title('LISA Clusters - No significant clusters', fontweight='bold', fontsize=12)
    ax3.set_axis_off()
    
    ax4 = axes[1, 1]
    top_vasc = vascular_asr.head(15).sort_values('asr', ascending=True)
    colors_bar = plt.cm.Oranges(top_vasc['asr'] / top_vasc['asr'].max())
    ax4.barh(top_vasc['comuna'], top_vasc['asr'], color=colors_bar)
    ax4.set_xlabel('ASR (per 100,000)')
    ax4.set_title('Top 15 Comunas - Vascular Dementia ASR', fontweight='bold')
    ax4.grid(True, alpha=0.3, axis='x')
    
    plt.suptitle('Vascular Dementia (F01) - Metropolitan Region Analysis', fontsize=14, fontweight='bold', y=1.02)
    plt.tight_layout()
    save_figure(fig, 'vascular_dementia_spatial_rm.png')
    plt.show()
else:
    fig, ax = plt.subplots(figsize=(8, 6))
    ax.text(0.5, 0.5, 'Insufficient Vascular Dementia data for spatial analysis', ha='center', va='center', fontsize=14)
    ax.set_axis_off()
    plt.show()
```

```{python}
#| label: tbl-vascular-spatial-stats
#| tbl-cap: "Vascular Dementia - Spatial Statistics Summary"
#| tbl-cap-location: bottom

if gdf_vascular is not None and moran_vascular is not None:
    vasc_stats = pd.DataFrame({
        'Metric': [
            'Total Hospitalizations',
            'Comunas with Cases',
            'Mean ASR',
            'Max ASR',
            'Top Comuna',
            "Moran's I",
            'P-value',
            'Spatial Pattern',
            'Hot Spots',
            'Cold Spots'
        ],
        'Value': [
            f"{vascular_asr['hospitalizations'].sum():,.0f}",
            len(vascular_asr[vascular_asr['hospitalizations'] > 0]),
            f"{vascular_asr['asr'].mean():.2f}",
            f"{vascular_asr['asr'].max():.2f}",
            vascular_asr.iloc[0]['comuna'] if len(vascular_asr) > 0 else 'N/A',
            f"{moran_vascular.I:.4f}",
            f"{moran_vascular.p_norm:.4f}",
            'Clustered' if moran_vascular.I > 0 and moran_vascular.p_norm < 0.05 else ('Dispersed' if moran_vascular.I < 0 and moran_vascular.p_norm < 0.05 else 'Random'),
            (gdf_vascular['cluster'] == 'High-High (Hot Spot)').sum() if 'cluster' in gdf_vascular.columns else 0,
            (gdf_vascular['cluster'] == 'Low-Low (Cold Spot)').sum() if 'cluster' in gdf_vascular.columns else 0
        ]
    })
    display(vasc_stats.style.hide(axis="index"))
else:
    display(pd.DataFrame({'Message': ['Spatial statistics not available for Vascular Dementia']}).style.hide(axis="index"))
```

\newpage

### Other Degenerative Diseases (G31)

```{python}
#| label: g31-analysis
#| include: false

g31_data = rm_data[rm_data['icd_code'] == 'G31'].copy()
g31_asr = calculate_comuna_asr_subset(g31_data, pop_rm)
g31_asr = g31_asr.sort_values('asr', ascending=False)

gdf_g31 = None
moran_g31 = None
lisa_g31 = None

if has_spatial_data and len(g31_asr) > 0:
    g31_asr_copy = g31_asr.copy()
    g31_asr_copy['comuna_norm'] = g31_asr_copy['comuna'].apply(normalize_comuna_spatial)
    
    gdf_g31 = gdf_gs.copy()
    gdf_g31 = gdf_g31.merge(
        g31_asr_copy[['comuna_norm', 'asr']], 
        on='comuna_norm', 
        how='left'
    )
    gdf_g31['asr'] = gdf_g31['asr'].fillna(0)
    
    if gdf_g31['asr'].var() > 0:
        try:
            moran_g31 = Moran(gdf_g31['asr'], pesos)
            lisa_g31 = Moran_Local(gdf_g31['asr'], pesos)
            gdf_g31['cluster'] = clasificar_lisa(lisa_g31, gdf_g31)
            gdf_g31['lisa_p'] = lisa_g31.p_sim
        except:
            pass
```

```{python}
#| label: tbl-g31-comunas
#| tbl-cap: "Other Degenerative Diseases (G31) - ASR by Comuna"
#| tbl-cap-location: bottom

if len(g31_asr) > 0:
    display_g31 = g31_asr.copy()
    display_g31.columns = ['Comuna', 'Hospitalizations', 'ASR']
    display(display_g31.style.format({
        'Hospitalizations': '{:,.0f}',
        'ASR': '{:.2f}'
    }).hide(axis="index"))
else:
    display(pd.DataFrame({'Message': ['No G31 cases in RM']}).style.hide(axis="index"))
```

```{python}
#| label: fig-g31-spatial
#| fig-cap: "Other Degenerative Diseases (G31) - Spatial Analysis"
#| fig-width: 16
#| fig-height: 12

if gdf_g31 is not None and gdf_g31['asr'].sum() > 0:
    fig, axes = plt.subplots(2, 2, figsize=(16, 12))
    
    ax1 = axes[0, 0]
    gdf_g31.plot(column='asr', cmap='BuGn', linewidth=0.5, ax=ax1, edgecolor='0.5',
                 legend=True, legend_kwds={'label': 'ASR (per 100,000)', 'shrink': 0.6})
    ax1.set_title('Other Degenerative Diseases (G31) - ASR Distribution', fontweight='bold', fontsize=12)
    ax1.set_axis_off()
    
    ax2 = axes[0, 1]
    if moran_g31 is not None:
        moran_scatterplot(moran_g31, zstandard=True, ax=ax2)
        ax2.set_title(f"Moran's I = {moran_g31.I:.4f} (p = {moran_g31.p_norm:.4f})", fontweight='bold')
    else:
        ax2.text(0.5, 0.5, 'Insufficient data for Moran analysis', ha='center', va='center', transform=ax2.transAxes)
        ax2.set_title('Moran Scatterplot', fontweight='bold')
    
    ax3 = axes[1, 0]
    if 'cluster' in gdf_g31.columns:
        gdf_g31.plot(ax=ax3, color=gdf_g31['cluster'].map(colors_dict), edgecolor='gray', linewidth=0.5)
        ax3.set_title('LISA Clusters - G31', fontweight='bold', fontsize=12)
    else:
        gdf_g31.plot(ax=ax3, color='lightgrey', edgecolor='gray', linewidth=0.5)
        ax3.set_title('LISA Clusters - No significant clusters', fontweight='bold', fontsize=12)
    ax3.set_axis_off()
    
    ax4 = axes[1, 1]
    top_g31 = g31_asr.head(15).sort_values('asr', ascending=True)
    colors_bar = plt.cm.BuGn(top_g31['asr'] / top_g31['asr'].max())
    ax4.barh(top_g31['comuna'], top_g31['asr'], color=colors_bar)
    ax4.set_xlabel('ASR (per 100,000)')
    ax4.set_title('Top 15 Comunas - G31 ASR', fontweight='bold')
    ax4.grid(True, alpha=0.3, axis='x')
    
    plt.suptitle('Other Degenerative Diseases (G31) - Metropolitan Region Analysis', fontsize=14, fontweight='bold', y=1.02)
    plt.tight_layout()
    save_figure(fig, 'g31_spatial_rm.png')
    plt.show()
else:
    fig, ax = plt.subplots(figsize=(8, 6))
    ax.text(0.5, 0.5, 'Insufficient G31 data for spatial analysis', ha='center', va='center', fontsize=14)
    ax.set_axis_off()
    plt.show()
```

\newpage

### Unspecified Dementia (F03)

```{python}
#| label: f03-analysis
#| include: false

f03_data = rm_data[rm_data['icd_code'] == 'F03'].copy()
f03_asr = calculate_comuna_asr_subset(f03_data, pop_rm)
f03_asr = f03_asr.sort_values('asr', ascending=False)

gdf_f03 = None
moran_f03 = None
lisa_f03 = None

if has_spatial_data and len(f03_asr) > 0:
    f03_asr_copy = f03_asr.copy()
    f03_asr_copy['comuna_norm'] = f03_asr_copy['comuna'].apply(normalize_comuna_spatial)
    
    gdf_f03 = gdf_gs.copy()
    gdf_f03 = gdf_f03.merge(
        f03_asr_copy[['comuna_norm', 'asr']], 
        on='comuna_norm', 
        how='left'
    )
    gdf_f03['asr'] = gdf_f03['asr'].fillna(0)
    
    if gdf_f03['asr'].var() > 0:
        try:
            moran_f03 = Moran(gdf_f03['asr'], pesos)
            lisa_f03 = Moran_Local(gdf_f03['asr'], pesos)
            gdf_f03['cluster'] = clasificar_lisa(lisa_f03, gdf_f03)
            gdf_f03['lisa_p'] = lisa_f03.p_sim
        except:
            pass
```

```{python}
#| label: tbl-f03-comunas
#| tbl-cap: "Unspecified Dementia (F03) - ASR by Comuna"
#| tbl-cap-location: bottom

if len(f03_asr) > 0:
    display_f03 = f03_asr.copy()
    display_f03.columns = ['Comuna', 'Hospitalizations', 'ASR']
    display(display_f03.style.format({
        'Hospitalizations': '{:,.0f}',
        'ASR': '{:.2f}'
    }).hide(axis="index"))
else:
    display(pd.DataFrame({'Message': ['No F03 cases in RM']}).style.hide(axis="index"))
```

```{python}
#| label: fig-f03-spatial
#| fig-cap: "Unspecified Dementia (F03) - Spatial Analysis"
#| fig-width: 16
#| fig-height: 12

if gdf_f03 is not None and gdf_f03['asr'].sum() > 0:
    fig, axes = plt.subplots(2, 2, figsize=(16, 12))
    
    ax1 = axes[0, 0]
    gdf_f03.plot(column='asr', cmap='YlOrBr', linewidth=0.5, ax=ax1, edgecolor='0.5',
                 legend=True, legend_kwds={'label': 'ASR (per 100,000)', 'shrink': 0.6})
    ax1.set_title('Unspecified Dementia (F03) - ASR Distribution', fontweight='bold', fontsize=12)
    ax1.set_axis_off()
    
    ax2 = axes[0, 1]
    if moran_f03 is not None:
        moran_scatterplot(moran_f03, zstandard=True, ax=ax2)
        ax2.set_title(f"Moran's I = {moran_f03.I:.4f} (p = {moran_f03.p_norm:.4f})", fontweight='bold')
    else:
        ax2.text(0.5, 0.5, 'Insufficient data for Moran analysis', ha='center', va='center', transform=ax2.transAxes)
        ax2.set_title('Moran Scatterplot', fontweight='bold')
    
    ax3 = axes[1, 0]
    if 'cluster' in gdf_f03.columns:
        gdf_f03.plot(ax=ax3, color=gdf_f03['cluster'].map(colors_dict), edgecolor='gray', linewidth=0.5)
        ax3.set_title('LISA Clusters - F03', fontweight='bold', fontsize=12)
    else:
        gdf_f03.plot(ax=ax3, color='lightgrey', edgecolor='gray', linewidth=0.5)
        ax3.set_title('LISA Clusters - No significant clusters', fontweight='bold', fontsize=12)
    ax3.set_axis_off()
    
    ax4 = axes[1, 1]
    top_f03 = f03_asr.head(15).sort_values('asr', ascending=True)
    colors_bar = plt.cm.YlOrBr(top_f03['asr'] / top_f03['asr'].max())
    ax4.barh(top_f03['comuna'], top_f03['asr'], color=colors_bar)
    ax4.set_xlabel('ASR (per 100,000)')
    ax4.set_title('Top 15 Comunas - F03 ASR', fontweight='bold')
    ax4.grid(True, alpha=0.3, axis='x')
    
    plt.suptitle('Unspecified Dementia (F03) - Metropolitan Region Analysis', fontsize=14, fontweight='bold', y=1.02)
    plt.tight_layout()
    save_figure(fig, 'f03_spatial_rm.png')
    plt.show()
else:
    fig, ax = plt.subplots(figsize=(8, 6))
    ax.text(0.5, 0.5, 'Insufficient F03 data for spatial analysis', ha='center', va='center', fontsize=14)
    ax.set_axis_off()
    plt.show()
```

\newpage

### Disease Comparison Maps

```{python}
#| label: fig-all-diseases-choropleth
#| fig-cap: "All Diseases - ASR Choropleth Comparison"
#| fig-width: 18
#| fig-height: 16

if has_spatial_data:
    # Select diseases with enough data
    diseases_to_plot = []
    disease_labels = {
        'F00': ('Dementia in Alzheimer (F00)', 'Reds'),
        'F01': ('Vascular Dementia (F01)', 'Oranges'),
        'F02': ('Dementia in Other Diseases (F02)', 'YlOrBr'),
        'F03': ('Unspecified Dementia (F03)', 'YlOrRd'),
        'F04': ('Organic Amnesic Syndrome (F04)', 'RdPu'),
        'F06.7': ('Mild Cognitive Disorder (F06.7)', 'PuRd'),
        'G20': ('Parkinson Disease (G20)', 'Purples'),
        'G30': ('Alzheimer Disease (G30)', 'Reds'),
        'G31': ('Other Degenerative (G31)', 'BuGn'),
        'G32': ('Degenerative in Other Diseases (G32)', 'GnBu')
    }
    
    for icd in icd_codes_in_rm:
        if icd in disease_gdf and disease_gdf[icd]['asr'].sum() > 0:
            diseases_to_plot.append(icd)
    
    n_diseases = len(diseases_to_plot)
    
    if n_diseases > 0:
        ncols = 3
        nrows = (n_diseases + ncols - 1) // ncols
        
        fig, axes = plt.subplots(nrows, ncols, figsize=(18, 5*nrows))
        axes = axes.flatten() if n_diseases > 1 else [axes]
        
        for idx, icd in enumerate(diseases_to_plot):
            ax = axes[idx]
            gdf = disease_gdf[icd]
            label, cmap = disease_labels.get(icd, (icd, 'viridis'))
            
            gdf.plot(column='asr', cmap=cmap, linewidth=0.3, ax=ax, edgecolor='0.5',
                     legend=True, legend_kwds={'label': 'ASR', 'shrink': 0.5, 'pad': 0.01})
            ax.set_title(label, fontweight='bold', fontsize=10)
            ax.set_axis_off()
        
        for idx in range(len(diseases_to_plot), len(axes)):
            axes[idx].set_visible(False)
        
        plt.suptitle('Disease-Specific ASR Distribution - Metropolitan Region (2019-2024)', 
                     fontsize=14, fontweight='bold', y=1.01)
        plt.tight_layout()
        save_figure(fig, 'all_diseases_choropleth_rm.png')
        plt.show()
    else:
        fig, ax = plt.subplots(figsize=(8, 6))
        ax.text(0.5, 0.5, 'No disease data available for mapping', ha='center', va='center', fontsize=14)
        ax.set_axis_off()
        plt.show()
else:
    fig, ax = plt.subplots(figsize=(8, 6))
    ax.text(0.5, 0.5, 'Spatial data not available', ha='center', va='center', fontsize=14)
    ax.set_axis_off()
    plt.show()
```

\newpage

### Spatial Autocorrelation Summary - All Diseases

```{python}
#| label: tbl-all-diseases-moran
#| tbl-cap: "Spatial Autocorrelation (Moran's I) - All Diseases"
#| tbl-cap-location: bottom

if has_spatial_data:
    moran_summary = []
    
    for icd in icd_codes_in_rm:
        if icd in disease_moran:
            m = disease_moran[icd]
            moran_summary.append({
                'ICD Code': icd,
                'Description': ALL_NEURODEG_CODES.get(icd, 'Unknown')[:40],
                "Moran's I": round(m.I, 4),
                'Z-score': round(m.z_norm, 4),
                'P-value': round(m.p_norm, 4),
                'Pattern': 'Clustered' if m.I > 0 and m.p_norm < 0.05 else ('Dispersed' if m.I < 0 and m.p_norm < 0.05 else 'Random'),
                'Significant': 'Yes' if m.p_norm < 0.05 else 'No'
            })
    
    if moran_summary:
        moran_summary_df = pd.DataFrame(moran_summary)
        moran_summary_df = moran_summary_df.sort_values("Moran's I", ascending=False)
        display(moran_summary_df.style.format({
            "Moran's I": '{:.4f}',
            'Z-score': '{:.4f}',
            'P-value': '{:.4f}'
        }).hide(axis="index"))
    else:
        display(pd.DataFrame({'Message': ['No Moran statistics available']}).style.hide(axis="index"))
else:
    display(pd.DataFrame({'Message': ['Spatial analysis not available']}).style.hide(axis="index"))
```

```{python}
#| label: fig-moran-comparison
#| fig-cap: "Moran's I Comparison Across Diseases"
#| fig-width: 14
#| fig-height: 6

if has_spatial_data and len(disease_moran) > 0:
    fig, axes = plt.subplots(1, 2, figsize=(14, 6))
    
    # Moran's I values
    ax1 = axes[0]
    moran_vals = [(icd, disease_moran[icd].I, disease_moran[icd].p_norm) for icd in disease_moran]
    moran_vals.sort(key=lambda x: x[1], reverse=True)
    
    codes = [x[0] for x in moran_vals]
    i_vals = [x[1] for x in moran_vals]
    p_vals = [x[2] for x in moran_vals]
    
    colors = ['darkgreen' if p < 0.05 and i > 0 else ('darkred' if p < 0.05 and i < 0 else 'gray') 
              for i, p in zip(i_vals, p_vals)]
    
    ax1.barh(codes, i_vals, color=colors)
    ax1.axvline(x=0, color='black', linestyle='-', linewidth=0.5)
    ax1.set_xlabel("Moran's I")
    ax1.set_title("Moran's I by Disease\n(Green=Clustered, Red=Dispersed, Gray=Random)", fontweight='bold')
    ax1.grid(True, alpha=0.3, axis='x')
    
    # P-values
    ax2 = axes[1]
    ax2.barh(codes, [-np.log10(p) if p > 0 else 0 for p in p_vals], color='steelblue')
    ax2.axvline(x=-np.log10(0.05), color='red', linestyle='--', linewidth=2, label='p=0.05')
    ax2.set_xlabel('-log10(P-value)')
    ax2.set_title('Statistical Significance\n(Values above red line are significant)', fontweight='bold')
    ax2.legend()
    ax2.grid(True, alpha=0.3, axis='x')
    
    plt.tight_layout()
    save_figure(fig, 'moran_comparison_diseases.png')
    plt.show()
else:
    fig, ax = plt.subplots(figsize=(8, 6))
    ax.text(0.5, 0.5, 'Insufficient data for Moran comparison', ha='center', va='center', fontsize=14)
    ax.set_axis_off()
    plt.show()
```

### Disease-Specific Summary Statistics

```{python}
#| label: tbl-disease-spatial-summary
#| tbl-cap: "Disease-Specific Spatial Analysis Summary"
#| tbl-cap-location: bottom

if has_spatial_data:
    summary_data = []
    
    for icd in icd_codes_in_rm:
        if icd in disease_gdf:
            gdf = disease_gdf[icd]
            asr_data = disease_asr_by_comuna[icd]
            
            row = {
                'ICD': icd,
                'Disease': ALL_NEURODEG_CODES.get(icd, 'Unknown')[:30],
                'Total Hosp.': asr_data['hospitalizations'].sum() if len(asr_data) > 0 else 0,
                'Comunas': len(asr_data[asr_data['hospitalizations'] > 0]) if len(asr_data) > 0 else 0,
                'Mean ASR': asr_data['asr'].mean().round(2) if len(asr_data) > 0 else 0,
                'Max ASR': asr_data['asr'].max() if len(asr_data) > 0 else 0,
            }
            
            if icd in disease_moran:
                m = disease_moran[icd]
                row["Moran's I"] = round(m.I, 4)
                row['P-value'] = round(m.p_norm, 4)
                row['Pattern'] = 'Clustered' if m.I > 0 and m.p_norm < 0.05 else ('Dispersed' if m.I < 0 and m.p_norm < 0.05 else 'Random')
            else:
                row["Moran's I"] = None
                row['P-value'] = None
                row['Pattern'] = 'N/A'
            
            if icd in disease_lisa:
                lisa = disease_lisa[icd]
                clusters = clasificar_lisa(lisa, gdf)
                row['Hot Spots'] = clusters.count('High-High (Hot Spot)')
                row['Cold Spots'] = clusters.count('Low-Low (Cold Spot)')
            else:
                row['Hot Spots'] = 0
                row['Cold Spots'] = 0
            
            summary_data.append(row)
    
    if summary_data:
        summary_df = pd.DataFrame(summary_data)
        summary_df = summary_df.sort_values('Total Hosp.', ascending=False)
        display(summary_df.style.format({
            'Total Hosp.': '{:,.0f}',
            'Mean ASR': '{:.2f}',
            'Max ASR': '{:.2f}',
            "Moran's I": '{:.4f}',
            'P-value': '{:.4f}'
        }, na_rep='-').hide(axis="index"))
    else:
        display(pd.DataFrame({'Message': ['No summary data available']}).style.hide(axis="index"))
else:
    display(pd.DataFrame({'Message': ['Spatial analysis not available']}).style.hide(axis="index"))
```
