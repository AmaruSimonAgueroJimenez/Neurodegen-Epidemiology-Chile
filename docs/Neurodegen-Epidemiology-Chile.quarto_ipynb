{
  "cells": [
    {
      "cell_type": "markdown",
      "metadata": {},
      "source": [
        "---\n",
        "title: \"Neurodegenerative Diseases\"\n",
        "author:\n",
        "  - name: \"Carolina Macarena Concha Ramírez\"\n",
        "    email: \"carconchar@miaundes.cl\"\n",
        "    orcid: \"0000-0002-5862-6247\"\n",
        "  - name: \"Amaru Simón Agüero Jiménez\"\n",
        "    email: \"a.agueroj@udd.cl\"\n",
        "    orcid: \"0000-0001-7336-1833\"\n",
        "date: \"today\"\n",
        "format:\n",
        "  html:\n",
        "    embed-resources: false\n",
        "    smooth-scroll: true #smooth mouse scroll\n",
        "    toc: true #table of contents\n",
        "    toc-depth: 6 #table of contents depth\n",
        "    toc-location: right #table of contents location\n",
        "    number-sections: true #section numbering according to table of contents\n",
        "    number-depth: 6 #numbering depth\n",
        "    code-fold: true #fold code cells\n",
        "    #bibliography: ref.bib #bibliography file\n",
        "    #csl: apa.csl #citation style\n",
        "    theme: cosmo #html theme\n",
        "    fig-cap-location: bottom #figure caption location (top/bottom)\n",
        "execute:\n",
        "  warning: false #suppress warnings in chunks\n",
        "  message: false #suppress messages in chunks\n",
        "  fig-width: 12 #default figure width\n",
        "  fig-height: 10 #default figure height\n",
        "---\n",
        "\n",
        "# Results - Neurodegenerative Diseases Analysis"
      ],
      "id": "9f689758"
    },
    {
      "cell_type": "code",
      "metadata": {},
      "source": [
        "#| label: setup\n",
        "#| include: false\n",
        "\n",
        "import sys\n",
        "import subprocess\n",
        "import importlib\n",
        "\n",
        "def _pip_install(requirement: str):\n",
        "    # Instala en el MISMO Python que está usando Quarto (sys.executable)\n",
        "    subprocess.check_call([sys.executable, \"-m\", \"pip\", \"install\", \"--upgrade\", requirement])\n",
        "\n",
        "# `packaging` permite interpretar \"pyarrow>=X\" de forma robusta\n",
        "try:\n",
        "    from packaging.requirements import Requirement\n",
        "except Exception:\n",
        "    _pip_install(\"packaging\")\n",
        "    from packaging.requirements import Requirement\n",
        "\n",
        "def ensure(requirement: str, import_name: str = None):\n",
        "    req = Requirement(requirement)\n",
        "    name = import_name or req.name\n",
        "    try:\n",
        "        mod = importlib.import_module(name)\n",
        "        ver = getattr(mod, \"__version__\", None)\n",
        "        if ver is not None and req.specifier and not req.specifier.contains(ver, prereleases=True):\n",
        "            raise ImportError(f\"{name} {ver} no cumple {req.specifier}\")\n",
        "        return mod\n",
        "    except Exception:\n",
        "        _pip_install(requirement)\n",
        "        return importlib.import_module(name)\n",
        "\n",
        "# Dependencias principales\n",
        "ensure(\"numpy\")\n",
        "ensure(\"scipy\")\n",
        "ensure(\"pandas>=2.0.0\", \"pandas\")\n",
        "\n",
        "# Parquet (clave)\n",
        "ensure(\"pyarrow>=10.0.0\", \"pyarrow\")\n",
        "\n",
        "# Otros\n",
        "ensure(\"matplotlib\")\n",
        "ensure(\"seaborn\")\n",
        "ensure(\"requests\")\n",
        "\n",
        "# Geoespacial\n",
        "ensure(\"geopandas\")\n",
        "ensure(\"libpysal\")\n",
        "ensure(\"esda\")\n",
        "ensure(\"splot\")\n",
        "\n",
        "# (opcional) imprime el entorno real usado por Quarto\n",
        "import pyarrow\n",
        "import pandas as pd\n",
        "import numpy as np\n",
        "import os\n",
        "import glob\n",
        "import warnings\n",
        "from collections import Counter\n",
        "from typing import Dict, List\n",
        "import matplotlib.pyplot as plt\n",
        "import seaborn as sns\n",
        "import geopandas as gpd\n",
        "\n",
        "warnings.filterwarnings('ignore')\n",
        "plt.rcParams['figure.dpi'] = 100\n",
        "plt.rcParams['savefig.dpi'] = 150\n",
        "sns.set_style(\"whitegrid\")\n",
        "pd.set_option('display.max_columns', None)\n",
        "pd.set_option('display.precision', 2)\n",
        "\n",
        "base_path = os.path.dirname(os.getcwd())\n",
        "data_path = os.path.join(base_path, 'data')\n",
        "output_path = os.path.join(base_path, 'output_files')\n",
        "figures_path = os.path.join(output_path, 'figures')\n",
        "\n",
        "os.makedirs(output_path, exist_ok=True)\n",
        "os.makedirs(figures_path, exist_ok=True)"
      ],
      "id": "setup",
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "code",
      "metadata": {},
      "source": [
        "#| label: constants\n",
        "#| include: false\n",
        "\n",
        "WHO_STANDARD_POPULATION = {\n",
        "    '0-4': 8860, '5-9': 8690, '10-14': 8600, '15-19': 8470,\n",
        "    '20-24': 8220, '25-29': 7930, '30-34': 7610, '35-39': 7150,\n",
        "    '40-44': 6590, '45-49': 6040, '50-54': 5370, '55-59': 4550,\n",
        "    '60-64': 3720, '65-69': 2960, '70-74': 2210, '75-79': 1520,\n",
        "    '80+': 1540  # Suma de 80-84(910) + 85-89(440) + 90-94(150) + 95-99(40)\n",
        "}\n",
        "\n",
        "TOTAL_WHO_WEIGHT = sum(WHO_STANDARD_POPULATION.values())\n",
        "\n",
        "NEURODEG_CODES_MAIN = {\n",
        "    'F00': 'Dementia in Alzheimer disease',\n",
        "    'F01': 'Vascular dementia',\n",
        "    'F02': 'Dementia in other diseases classified elsewhere',\n",
        "    'F03': 'Unspecified dementia',\n",
        "    'F04': 'Organic amnesic syndrome',\n",
        "    'F06': 'Other mental disorders due to brain damage',\n",
        "    'F07': 'Personality and behavioural disorders due to brain disease'\n",
        "}\n",
        "\n",
        "NEURODEG_CODES_OTHER = {\n",
        "    'G20': 'Parkinson disease',\n",
        "    'G21': 'Secondary parkinsonism',\n",
        "    'G23': 'Other degenerative diseases of basal ganglia',\n",
        "    'G30': 'Alzheimer disease',\n",
        "    'G31': 'Other degenerative diseases of nervous system',\n",
        "    'G35': 'Multiple sclerosis',\n",
        "    'G10': 'Huntington disease',\n",
        "    'G11': 'Hereditary ataxia',\n",
        "    'G12': 'Spinal muscular atrophy'\n",
        "}\n",
        "\n",
        "ALL_NEURODEG_CODES = {**NEURODEG_CODES_MAIN, **NEURODEG_CODES_OTHER}\n",
        "\n",
        "AGE_GROUPS_TUPLES = [\n",
        "    (0, 4), (5, 9), (10, 14), (15, 19), (20, 24), (25, 29),\n",
        "    (30, 34), (35, 39), (40, 44), (45, 49), (50, 54), (55, 59),\n",
        "    (60, 64), (65, 69), (70, 74), (75, 79)\n",
        "]\n",
        "\n",
        "YEARS = [2019, 2020, 2021, 2022, 2023, 2024]"
      ],
      "id": "constants",
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "code",
      "metadata": {},
      "source": [
        "#| label: functions\n",
        "#| include: false\n",
        "\n",
        "def assign_age_group(age):\n",
        "    if pd.isna(age) or age is None:\n",
        "        return None\n",
        "    try:\n",
        "        age = int(float(age))\n",
        "    except (ValueError, TypeError):\n",
        "        return None\n",
        "    if age < 0:\n",
        "        return None\n",
        "    if age >= 80:\n",
        "        return '80+'\n",
        "    for start, end in AGE_GROUPS_TUPLES:\n",
        "        if start <= age <= end:\n",
        "            return f\"{start}-{end}\"\n",
        "    return None\n",
        "\n",
        "\n",
        "def parse_date(date_str, year=None):\n",
        "    \"\"\"Parse date handling multiple formats.\"\"\"\n",
        "    if pd.isna(date_str) or date_str == '':\n",
        "        return pd.NaT\n",
        "    \n",
        "    date_str = str(date_str).strip()\n",
        "    \n",
        "    # Try YYYY-MM-DD format first (2024 format)\n",
        "    try:\n",
        "        return pd.to_datetime(date_str, format='%Y-%m-%d')\n",
        "    except:\n",
        "        pass\n",
        "    \n",
        "    # Try DD-MM-YYYY format (2023 format)\n",
        "    try:\n",
        "        return pd.to_datetime(date_str, format='%d-%m-%Y')\n",
        "    except:\n",
        "        pass\n",
        "    \n",
        "    # Fall back to pandas parser\n",
        "    try:\n",
        "        return pd.to_datetime(date_str)\n",
        "    except:\n",
        "        return pd.NaT\n",
        "\n",
        "\n",
        "def calculate_age(birth_date_str, admission_date_str, year=None):\n",
        "    \"\"\"Calculate age from birth date and admission date.\"\"\"\n",
        "    birth_date = parse_date(birth_date_str)\n",
        "    admission_date = parse_date(admission_date_str, year)\n",
        "    \n",
        "    if pd.isna(birth_date) or pd.isna(admission_date):\n",
        "        return None\n",
        "    \n",
        "    age = (admission_date - birth_date).days / 365.25\n",
        "    \n",
        "    if age < 0 or age > 120:\n",
        "        return None\n",
        "    \n",
        "    return int(round(age))\n",
        "\n",
        "\n",
        "def has_neurodeg_diagnosis(row, diag_cols, target_codes):\n",
        "    \"\"\"Check if patient has any neurodegenerative diagnosis.\"\"\"\n",
        "    for col in diag_cols:\n",
        "        v = row.get(col)\n",
        "        if pd.notna(v) and v != '':\n",
        "            code = str(v).upper().strip().replace('.', '')[:3]\n",
        "            if code in target_codes:\n",
        "                return True\n",
        "    return False\n",
        "\n",
        "\n",
        "def get_neurodeg_codes_from_row(row, diag_cols, target_codes):\n",
        "    \"\"\"Extract all neurodegenerative codes from a row.\"\"\"\n",
        "    codes_found = set()\n",
        "    for col in diag_cols:\n",
        "        v = row.get(col)\n",
        "        if pd.notna(v) and v != '':\n",
        "            code = str(v).upper().strip().replace('.', '')[:3]\n",
        "            if code in target_codes:\n",
        "                codes_found.add(code)\n",
        "    return codes_found\n",
        "\n",
        "\n",
        "def load_and_filter_neurodeg_data(years=YEARS, use_main=True, use_other=True, chunksize=100000):\n",
        "    \"\"\"Load and filter data for neurodegenerative diseases.\"\"\"\n",
        "    \n",
        "    target_codes = set()\n",
        "    if use_main:\n",
        "        target_codes.update(NEURODEG_CODES_MAIN.keys())\n",
        "    if use_other:\n",
        "        target_codes.update(NEURODEG_CODES_OTHER.keys())\n",
        "    \n",
        "    all_records = []\n",
        "    \n",
        "    for year in years:\n",
        "        pattern = f\"GRD_PUBLICO_*{year}*.csv\"\n",
        "        files = glob.glob(os.path.join(data_path, pattern))\n",
        "        \n",
        "        if not files:\n",
        "            continue\n",
        "        \n",
        "        for chunk in pd.read_csv(files[0], delimiter='|', dtype=str, \n",
        "                                  low_memory=False, chunksize=chunksize):\n",
        "            \n",
        "            diag_cols = [col for col in chunk.columns if col.startswith('DIAGNOSTICO')]\n",
        "            \n",
        "            if not diag_cols:\n",
        "                continue\n",
        "            \n",
        "            # Filter rows with neurodegenerative diagnosis\n",
        "            mask = chunk.apply(lambda row: has_neurodeg_diagnosis(row, diag_cols, target_codes), axis=1)\n",
        "            chunk_filtered = chunk[mask]\n",
        "            \n",
        "            if chunk_filtered.empty:\n",
        "                continue\n",
        "            \n",
        "            for _, row in chunk_filtered.iterrows():\n",
        "                codes_found = get_neurodeg_codes_from_row(row, diag_cols, target_codes)\n",
        "                \n",
        "                # Calculate age from FECHA_NACIMIENTO and FECHA_INGRESO\n",
        "                age = calculate_age(\n",
        "                    row.get('FECHA_NACIMIENTO'),\n",
        "                    row.get('FECHA_INGRESO'),\n",
        "                    year\n",
        "                )\n",
        "                \n",
        "                # Get sex\n",
        "                sex = None\n",
        "                sex_val = str(row.get('SEXO', '')).strip().upper()\n",
        "                if sex_val == '1' or sex_val == 'HOMBRE':\n",
        "                    sex = 'Male'\n",
        "                elif sex_val == '2' or sex_val == 'MUJER':\n",
        "                    sex = 'Female'\n",
        "                \n",
        "                age_group = assign_age_group(age)\n",
        "                \n",
        "                for code in codes_found:\n",
        "                    all_records.append({\n",
        "                        'year': year,\n",
        "                        'age': age,\n",
        "                        'age_group': age_group,\n",
        "                        'sex': sex,\n",
        "                        'icd_code': code\n",
        "                    })\n",
        "    \n",
        "    if not all_records:\n",
        "        return pd.DataFrame(columns=['year', 'age', 'age_group', 'sex', 'icd_code', 'hospitalizations'])\n",
        "    \n",
        "    df = pd.DataFrame(all_records)\n",
        "    \n",
        "    # Aggregate counts\n",
        "    df_counts = df.groupby(['year', 'age_group', 'sex', 'icd_code']).size().reset_index(name='hospitalizations')\n",
        "    \n",
        "    return df_counts\n",
        "\n",
        "\n",
        "\n",
        "\n",
        "# -----------------------------------------------------------------------------\n",
        "# Population denominators (INE projections) - local parquet\n",
        "# -----------------------------------------------------------------------------\n",
        "# This project now uses the local INE projections file:\n",
        "#   censo_proyecciones_ano_edad_genero.parquet\n",
        "# (or the same name with \"año\" instead of \"ano\")\n",
        "# to build 5-year age groups and sex denominators (2019-2024).\n",
        "\n",
        "\n",
        "def _normalize_txt(x):\n",
        "    \"\"\"Lowercase + trim + remove Spanish accents (safe for matching).\"\"\"\n",
        "    if pd.isna(x):\n",
        "        return None\n",
        "    s = str(x).strip().lower()\n",
        "    repl = str.maketrans({\n",
        "        'á': 'a', 'é': 'e', 'í': 'i', 'ó': 'o', 'ú': 'u',\n",
        "        'ñ': 'n'\n",
        "    })\n",
        "    return s.translate(repl)\n",
        "\n",
        "\n",
        "def _standardize_sex(x):\n",
        "    \"\"\"Map INE/Spanish sex labels to {Male, Female}.\"\"\"\n",
        "    if pd.isna(x):\n",
        "        return None\n",
        "    v = _normalize_txt(x)\n",
        "    if v is None:\n",
        "        return None\n",
        "\n",
        "    v = v.replace('.', '').replace('-', ' ').replace('_', ' ').strip()\n",
        "\n",
        "    # Common encodings\n",
        "    male_vals = {'1', 'm', 'male', 'masculino', 'hombre', 'hombres', 'varon', 'varones'}\n",
        "    female_vals = {'2', 'f', 'female', 'femenino', 'mujer', 'mujeres'}\n",
        "\n",
        "    if v in male_vals:\n",
        "        return 'Male'\n",
        "    if v in female_vals:\n",
        "        return 'Female'\n",
        "\n",
        "    return None\n",
        "\n",
        "\n",
        "def _find_first_existing(paths):\n",
        "    for p in paths:\n",
        "        if p and os.path.exists(p):\n",
        "            return p\n",
        "    return None\n",
        "\n",
        "\n",
        "PARQUET_TO_STANDARD_REGION = {\n",
        "    'Arica y Parinacota': 'Arica y Parinacota',\n",
        "    'Tarapacá': 'Tarapacá',\n",
        "    'Antofagasta': 'Antofagasta',\n",
        "    'Atacama': 'Atacama',\n",
        "    'Coquimbo': 'Coquimbo',\n",
        "    'Valparaíso': 'Valparaíso',\n",
        "    'Metropolitana de Santiago': 'Metropolitana',\n",
        "    \"Libertador General Bernardo O'Higgins\": \"O'Higgins\",\n",
        "    'Maule': 'Maule',\n",
        "    'Ñuble': 'Ñuble',\n",
        "    'Biobío': 'Biobío',\n",
        "    'La Araucanía': 'La Araucanía',\n",
        "    'Los Ríos': 'Los Ríos',\n",
        "    'Los Lagos': 'Los Lagos',\n",
        "    'Aysén del General Carlos Ibáñez del Campo': 'Aysén',\n",
        "    'Magallanes y de la Antártica Chilena': 'Magallanes'\n",
        "}\n",
        "\n",
        "\n",
        "def normalize_region_to_standard(region_name):\n",
        "    \"\"\"Normaliza nombres de región del parquet al formato estándar del código.\"\"\"\n",
        "    if pd.isna(region_name):\n",
        "        return None\n",
        "    name = str(region_name).strip()\n",
        "    return PARQUET_TO_STANDARD_REGION.get(name, name)\n",
        "\n",
        "\n",
        "def load_population_data(years=YEARS, verbose=False):\n",
        "    \"\"\"\n",
        "    Load INE population projections by comuna, single-year age and sex from\n",
        "    `censo_proyecciones_ano_edad_genero.parquet` and aggregate to 5-year age groups.\n",
        "\n",
        "    Returns a DataFrame with at least:\n",
        "      - year, age_group, sex, population\n",
        "\n",
        "    If available in the source, also keeps:\n",
        "      - region, comuna\n",
        "\n",
        "    NOTE: Reading Parquet requires `pyarrow` (recommended) or `fastparquet`.\n",
        "    \"\"\"\n",
        "\n",
        "    candidate_paths = [\n",
        "        os.path.join(data_path, 'censo_proyecciones_ano_edad_genero.parquet'),\n",
        "        os.path.join(data_path, 'censo_proyecciones_año_edad_genero.parquet'),\n",
        "        os.path.join(base_path, 'censo_proyecciones_ano_edad_genero.parquet'),\n",
        "        os.path.join(base_path, 'censo_proyecciones_año_edad_genero.parquet'),\n",
        "        os.path.join(os.getcwd(), 'censo_proyecciones_ano_edad_genero.parquet'),\n",
        "        os.path.join(os.getcwd(), 'censo_proyecciones_año_edad_genero.parquet'),\n",
        "        '/mnt/data/censo_proyecciones_ano_edad_genero.parquet',\n",
        "        '/mnt/data/censo_proyecciones_año_edad_genero.parquet'\n",
        "    ]\n",
        "\n",
        "    pop_file = _find_first_existing(candidate_paths)\n",
        "\n",
        "    if pop_file is None:\n",
        "        # Recursive search as a last resort\n",
        "        patterns = [\n",
        "            os.path.join(data_path, '**', 'censo_proyecciones*edad_genero*.parquet'),\n",
        "            os.path.join(base_path, '**', 'censo_proyecciones*edad_genero*.parquet'),\n",
        "            os.path.join(os.getcwd(), '**', 'censo_proyecciones*edad_genero*.parquet')\n",
        "        ]\n",
        "        matches = []\n",
        "        for pat in patterns:\n",
        "            matches.extend(glob.glob(pat, recursive=True))\n",
        "        pop_file = matches[0] if matches else None\n",
        "\n",
        "    if pop_file is None:\n",
        "        raise FileNotFoundError(\n",
        "            \"No se encontró `censo_proyecciones_ano_edad_genero.parquet` (ni `censo_proyecciones_año_edad_genero.parquet`). \"\n",
        "            \"Coloca el archivo en la carpeta `data/` o en el mismo directorio del .qmd.\"\n",
        "        )\n",
        "\n",
        "    # Read parquet\n",
        "    try:\n",
        "        df = pd.read_parquet(pop_file, engine=\"pyarrow\")\n",
        "    except Exception as e_pyarrow:\n",
        "        # Intentar fastparquet como alternativa\n",
        "        try:\n",
        "            ensure(\"fastparquet>=2023.0.0\", \"fastparquet\")\n",
        "            df = pd.read_parquet(pop_file, engine=\"fastparquet\")\n",
        "        except Exception as e_fast:\n",
        "            raise RuntimeError(\n",
        "                f\"No se pudo leer el archivo Parquet: {pop_file}.\\n\"\n",
        "                \"Soluciones recomendadas (en el MISMO entorno de Python que usa Quarto):\\n\"\n",
        "                \"  1) Actualiza pyarrow: `python -m pip install -U pyarrow`\\n\"\n",
        "                \"  2) O instala fastparquet: `python -m pip install -U fastparquet`\\n\"\n",
        "                \"Si Quarto usa otro Python, revisa `quarto check python`.\\n\\n\"\n",
        "                f\"Error con pyarrow: {e_pyarrow}\\n\"\n",
        "                f\"Error con fastparquet: {e_fast}\"\n",
        "            )\n",
        "\n",
        "    if verbose:\n",
        "        print('Loaded population parquet:', pop_file)\n",
        "        print('Columns:', df.columns.tolist())\n",
        "\n",
        "    # Column discovery (handle accents)\n",
        "    df.columns = [str(c).strip() for c in df.columns]\n",
        "    cols_norm = {_normalize_txt(c): c for c in df.columns}\n",
        "\n",
        "    year_col = cols_norm.get('ano') or cols_norm.get('anio') or cols_norm.get('year')\n",
        "    age_col = cols_norm.get('edad') or cols_norm.get('age')\n",
        "    sex_col = cols_norm.get('genero') or cols_norm.get('sexo') or cols_norm.get('sex') or cols_norm.get('gender')\n",
        "    pop_col = cols_norm.get('poblacion') or cols_norm.get('population')\n",
        "\n",
        "    region_col = cols_norm.get('region')\n",
        "    comuna_col = cols_norm.get('comuna')\n",
        "\n",
        "    required = {'year': year_col, 'age': age_col, 'sex': sex_col, 'population': pop_col}\n",
        "    missing = [k for k, v in required.items() if v is None]\n",
        "\n",
        "    if missing:\n",
        "        raise ValueError(\n",
        "            f\"El archivo de población no contiene las columnas necesarias: {missing}. \"\n",
        "            f\"Columnas encontradas: {df.columns.tolist()}\"\n",
        "        )\n",
        "\n",
        "    keep_cols = [year_col, age_col, sex_col, pop_col]\n",
        "    if region_col is not None:\n",
        "        keep_cols.append(region_col)\n",
        "    if comuna_col is not None:\n",
        "        keep_cols.append(comuna_col)\n",
        "\n",
        "    pop = df[keep_cols].copy()\n",
        "\n",
        "    rename_map = {\n",
        "        year_col: 'year',\n",
        "        age_col: 'age',\n",
        "        sex_col: 'sex',\n",
        "        pop_col: 'population'\n",
        "    }\n",
        "    if region_col is not None:\n",
        "        rename_map[region_col] = 'region'\n",
        "    if comuna_col is not None:\n",
        "        rename_map[comuna_col] = 'comuna'\n",
        "\n",
        "    pop.rename(columns=rename_map, inplace=True)\n",
        "\n",
        "    # Types + filters\n",
        "    pop['year'] = pd.to_numeric(pop['year'], errors='coerce').astype('Int64')\n",
        "    pop = pop[pop['year'].isin(years)]\n",
        "\n",
        "    pop['population'] = pd.to_numeric(pop['population'], errors='coerce')\n",
        "    pop['sex'] = pop['sex'].apply(_standardize_sex)\n",
        "\n",
        "    # Build 5-year age groups from single-year age\n",
        "    pop['age_group'] = pop['age'].apply(assign_age_group)\n",
        "\n",
        "    # Clean\n",
        "    pop = pop.dropna(subset=['year', 'sex', 'age_group', 'population'])\n",
        "    pop = pop[pop['population'] > 0]\n",
        "\n",
        "    # Normalizar nombres de región si existe la columna\n",
        "    if 'region' in pop.columns:\n",
        "        pop['region'] = pop['region'].apply(normalize_region_to_standard)\n",
        "\n",
        "    # Aggregate to 5-year groups (keep region/comuna if available)\n",
        "    group_cols = [c for c in ['region', 'comuna', 'year', 'age_group', 'sex'] if c in pop.columns]\n",
        "    pop_agg = pop.groupby(group_cols, as_index=False)['population'].sum()\n",
        "\n",
        "    return pop_agg\n",
        "\n",
        "\n",
        "\n",
        "def calculate_asr_by_sex(hosp, pop, per=100000):\n",
        "    \"\"\"Age-standardized rates by sex.\"\"\"\n",
        "    who_weights = pd.DataFrame([\n",
        "        {'age_group': k, 'who_weight': v} for k, v in WHO_STANDARD_POPULATION.items()\n",
        "    ])\n",
        "    \n",
        "    hosp_agg = hosp.groupby(['year', 'age_group', 'sex'])['hospitalizations'].sum().reset_index()\n",
        "    pop_agg = pop.groupby(['year', 'age_group', 'sex'])['population'].sum().reset_index()\n",
        "    \n",
        "    merged = hosp_agg.merge(pop_agg, on=['year', 'age_group', 'sex'], how='left')\n",
        "    merged['age_specific_rate'] = (merged['hospitalizations'] / merged['population']) * per\n",
        "    merged = merged.merge(who_weights, on='age_group', how='left')\n",
        "    merged['weighted_rate'] = merged['age_specific_rate'] * merged['who_weight']\n",
        "    \n",
        "    result = merged.groupby(['year', 'sex']).agg({\n",
        "        'hospitalizations': 'sum',\n",
        "        'population': 'sum',\n",
        "        'weighted_rate': 'sum'\n",
        "    }).reset_index()\n",
        "    \n",
        "    result['crude_rate'] = ((result['hospitalizations'] / result['population']) * per).round(2)\n",
        "    result['asr'] = (result['weighted_rate'] / TOTAL_WHO_WEIGHT).round(2)\n",
        "    result.drop(columns=['weighted_rate'], inplace=True)\n",
        "    \n",
        "    return result[['year', 'sex', 'hospitalizations', 'population', 'crude_rate', 'asr']]\n",
        "\n",
        "\n",
        "def calculate_asr_sex_columns(hosp, pop, per=100000):\n",
        "    \"\"\"Age-standardized rates with sex as columns.\"\"\"\n",
        "    who_weights = pd.DataFrame([\n",
        "        {'age_group': k, 'who_weight': v} for k, v in WHO_STANDARD_POPULATION.items()\n",
        "    ])\n",
        "    \n",
        "    # By sex\n",
        "    hosp_agg = hosp.groupby(['year', 'age_group', 'sex'])['hospitalizations'].sum().reset_index()\n",
        "    pop_agg = pop.groupby(['year', 'age_group', 'sex'])['population'].sum().reset_index()\n",
        "    \n",
        "    merged = hosp_agg.merge(pop_agg, on=['year', 'age_group', 'sex'], how='left')\n",
        "    merged['age_specific_rate'] = (merged['hospitalizations'] / merged['population']) * per\n",
        "    merged = merged.merge(who_weights, on='age_group', how='left')\n",
        "    merged['weighted_rate'] = merged['age_specific_rate'] * merged['who_weight']\n",
        "    \n",
        "    by_sex = merged.groupby(['year', 'sex']).agg({\n",
        "        'hospitalizations': 'sum',\n",
        "        'population': 'sum',\n",
        "        'weighted_rate': 'sum'\n",
        "    }).reset_index()\n",
        "    \n",
        "    by_sex['crude_rate'] = ((by_sex['hospitalizations'] / by_sex['population']) * per).round(2)\n",
        "    by_sex['asr'] = (by_sex['weighted_rate'] / TOTAL_WHO_WEIGHT).round(2)\n",
        "    \n",
        "    # Total (both sexes)\n",
        "    hosp_total = hosp.groupby(['year', 'age_group'])['hospitalizations'].sum().reset_index()\n",
        "    pop_total = pop.groupby(['year', 'age_group'])['population'].sum().reset_index()\n",
        "    \n",
        "    merged_total = hosp_total.merge(pop_total, on=['year', 'age_group'], how='left')\n",
        "    merged_total['age_specific_rate'] = (merged_total['hospitalizations'] / merged_total['population']) * per\n",
        "    merged_total = merged_total.merge(who_weights, on='age_group', how='left')\n",
        "    merged_total['weighted_rate'] = merged_total['age_specific_rate'] * merged_total['who_weight']\n",
        "    \n",
        "    total_agg = merged_total.groupby('year').agg({\n",
        "        'hospitalizations': 'sum',\n",
        "        'population': 'sum',\n",
        "        'weighted_rate': 'sum'\n",
        "    }).reset_index()\n",
        "    \n",
        "    total_agg['crude_rate'] = ((total_agg['hospitalizations'] / total_agg['population']) * per).round(2)\n",
        "    total_agg['asr'] = (total_agg['weighted_rate'] / TOTAL_WHO_WEIGHT).round(2)\n",
        "    \n",
        "    # Pivot to columns\n",
        "    male = by_sex[by_sex['sex'] == 'Male'][['year', 'hospitalizations', 'population', 'crude_rate', 'asr']].copy()\n",
        "    male.columns = ['year', 'hosp_male', 'pop_male', 'crude_rate_male', 'asr_male']\n",
        "    \n",
        "    female = by_sex[by_sex['sex'] == 'Female'][['year', 'hospitalizations', 'population', 'crude_rate', 'asr']].copy()\n",
        "    female.columns = ['year', 'hosp_female', 'pop_female', 'crude_rate_female', 'asr_female']\n",
        "    \n",
        "    total = total_agg[['year', 'hospitalizations', 'population', 'crude_rate', 'asr']].copy()\n",
        "    total.columns = ['year', 'hosp_total', 'pop_total', 'crude_rate_total', 'asr_total']\n",
        "    \n",
        "    result = male.merge(female, on='year', how='outer').merge(total, on='year', how='outer')\n",
        "    result.sort_values('year', inplace=True)\n",
        "    result.reset_index(drop=True, inplace=True)\n",
        "    \n",
        "    return result\n",
        "\n",
        "\n",
        "def calculate_asr_by_icd(hosp, pop, per=100000):\n",
        "    \"\"\"Age-standardized rates by ICD code with sex columns.\"\"\"\n",
        "    who_weights = pd.DataFrame([\n",
        "        {'age_group': k, 'who_weight': v} for k, v in WHO_STANDARD_POPULATION.items()\n",
        "    ])\n",
        "    \n",
        "    # By sex and ICD\n",
        "    hosp_agg = hosp.groupby(['year', 'age_group', 'sex', 'icd_code'])['hospitalizations'].sum().reset_index()\n",
        "    pop_agg = pop.groupby(['year', 'age_group', 'sex'])['population'].sum().reset_index()\n",
        "    \n",
        "    merged = hosp_agg.merge(pop_agg, on=['year', 'age_group', 'sex'], how='left')\n",
        "    merged['age_specific_rate'] = (merged['hospitalizations'] / merged['population']) * per\n",
        "    merged = merged.merge(who_weights, on='age_group', how='left')\n",
        "    merged['weighted_rate'] = merged['age_specific_rate'] * merged['who_weight']\n",
        "    \n",
        "    by_sex = merged.groupby(['year', 'icd_code', 'sex']).agg({\n",
        "        'hospitalizations': 'sum',\n",
        "        'weighted_rate': 'sum'\n",
        "    }).reset_index()\n",
        "    by_sex['asr'] = (by_sex['weighted_rate'] / TOTAL_WHO_WEIGHT).round(2)\n",
        "    \n",
        "    # Total by ICD\n",
        "    hosp_total = hosp.groupby(['year', 'age_group', 'icd_code'])['hospitalizations'].sum().reset_index()\n",
        "    pop_total = pop.groupby(['year', 'age_group'])['population'].sum().reset_index()\n",
        "    \n",
        "    merged_total = hosp_total.merge(pop_total, on=['year', 'age_group'], how='left')\n",
        "    merged_total['age_specific_rate'] = (merged_total['hospitalizations'] / merged_total['population']) * per\n",
        "    merged_total = merged_total.merge(who_weights, on='age_group', how='left')\n",
        "    merged_total['weighted_rate'] = merged_total['age_specific_rate'] * merged_total['who_weight']\n",
        "    \n",
        "    total_agg = merged_total.groupby(['year', 'icd_code']).agg({\n",
        "        'hospitalizations': 'sum',\n",
        "        'weighted_rate': 'sum'\n",
        "    }).reset_index()\n",
        "    total_agg['asr'] = (total_agg['weighted_rate'] / TOTAL_WHO_WEIGHT).round(2)\n",
        "    \n",
        "    # Pivot\n",
        "    male = by_sex[by_sex['sex'] == 'Male'][['year', 'icd_code', 'hospitalizations', 'asr']].copy()\n",
        "    male.columns = ['year', 'icd_code', 'hosp_male', 'asr_male']\n",
        "    \n",
        "    female = by_sex[by_sex['sex'] == 'Female'][['year', 'icd_code', 'hospitalizations', 'asr']].copy()\n",
        "    female.columns = ['year', 'icd_code', 'hosp_female', 'asr_female']\n",
        "    \n",
        "    total = total_agg[['year', 'icd_code', 'hospitalizations', 'asr']].copy()\n",
        "    total.columns = ['year', 'icd_code', 'hosp_total', 'asr_total']\n",
        "    \n",
        "    result = male.merge(female, on=['year', 'icd_code'], how='outer')\n",
        "    result = result.merge(total, on=['year', 'icd_code'], how='outer')\n",
        "    result['description'] = result['icd_code'].map(ALL_NEURODEG_CODES)\n",
        "    \n",
        "    cols = ['year', 'icd_code', 'description', 'hosp_male', 'hosp_female', 'hosp_total',\n",
        "            'asr_male', 'asr_female', 'asr_total']\n",
        "    result = result[cols]\n",
        "    result.sort_values(['year', 'icd_code'], inplace=True)\n",
        "    result.reset_index(drop=True, inplace=True)\n",
        "    \n",
        "    return result\n",
        "\n",
        "\n",
        "def save_figure(fig, filename):\n",
        "    filepath = os.path.join(figures_path, filename)\n",
        "    fig.savefig(filepath, dpi=150, bbox_inches='tight', facecolor='white')"
      ],
      "id": "functions",
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "code",
      "metadata": {},
      "source": [
        "#| label: load-data\n",
        "#| include: false\n",
        "\n",
        "# Load hospitalizations\n",
        "hospitalizations = load_and_filter_neurodeg_data(\n",
        "    years=YEARS,\n",
        "    use_main=True,\n",
        "    use_other=True,\n",
        "    chunksize=100000\n",
        ")\n",
        "\n",
        "# Load population denominators (INE projections - local parquet)\n",
        "population_detail = load_population_data(years=YEARS)\n",
        "\n",
        "# National (Chile) denominators used in the main ASR analysis\n",
        "population = population_detail.groupby(['year', 'age_group', 'sex'])['population'].sum().reset_index()\n",
        "\n",
        "# Regional denominators (used for regional ASR). If region is not available, we fallback to national.\n",
        "if 'region' in population_detail.columns:\n",
        "    population_regional = population_detail.groupby(['region', 'year', 'age_group', 'sex'])['population'].sum().reset_index()\n",
        "else:\n",
        "    population_regional = None\n",
        "\n",
        "# Save raw data\n",
        "hospitalizations.to_csv(os.path.join(output_path, 'hospitalizations_neurodeg.csv'), index=False)\n",
        "population.to_csv(os.path.join(output_path, 'population_chile.csv'), index=False)\n",
        "if population_regional is not None:\n",
        "    population_regional.to_csv(os.path.join(output_path, 'population_chile_by_region.csv'), index=False)\n",
        "\n",
        "# Calculate rates (national)\n",
        "asr_by_sex = calculate_asr_by_sex(hospitalizations, population)\n",
        "asr_sex_cols = calculate_asr_sex_columns(hospitalizations, population)\n",
        "asr_by_icd = calculate_asr_by_icd(hospitalizations, population)\n",
        "\n",
        "# Save results\n",
        "asr_by_sex.to_csv(os.path.join(output_path, 'asr_by_sex.csv'), index=False)\n",
        "asr_sex_cols.to_csv(os.path.join(output_path, 'asr_sex_columns.csv'), index=False)\n",
        "asr_by_icd.to_csv(os.path.join(output_path, 'asr_by_icd.csv'), index=False)"
      ],
      "id": "load-data",
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "markdown",
      "metadata": {},
      "source": [
        "## Age-Standardized Rates Analysis\n",
        "\n",
        "### Standardized Rates by Sex and Age"
      ],
      "id": "56c98c9b"
    },
    {
      "cell_type": "code",
      "metadata": {},
      "source": [
        "#| label: tbl-asr-by-sex\n",
        "#| tbl-cap: Age-standardized hospitalization rates by sex (per 100,000)\n",
        "#| tbl-cap-location: bottom\n",
        "\n",
        "asr_by_sex.style.format({\n",
        "    'hospitalizations': '{:,.0f}',\n",
        "    'population': '{:,.0f}',\n",
        "    'crude_rate': '{:.2f}',\n",
        "    'asr': '{:.2f}'\n",
        "}).hide(axis=\"index\")"
      ],
      "id": "tbl-asr-by-sex",
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "code",
      "metadata": {
        "fig-width": 12,
        "fig-height": 5
      },
      "source": [
        "#| label: fig-asr-by-sex\n",
        "#| fig-cap: Age-standardized rates by sex (2019-2024)\n",
        "\n",
        "fig, axes = plt.subplots(1, 2, figsize=(12, 5))\n",
        "\n",
        "# ASR by sex\n",
        "ax1 = axes[0]\n",
        "for sex in asr_by_sex['sex'].unique():\n",
        "    df_sex = asr_by_sex[asr_by_sex['sex'] == sex]\n",
        "    ax1.plot(df_sex['year'], df_sex['asr'], marker='o', linewidth=2, markersize=8, label=sex)\n",
        "\n",
        "ax1.set_xlabel('Year')\n",
        "ax1.set_ylabel('ASR (per 100,000)')\n",
        "ax1.set_title('Age-Standardized Rate by Sex', fontweight='bold')\n",
        "ax1.legend()\n",
        "ax1.grid(True, alpha=0.3)\n",
        "ax1.set_xticks(YEARS)\n",
        "\n",
        "# Crude rate by sex\n",
        "ax2 = axes[1]\n",
        "for sex in asr_by_sex['sex'].unique():\n",
        "    df_sex = asr_by_sex[asr_by_sex['sex'] == sex]\n",
        "    ax2.plot(df_sex['year'], df_sex['crude_rate'], marker='s', linewidth=2, markersize=8, label=sex)\n",
        "\n",
        "ax2.set_xlabel('Year')\n",
        "ax2.set_ylabel('Crude Rate (per 100,000)')\n",
        "ax2.set_title('Crude Rate by Sex', fontweight='bold')\n",
        "ax2.legend()\n",
        "ax2.grid(True, alpha=0.3)\n",
        "ax2.set_xticks(YEARS)\n",
        "\n",
        "plt.tight_layout()\n",
        "save_figure(fig, 'asr_by_sex.png')\n",
        "plt.show()"
      ],
      "id": "fig-asr-by-sex",
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "markdown",
      "metadata": {},
      "source": [
        "\\newpage\n",
        "\n",
        "### Standardized Rates by Age (Sex in Columns)"
      ],
      "id": "b27cac05"
    },
    {
      "cell_type": "code",
      "metadata": {},
      "source": [
        "#| label: tbl-asr-sex-columns\n",
        "#| tbl-cap: Age-standardized rates with sex as columns (per 100,000)\n",
        "#| tbl-cap-location: bottom\n",
        "\n",
        "asr_sex_cols.style.format({\n",
        "    'hosp_male': '{:,.0f}',\n",
        "    'hosp_female': '{:,.0f}',\n",
        "    'hosp_total': '{:,.0f}',\n",
        "    'pop_male': '{:,.0f}',\n",
        "    'pop_female': '{:,.0f}',\n",
        "    'pop_total': '{:,.0f}',\n",
        "    'crude_rate_male': '{:.2f}',\n",
        "    'crude_rate_female': '{:.2f}',\n",
        "    'crude_rate_total': '{:.2f}',\n",
        "    'asr_male': '{:.2f}',\n",
        "    'asr_female': '{:.2f}',\n",
        "    'asr_total': '{:.2f}'\n",
        "}).hide(axis=\"index\")"
      ],
      "id": "tbl-asr-sex-columns",
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "code",
      "metadata": {
        "fig-width": 14,
        "fig-height": 5
      },
      "source": [
        "#| label: fig-asr-sex-columns\n",
        "#| fig-cap: Age-standardized rates comparison (2019-2024)\n",
        "\n",
        "fig, axes = plt.subplots(1, 3, figsize=(14, 5))\n",
        "\n",
        "# ASR comparison\n",
        "ax1 = axes[0]\n",
        "ax1.plot(asr_sex_cols['year'], asr_sex_cols['asr_male'], marker='o', linewidth=2, \n",
        "         markersize=8, label='Male', color='steelblue')\n",
        "ax1.plot(asr_sex_cols['year'], asr_sex_cols['asr_female'], marker='s', linewidth=2, \n",
        "         markersize=8, label='Female', color='coral')\n",
        "ax1.plot(asr_sex_cols['year'], asr_sex_cols['asr_total'], marker='^', linewidth=2, \n",
        "         markersize=8, label='Total', color='forestgreen', linestyle='--')\n",
        "ax1.set_xlabel('Year')\n",
        "ax1.set_ylabel('ASR (per 100,000)')\n",
        "ax1.set_title('Age-Standardized Rate', fontweight='bold')\n",
        "ax1.legend()\n",
        "ax1.grid(True, alpha=0.3)\n",
        "ax1.set_xticks(YEARS)\n",
        "\n",
        "# Crude rate comparison\n",
        "ax2 = axes[1]\n",
        "ax2.plot(asr_sex_cols['year'], asr_sex_cols['crude_rate_male'], marker='o', linewidth=2, \n",
        "         markersize=8, label='Male', color='steelblue')\n",
        "ax2.plot(asr_sex_cols['year'], asr_sex_cols['crude_rate_female'], marker='s', linewidth=2, \n",
        "         markersize=8, label='Female', color='coral')\n",
        "ax2.plot(asr_sex_cols['year'], asr_sex_cols['crude_rate_total'], marker='^', linewidth=2, \n",
        "         markersize=8, label='Total', color='forestgreen', linestyle='--')\n",
        "ax2.set_xlabel('Year')\n",
        "ax2.set_ylabel('Crude Rate (per 100,000)')\n",
        "ax2.set_title('Crude Rate', fontweight='bold')\n",
        "ax2.legend()\n",
        "ax2.grid(True, alpha=0.3)\n",
        "ax2.set_xticks(YEARS)\n",
        "\n",
        "# Hospitalizations\n",
        "ax3 = axes[2]\n",
        "ax3.plot(asr_sex_cols['year'], asr_sex_cols['hosp_male'], marker='o', linewidth=2, \n",
        "         markersize=8, label='Male', color='steelblue')\n",
        "ax3.plot(asr_sex_cols['year'], asr_sex_cols['hosp_female'], marker='s', linewidth=2, \n",
        "         markersize=8, label='Female', color='coral')\n",
        "ax3.plot(asr_sex_cols['year'], asr_sex_cols['hosp_total'], marker='^', linewidth=2, \n",
        "         markersize=8, label='Total', color='forestgreen', linestyle='--')\n",
        "ax3.set_xlabel('Year')\n",
        "ax3.set_ylabel('Hospitalizations (N)')\n",
        "ax3.set_title('Total Hospitalizations', fontweight='bold')\n",
        "ax3.legend()\n",
        "ax3.grid(True, alpha=0.3)\n",
        "ax3.set_xticks(YEARS)\n",
        "\n",
        "plt.tight_layout()\n",
        "save_figure(fig, 'asr_sex_columns.png')\n",
        "plt.show()"
      ],
      "id": "fig-asr-sex-columns",
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "markdown",
      "metadata": {},
      "source": [
        "\\newpage\n",
        "\n",
        "### Standardized Rates by ICD-10 Code"
      ],
      "id": "7af02d4e"
    },
    {
      "cell_type": "code",
      "metadata": {},
      "source": [
        "#| label: tbl-asr-by-icd\n",
        "#| tbl-cap: Age-standardized rates by ICD-10 code - Latest year (per 100,000)\n",
        "#| tbl-cap-location: bottom\n",
        "\n",
        "latest_year = asr_by_icd['year'].max()\n",
        "asr_latest = asr_by_icd[asr_by_icd['year'] == latest_year].copy()\n",
        "\n",
        "asr_latest.style.format({\n",
        "    'hosp_male': '{:,.0f}',\n",
        "    'hosp_female': '{:,.0f}',\n",
        "    'hosp_total': '{:,.0f}',\n",
        "    'asr_male': '{:.2f}',\n",
        "    'asr_female': '{:.2f}',\n",
        "    'asr_total': '{:.2f}'\n",
        "}).hide(axis=\"index\")"
      ],
      "id": "tbl-asr-by-icd",
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "code",
      "metadata": {
        "fig-width": 16,
        "fig-height": 10
      },
      "source": [
        "#| label: fig-asr-by-icd-main\n",
        "#| fig-cap: ASR trends for main neurodegenerative codes (F00-F07)\n",
        "\n",
        "main_codes = list(NEURODEG_CODES_MAIN.keys())\n",
        "asr_main = asr_by_icd[asr_by_icd['icd_code'].isin(main_codes)]\n",
        "\n",
        "n_codes = len(main_codes)\n",
        "ncols = 3\n",
        "nrows = (n_codes + ncols - 1) // ncols\n",
        "\n",
        "fig, axes = plt.subplots(nrows, ncols, figsize=(16, 4*nrows))\n",
        "axes = axes.flatten()\n",
        "\n",
        "for idx, code in enumerate(main_codes):\n",
        "    ax = axes[idx]\n",
        "    df_code = asr_main[asr_main['icd_code'] == code]\n",
        "    \n",
        "    if not df_code.empty:\n",
        "        ax.plot(df_code['year'], df_code['asr_male'], marker='o', linewidth=2, \n",
        "                markersize=6, label='Male', color='steelblue')\n",
        "        ax.plot(df_code['year'], df_code['asr_female'], marker='s', linewidth=2, \n",
        "                markersize=6, label='Female', color='coral')\n",
        "        ax.plot(df_code['year'], df_code['asr_total'], marker='^', linewidth=2, \n",
        "                markersize=6, label='Total', color='forestgreen', linestyle='--')\n",
        "    \n",
        "    desc = NEURODEG_CODES_MAIN.get(code, code)[:35]\n",
        "    ax.set_title(f'{code}: {desc}', fontsize=10, fontweight='bold')\n",
        "    ax.set_xlabel('Year')\n",
        "    ax.set_ylabel('ASR')\n",
        "    ax.legend(fontsize=8)\n",
        "    ax.grid(True, alpha=0.3)\n",
        "    ax.set_xticks(YEARS)\n",
        "    ax.tick_params(axis='x', rotation=45)\n",
        "\n",
        "for idx in range(len(main_codes), len(axes)):\n",
        "    axes[idx].set_visible(False)\n",
        "\n",
        "plt.suptitle('Age-Standardized Rates - Main Codes (F00-F07)', fontsize=14, fontweight='bold')\n",
        "plt.tight_layout()\n",
        "save_figure(fig, 'asr_main_codes.png')\n",
        "plt.show()"
      ],
      "id": "fig-asr-by-icd-main",
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "code",
      "metadata": {
        "fig-width": 16,
        "fig-height": 12
      },
      "source": [
        "#| label: fig-asr-by-icd-other\n",
        "#| fig-cap: ASR trends for other neurodegenerative codes (G codes)\n",
        "\n",
        "other_codes = list(NEURODEG_CODES_OTHER.keys())\n",
        "asr_other = asr_by_icd[asr_by_icd['icd_code'].isin(other_codes)]\n",
        "\n",
        "n_codes = len(other_codes)\n",
        "ncols = 3\n",
        "nrows = (n_codes + ncols - 1) // ncols\n",
        "\n",
        "fig, axes = plt.subplots(nrows, ncols, figsize=(16, 4*nrows))\n",
        "axes = axes.flatten()\n",
        "\n",
        "for idx, code in enumerate(other_codes):\n",
        "    ax = axes[idx]\n",
        "    df_code = asr_other[asr_other['icd_code'] == code]\n",
        "    \n",
        "    if not df_code.empty:\n",
        "        ax.plot(df_code['year'], df_code['asr_male'], marker='o', linewidth=2, \n",
        "                markersize=6, label='Male', color='steelblue')\n",
        "        ax.plot(df_code['year'], df_code['asr_female'], marker='s', linewidth=2, \n",
        "                markersize=6, label='Female', color='coral')\n",
        "        ax.plot(df_code['year'], df_code['asr_total'], marker='^', linewidth=2, \n",
        "                markersize=6, label='Total', color='forestgreen', linestyle='--')\n",
        "    \n",
        "    desc = NEURODEG_CODES_OTHER.get(code, code)[:35]\n",
        "    ax.set_title(f'{code}: {desc}', fontsize=10, fontweight='bold')\n",
        "    ax.set_xlabel('Year')\n",
        "    ax.set_ylabel('ASR')\n",
        "    ax.legend(fontsize=8)\n",
        "    ax.grid(True, alpha=0.3)\n",
        "    ax.set_xticks(YEARS)\n",
        "    ax.tick_params(axis='x', rotation=45)\n",
        "\n",
        "for idx in range(len(other_codes), len(axes)):\n",
        "    axes[idx].set_visible(False)\n",
        "\n",
        "plt.suptitle('Age-Standardized Rates - Other Neurodegenerative Codes', fontsize=14, fontweight='bold')\n",
        "plt.tight_layout()\n",
        "save_figure(fig, 'asr_other_codes.png')\n",
        "plt.show()"
      ],
      "id": "fig-asr-by-icd-other",
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "markdown",
      "metadata": {},
      "source": [
        "\\newpage\n",
        "\n",
        "### Summary Table - All ICD Codes by Year"
      ],
      "id": "294d5de7"
    },
    {
      "cell_type": "code",
      "metadata": {},
      "source": [
        "#| label: tbl-summary-pivot\n",
        "#| tbl-cap: ASR summary by ICD code and year (Total)\n",
        "#| tbl-cap-location: bottom\n",
        "\n",
        "summary_pivot = asr_by_icd.pivot_table(\n",
        "    index=['icd_code', 'description'],\n",
        "    columns='year',\n",
        "    values='asr_total',\n",
        "    aggfunc='first'\n",
        ").reset_index()\n",
        "\n",
        "summary_pivot.columns.name = None\n",
        "summary_pivot.to_csv(os.path.join(output_path, 'asr_summary_pivot.csv'), index=False)\n",
        "\n",
        "year_cols = [c for c in summary_pivot.columns if isinstance(c, int) or (isinstance(c, str) and c.isdigit())]\n",
        "format_dict = {col: '{:.2f}' for col in year_cols}\n",
        "\n",
        "summary_pivot.style.format(format_dict, na_rep='-').hide(axis=\"index\")"
      ],
      "id": "tbl-summary-pivot",
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "code",
      "metadata": {
        "fig-width": 12,
        "fig-height": 8
      },
      "source": [
        "#| label: fig-heatmap-asr\n",
        "#| fig-cap: Heatmap of ASR by ICD code and year\n",
        "\n",
        "heatmap_data = asr_by_icd.pivot_table(\n",
        "    index='icd_code',\n",
        "    columns='year',\n",
        "    values='asr_total',\n",
        "    aggfunc='first'\n",
        ")\n",
        "\n",
        "fig, ax = plt.subplots(figsize=(12, 8))\n",
        "sns.heatmap(heatmap_data, annot=True, fmt='.1f', cmap='YlOrRd', \n",
        "            cbar_kws={'label': 'ASR (per 100,000)'}, ax=ax)\n",
        "ax.set_title('Age-Standardized Rates Heatmap', fontweight='bold', fontsize=14)\n",
        "ax.set_xlabel('Year')\n",
        "ax.set_ylabel('ICD-10 Code')\n",
        "\n",
        "plt.tight_layout()\n",
        "save_figure(fig, 'asr_heatmap.png')\n",
        "plt.show()"
      ],
      "id": "fig-heatmap-asr",
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "code",
      "metadata": {
        "fig-width": 10,
        "fig-height": 6
      },
      "source": [
        "#| label: fig-total-trend\n",
        "#| fig-cap: Overall neurodegenerative disease hospitalization trends\n",
        "\n",
        "total_by_year = asr_by_icd.groupby('year').agg({\n",
        "    'hosp_total': 'sum',\n",
        "    'asr_total': 'mean'\n",
        "}).reset_index()\n",
        "\n",
        "fig, ax1 = plt.subplots(figsize=(10, 6))\n",
        "\n",
        "color1 = 'steelblue'\n",
        "ax1.set_xlabel('Year')\n",
        "ax1.set_ylabel('Total Hospitalizations', color=color1)\n",
        "bars = ax1.bar(total_by_year['year'], total_by_year['hosp_total'], color=color1, alpha=0.7)\n",
        "ax1.tick_params(axis='y', labelcolor=color1)\n",
        "ax1.set_xticks(YEARS)\n",
        "\n",
        "ax2 = ax1.twinx()\n",
        "color2 = 'darkred'\n",
        "ax2.set_ylabel('Mean ASR', color=color2)\n",
        "ax2.plot(total_by_year['year'], total_by_year['asr_total'], color=color2, \n",
        "         marker='o', linewidth=3, markersize=10)\n",
        "ax2.tick_params(axis='y', labelcolor=color2)\n",
        "\n",
        "plt.title('Neurodegenerative Diseases: Hospitalizations and ASR Trends', fontweight='bold', fontsize=14)\n",
        "fig.tight_layout()\n",
        "save_figure(fig, 'total_trend.png')\n",
        "plt.show()"
      ],
      "id": "fig-total-trend",
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "code",
      "metadata": {},
      "source": [
        "#| label: tbl-summary-stats\n",
        "#| tbl-cap: Summary statistics of neurodegenerative disease hospitalizations\n",
        "#| tbl-cap-location: bottom\n",
        "\n",
        "total_hosp = hospitalizations['hospitalizations'].sum()\n",
        "unique_codes = hospitalizations['icd_code'].nunique()\n",
        "years_covered = hospitalizations['year'].nunique()\n",
        "\n",
        "summary_stats = pd.DataFrame({\n",
        "    'Metric': [\n",
        "        'Total Hospitalizations',\n",
        "        'Years Covered',\n",
        "        'ICD Codes Analyzed',\n",
        "        'Mean Hospitalizations/Year',\n",
        "        'Main Codes (F00-F07)',\n",
        "        'Other Codes (G codes)'\n",
        "    ],\n",
        "    'Value': [\n",
        "        f\"{total_hosp:,.0f}\",\n",
        "        f\"{years_covered} ({hospitalizations['year'].min()}-{hospitalizations['year'].max()})\",\n",
        "        unique_codes,\n",
        "        f\"{total_hosp/years_covered:,.0f}\",\n",
        "        len(NEURODEG_CODES_MAIN),\n",
        "        len(NEURODEG_CODES_OTHER)\n",
        "    ]\n",
        "})\n",
        "\n",
        "summary_stats.style.hide(axis=\"index\")"
      ],
      "id": "tbl-summary-stats",
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "markdown",
      "metadata": {},
      "source": [
        "\\newpage\n",
        "\n",
        "## Regional Analysis"
      ],
      "id": "77607ed7"
    },
    {
      "cell_type": "code",
      "metadata": {},
      "source": [
        "#| label: setup-regional\n",
        "#| include: false\n",
        "\n",
        "import subprocess\n",
        "import sys\n",
        "\n",
        "def ensure_pkg(pkg, import_name=None):\n",
        "    try:\n",
        "        __import__(import_name or pkg)\n",
        "    except ImportError:\n",
        "        subprocess.check_call([sys.executable, \"-m\", \"pip\", \"install\", \"-q\", pkg])\n",
        "\n",
        "ensure_pkg(\"geopandas\")\n",
        "ensure_pkg(\"mapclassify\")\n",
        "\n",
        "import geopandas as gpd\n",
        "import json\n",
        "import requests\n",
        "from io import BytesIO\n",
        "import zipfile\n",
        "\n",
        "SERVICIO_TO_REGION = {\n",
        "    'ARICA': 'Arica y Parinacota',\n",
        "    'IQUIQUE': 'Tarapacá',\n",
        "    'ANTOFAGASTA': 'Antofagasta',\n",
        "    'ATACAMA': 'Atacama',\n",
        "    'COQUIMBO': 'Coquimbo',\n",
        "    'VALPARAISO': 'Valparaíso',\n",
        "    'VIÑA DEL MAR': 'Valparaíso',\n",
        "    'ACONCAGUA': 'Valparaíso',\n",
        "    'OHIGGINS': \"O'Higgins\",\n",
        "    'MAULE': 'Maule',\n",
        "    'ÑUBLE': 'Ñuble',\n",
        "    'CONCEPCION': 'Biobío',\n",
        "    'TALCAHUANO': 'Biobío',\n",
        "    'BIOBIO': 'Biobío',\n",
        "    'ARAUCANIA NORTE': 'La Araucanía',\n",
        "    'ARAUCANIA SUR': 'La Araucanía',\n",
        "    'VALDIVIA': 'Los Ríos',\n",
        "    'OSORNO': 'Los Lagos',\n",
        "    'RELONCAVI': 'Los Lagos',\n",
        "    'CHILOE': 'Los Lagos',\n",
        "    'AYSEN': 'Aysén',\n",
        "    'MAGALLANES': 'Magallanes',\n",
        "    'METROPOLITANO NORTE': 'Metropolitana',\n",
        "    'METROPOLITANO OCCIDENTE': 'Metropolitana',\n",
        "    'METROPOLITANO CENTRAL': 'Metropolitana',\n",
        "    'METROPOLITANO ORIENTE': 'Metropolitana',\n",
        "    'METROPOLITANO SUR': 'Metropolitana',\n",
        "    'METROPOLITANO SUR ORIENTE': 'Metropolitana'\n",
        "}"
      ],
      "id": "setup-regional",
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "code",
      "metadata": {},
      "source": [
        "#| label: load-regional-data\n",
        "#| include: false\n",
        "\n",
        "def load_regional_neurodeg_data(years=YEARS, chunksize=100000):\n",
        "    \"\"\"Load neurodegenerative data with regional information.\"\"\"\n",
        "    \n",
        "    target_codes = set(NEURODEG_CODES_MAIN.keys()) | set(NEURODEG_CODES_OTHER.keys())\n",
        "    all_records = []\n",
        "    \n",
        "    for year in years:\n",
        "        pattern = f\"GRD_PUBLICO_*{year}*.csv\"\n",
        "        files = glob.glob(os.path.join(data_path, pattern))\n",
        "        \n",
        "        if not files:\n",
        "            continue\n",
        "        \n",
        "        for chunk in pd.read_csv(files[0], delimiter='|', dtype=str, \n",
        "                                  low_memory=False, chunksize=chunksize):\n",
        "            \n",
        "            diag_cols = [col for col in chunk.columns if col.startswith('DIAGNOSTICO')]\n",
        "            \n",
        "            if not diag_cols:\n",
        "                continue\n",
        "            \n",
        "            for _, row in chunk.iterrows():\n",
        "                patient_codes = set()\n",
        "                for col in diag_cols:\n",
        "                    v = row.get(col)\n",
        "                    if pd.notna(v) and v != '':\n",
        "                        code = str(v).upper().strip().replace('.', '')[:3]\n",
        "                        if code in target_codes:\n",
        "                            patient_codes.add(code)\n",
        "                \n",
        "                if patient_codes:\n",
        "                    age = calculate_age(\n",
        "                        row.get('FECHA_NACIMIENTO'),\n",
        "                        row.get('FECHA_INGRESO')\n",
        "                    )\n",
        "                    age_group = assign_age_group(age)\n",
        "                    \n",
        "                    sex_val = str(row.get('SEXO', '')).strip().upper()\n",
        "                    if sex_val == '1' or sex_val == 'HOMBRE':\n",
        "                        sex = 'Male'\n",
        "                    elif sex_val == '2' or sex_val == 'MUJER':\n",
        "                        sex = 'Female'\n",
        "                    else:\n",
        "                        sex = None\n",
        "                    \n",
        "                    servicio = str(row.get('SERVICIO_SALUD', '')).strip().upper()\n",
        "                    comuna = str(row.get('COMUNA', '')).strip()\n",
        "                    \n",
        "                    region = None\n",
        "                    for key, val in SERVICIO_TO_REGION.items():\n",
        "                        if key in servicio:\n",
        "                            region = val\n",
        "                            break\n",
        "                    \n",
        "                    for code in patient_codes:\n",
        "                        all_records.append({\n",
        "                            'year': year,\n",
        "                            'age': age,\n",
        "                            'age_group': age_group,\n",
        "                            'sex': sex,\n",
        "                            'icd_code': code,\n",
        "                            'servicio_salud': servicio,\n",
        "                            'region': region,\n",
        "                            'comuna': comuna\n",
        "                        })\n",
        "    \n",
        "    if not all_records:\n",
        "        return pd.DataFrame()\n",
        "    \n",
        "    return pd.DataFrame(all_records)\n",
        "\n",
        "regional_data = load_regional_neurodeg_data()\n",
        "regional_data.to_csv(os.path.join(output_path, 'hospitalizations_regional.csv'), index=False)\n",
        "\n",
        "# Filtrar registros sin región válida\n",
        "regional_data = regional_data[regional_data['region'].notna()].copy()"
      ],
      "id": "load-regional-data",
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "code",
      "metadata": {},
      "source": [
        "#| label: regional-asr-calculation\n",
        "#| include: false\n",
        "\n",
        "REGION_NORM_MAP = {\n",
        "    'METROPOLITANA': 'METROPOLITANA',\n",
        "    'METROPOLITANA DE SANTIAGO': 'METROPOLITANA',\n",
        "    \"O'HIGGINS\": 'OHIGGINS',\n",
        "    \"OHIGGINS\": 'OHIGGINS',\n",
        "    \"LIBERTADOR GENERAL BERNARDO O'HIGGINS\": 'OHIGGINS',\n",
        "    \"LIBERTADOR GENERAL BERNARDO OHIGGINS\": 'OHIGGINS',\n",
        "    'AYSEN': 'AYSEN',\n",
        "    'AYSEN DEL GENERAL CARLOS IBANEZ DEL CAMPO': 'AYSEN',\n",
        "    'MAGALLANES': 'MAGALLANES',\n",
        "    'MAGALLANES Y DE LA ANTARTICA CHILENA': 'MAGALLANES',\n",
        "    'MAGALLANES Y ANTARTICA CHILENA': 'MAGALLANES',\n",
        "    'ARICA Y PARINACOTA': 'ARICA Y PARINACOTA',\n",
        "    'TARAPACA': 'TARAPACA',\n",
        "    'ANTOFAGASTA': 'ANTOFAGASTA',\n",
        "    'ATACAMA': 'ATACAMA',\n",
        "    'COQUIMBO': 'COQUIMBO',\n",
        "    'VALPARAISO': 'VALPARAISO',\n",
        "    'MAULE': 'MAULE',\n",
        "    'NUBLE': 'NUBLE',\n",
        "    'BIOBIO': 'BIOBIO',\n",
        "    'LA ARAUCANIA': 'LA ARAUCANIA',\n",
        "    'LOS RIOS': 'LOS RIOS',\n",
        "    'LOS LAGOS': 'LOS LAGOS'\n",
        "}\n",
        "\n",
        "def _normalize_region_basic(x):\n",
        "    \"\"\"Normalize region names for safer merging (remove accents, upper-case, map names).\"\"\"\n",
        "    if pd.isna(x):\n",
        "        return None\n",
        "    s = str(x).upper().strip()\n",
        "    replacements = {'Á': 'A', 'É': 'E', 'Í': 'I', 'Ó': 'O', 'Ú': 'U', 'Ñ': 'N'}\n",
        "    for old, new in replacements.items():\n",
        "        s = s.replace(old, new)\n",
        "    s = s.replace('\\u2019', \"'\")\n",
        "    return REGION_NORM_MAP.get(s, s)\n",
        "\n",
        "\n",
        "def calculate_regional_asr(regional_df, population_df, per=100000):\n",
        "    \"\"\"Calculate ASR by region using INE denominators (age-group & sex).\"\"\"\n",
        "    \n",
        "    who_weights = pd.DataFrame([\n",
        "        {'age_group': k, 'who_weight': v} for k, v in WHO_STANDARD_POPULATION.items()\n",
        "    ])\n",
        "    \n",
        "    hosp_agg = regional_df.groupby(['region', 'year', 'age_group', 'sex']).size().reset_index(name='hospitalizations')\n",
        "\n",
        "    # If we have region-specific denominators, use them; otherwise fallback to national structure.\n",
        "    if population_df is not None and 'region' in population_df.columns:\n",
        "        pop_agg = population_df.groupby(['region', 'year', 'age_group', 'sex'])['population'].sum().reset_index()\n",
        "\n",
        "        hosp_agg['region_norm'] = hosp_agg['region'].apply(_normalize_region_basic)\n",
        "        pop_agg['region_norm'] = pop_agg['region'].apply(_normalize_region_basic)\n",
        "\n",
        "        merged = hosp_agg.merge(\n",
        "            pop_agg[['region_norm', 'year', 'age_group', 'sex', 'population']],\n",
        "            on=['region_norm', 'year', 'age_group', 'sex'],\n",
        "            how='left'\n",
        "        )\n",
        "    else:\n",
        "        pop_agg = population_df.groupby(['year', 'age_group', 'sex'])['population'].sum().reset_index()\n",
        "        merged = hosp_agg.merge(pop_agg, on=['year', 'age_group', 'sex'], how='left')\n",
        "\n",
        "    # Safety: drop missing or zero denominators\n",
        "    merged = merged.dropna(subset=['population'])\n",
        "    merged = merged[merged['population'] > 0]\n",
        "\n",
        "    merged['age_specific_rate'] = (merged['hospitalizations'] / merged['population']) * per\n",
        "    merged = merged.merge(who_weights, on='age_group', how='left')\n",
        "    merged['weighted_rate'] = merged['age_specific_rate'] * merged['who_weight']\n",
        "    \n",
        "    result = merged.groupby(['region', 'year']).agg({\n",
        "        'hospitalizations': 'sum',\n",
        "        'weighted_rate': 'sum'\n",
        "    }).reset_index()\n",
        "    \n",
        "    result['asr'] = (result['weighted_rate'] / TOTAL_WHO_WEIGHT).round(2)\n",
        "    \n",
        "    return result[['region', 'year', 'hospitalizations', 'asr']]\n",
        "\n",
        "\n",
        "def calculate_regional_icd_asr(regional_df, population_df, per=100000):\n",
        "    \"\"\"Calculate ASR by region and ICD code.\"\"\"\n",
        "    who_weights = pd.DataFrame([\n",
        "        {'age_group': k, 'who_weight': v} for k, v in WHO_STANDARD_POPULATION.items()\n",
        "    ])\n",
        "    \n",
        "    hosp_agg = regional_df.groupby(['region', 'icd_code', 'year', 'age_group', 'sex']).size().reset_index(name='hospitalizations')\n",
        "    \n",
        "    if population_df is not None and 'region' in population_df.columns:\n",
        "        pop_agg = population_df.groupby(['region', 'year', 'age_group', 'sex'])['population'].sum().reset_index()\n",
        "        hosp_agg['region_norm'] = hosp_agg['region'].apply(_normalize_region_basic)\n",
        "        pop_agg['region_norm'] = pop_agg['region'].apply(_normalize_region_basic)\n",
        "        merged = hosp_agg.merge(\n",
        "            pop_agg[['region_norm', 'year', 'age_group', 'sex', 'population']],\n",
        "            on=['region_norm', 'year', 'age_group', 'sex'],\n",
        "            how='left'\n",
        "        )\n",
        "    else:\n",
        "        pop_agg = population_df.groupby(['year', 'age_group', 'sex'])['population'].sum().reset_index()\n",
        "        merged = hosp_agg.merge(pop_agg, on=['year', 'age_group', 'sex'], how='left')\n",
        "    \n",
        "    merged = merged.dropna(subset=['population'])\n",
        "    merged = merged[merged['population'] > 0]\n",
        "    \n",
        "    merged['age_specific_rate'] = (merged['hospitalizations'] / merged['population']) * per\n",
        "    merged = merged.merge(who_weights, on='age_group', how='left')\n",
        "    merged['weighted_rate'] = merged['age_specific_rate'] * merged['who_weight']\n",
        "    \n",
        "    result = merged.groupby(['region', 'icd_code']).agg({\n",
        "        'hospitalizations': 'sum',\n",
        "        'weighted_rate': 'sum'\n",
        "    }).reset_index()\n",
        "    \n",
        "    result['asr'] = (result['weighted_rate'] / TOTAL_WHO_WEIGHT).round(2)\n",
        "    result['description'] = result['icd_code'].map(ALL_NEURODEG_CODES)\n",
        "    \n",
        "    return result[['region', 'icd_code', 'description', 'hospitalizations', 'asr']]\n",
        "\n",
        "\n",
        "regional_asr = calculate_regional_asr(regional_data, population_regional if population_regional is not None else population)\n",
        "regional_icd_asr = calculate_regional_icd_asr(regional_data, population_regional if population_regional is not None else population)\n",
        "\n",
        "total_by_region = regional_data.groupby('region').size().reset_index(name='total_hospitalizations')\n",
        "total_by_region = total_by_region.sort_values('total_hospitalizations', ascending=False)\n",
        "\n",
        "mean_asr_region = regional_asr.groupby('region')['asr'].mean().reset_index()\n",
        "mean_asr_region.columns = ['region', 'mean_asr']\n",
        "mean_asr_region = mean_asr_region.sort_values('mean_asr', ascending=False)\n",
        "\n",
        "main_disease_region = regional_icd_asr.loc[\n",
        "    regional_icd_asr.groupby('region')['hospitalizations'].idxmax()\n",
        "][['region', 'icd_code', 'description', 'hospitalizations', 'asr']]"
      ],
      "id": "regional-asr-calculation",
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "markdown",
      "metadata": {},
      "source": [
        "### Age-Standardized Rates by Region"
      ],
      "id": "22767791"
    },
    {
      "cell_type": "code",
      "metadata": {},
      "source": [
        "#| label: tbl-regional-asr\n",
        "#| tbl-cap: Age-standardized hospitalization rates by region (per 100,000)\n",
        "#| tbl-cap-location: bottom\n",
        "\n",
        "regional_asr_pivot = regional_asr.pivot_table(\n",
        "    index='region',\n",
        "    columns='year',\n",
        "    values='asr',\n",
        "    aggfunc='first'\n",
        ").reset_index()\n",
        "\n",
        "regional_asr_pivot['Mean ASR'] = regional_asr_pivot[[c for c in regional_asr_pivot.columns if c != 'region']].mean(axis=1).round(2)\n",
        "regional_asr_pivot = regional_asr_pivot.sort_values('Mean ASR', ascending=False)\n",
        "\n",
        "year_cols = [c for c in regional_asr_pivot.columns if isinstance(c, (int, float)) and c != 'Mean ASR']\n",
        "format_dict = {col: '{:.2f}' for col in year_cols + ['Mean ASR']}\n",
        "\n",
        "regional_asr_pivot.style.format(format_dict, na_rep='-').background_gradient(\n",
        "    cmap='YlOrRd', subset=['Mean ASR']\n",
        ").hide(axis=\"index\")"
      ],
      "id": "tbl-regional-asr",
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "code",
      "metadata": {
        "fig-width": 16,
        "fig-height": 8
      },
      "source": [
        "#| label: fig-regional-asr-trend\n",
        "#| fig-cap: Age-standardized rates trend by region (2019-2024)\n",
        "\n",
        "fig, axes = plt.subplots(1, 2, figsize=(16, 8))\n",
        "\n",
        "all_regions = mean_asr_region['region'].tolist()\n",
        "\n",
        "ax1 = axes[0]\n",
        "for region in all_regions:\n",
        "    df_reg = regional_asr[regional_asr['region'] == region]\n",
        "    ax1.plot(df_reg['year'], df_reg['asr'], marker='o', linewidth=2, markersize=5, label=region)\n",
        "\n",
        "ax1.set_xlabel('Year')\n",
        "ax1.set_ylabel('ASR (per 100,000)')\n",
        "ax1.set_title('ASR Trend - All Regions', fontweight='bold')\n",
        "ax1.legend(bbox_to_anchor=(1.02, 1), loc='upper left', fontsize=8)\n",
        "ax1.grid(True, alpha=0.3)\n",
        "ax1.set_xticks(YEARS)\n",
        "\n",
        "ax2 = axes[1]\n",
        "data_sorted = mean_asr_region.sort_values('mean_asr', ascending=True)\n",
        "colors = plt.cm.YlOrRd(data_sorted['mean_asr'] / data_sorted['mean_asr'].max())\n",
        "ax2.barh(data_sorted['region'], data_sorted['mean_asr'], color=colors)\n",
        "ax2.set_xlabel('Mean ASR (per 100,000)')\n",
        "ax2.set_title('Mean ASR by Region (2019-2024)', fontweight='bold')\n",
        "ax2.grid(True, alpha=0.3, axis='x')\n",
        "\n",
        "plt.tight_layout()\n",
        "save_figure(fig, 'regional_asr_trends.png')\n",
        "plt.show()"
      ],
      "id": "fig-regional-asr-trend",
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "markdown",
      "metadata": {},
      "source": [
        "### Most Prevalent Disease by Region"
      ],
      "id": "d76bc827"
    },
    {
      "cell_type": "code",
      "metadata": {},
      "source": [
        "#| label: tbl-top-disease-region\n",
        "#| tbl-cap: Most prevalent neurodegenerative disease by region (all regions)\n",
        "#| tbl-cap-location: bottom\n",
        "\n",
        "main_disease_display = main_disease_region.copy()\n",
        "main_disease_display.columns = ['Region', 'ICD Code', 'Disease', 'Hospitalizations', 'ASR']\n",
        "main_disease_display = main_disease_display.sort_values('ASR', ascending=False)\n",
        "\n",
        "main_disease_display.style.format({\n",
        "    'Hospitalizations': '{:,.0f}',\n",
        "    'ASR': '{:.2f}'\n",
        "}).hide(axis=\"index\")"
      ],
      "id": "tbl-top-disease-region",
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "code",
      "metadata": {
        "fig-width": 18,
        "fig-height": 14
      },
      "source": [
        "#| label: fig-disease-by-region\n",
        "#| fig-cap: Disease ASR distribution by region - All regions and ICD codes\n",
        "\n",
        "all_regions = mean_asr_region['region'].tolist()\n",
        "all_icd = regional_icd_asr['icd_code'].unique().tolist()\n",
        "\n",
        "heatmap_data = regional_icd_asr.pivot_table(\n",
        "    index='region',\n",
        "    columns='icd_code',\n",
        "    values='asr',\n",
        "    aggfunc='first'\n",
        ").fillna(0)\n",
        "\n",
        "heatmap_data = heatmap_data.reindex(all_regions)\n",
        "\n",
        "fig, axes = plt.subplots(1, 2, figsize=(18, 14))\n",
        "\n",
        "ax1 = axes[0]\n",
        "sns.heatmap(heatmap_data, annot=True, fmt='.1f', cmap='YlOrRd', \n",
        "            cbar_kws={'label': 'ASR (per 100,000)'}, ax=ax1, annot_kws={'size': 7})\n",
        "ax1.set_title('Disease ASR by Region - All ICD Codes', fontweight='bold')\n",
        "ax1.set_xlabel('ICD-10 Code')\n",
        "ax1.set_ylabel('Region')\n",
        "\n",
        "ax2 = axes[1]\n",
        "heatmap_data.plot(kind='barh', stacked=True, ax=ax2, colormap='Set2')\n",
        "ax2.set_xlabel('Cumulative ASR (per 100,000)')\n",
        "ax2.set_title('Disease Composition by Region (ASR)', fontweight='bold')\n",
        "ax2.legend(title='ICD Code', bbox_to_anchor=(1.02, 1), loc='upper left', fontsize=7)\n",
        "ax2.grid(True, alpha=0.3, axis='x')\n",
        "\n",
        "plt.tight_layout()\n",
        "save_figure(fig, 'disease_by_region.png')\n",
        "plt.show()"
      ],
      "id": "fig-disease-by-region",
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "markdown",
      "metadata": {},
      "source": [
        "\\newpage\n",
        "\n",
        "### Chile Map - ASR by Region"
      ],
      "id": "a90fa899"
    },
    {
      "cell_type": "code",
      "metadata": {},
      "source": [
        "#| label: tbl-regional-summary-complete\n",
        "#| tbl-cap: Complete regional summary with ASR and top disease\n",
        "#| tbl-cap-location: bottom\n",
        "\n",
        "regional_complete = total_by_region.merge(mean_asr_region, on='region', how='left')\n",
        "regional_complete = regional_complete.merge(\n",
        "    main_disease_region[['region', 'icd_code', 'description']], \n",
        "    on='region', \n",
        "    how='left'\n",
        ")\n",
        "regional_complete.columns = ['Region', 'Total Hosp.', 'Mean ASR', 'Main ICD', 'Main Disease']\n",
        "regional_complete = regional_complete.sort_values('Mean ASR', ascending=False)\n",
        "\n",
        "regional_complete.style.format({\n",
        "    'Total Hosp.': '{:,.0f}',\n",
        "    'Mean ASR': '{:.2f}'\n",
        "}).hide(axis=\"index\")"
      ],
      "id": "tbl-regional-summary-complete",
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "markdown",
      "metadata": {},
      "source": [
        "\\newpage\n",
        "\n",
        "## Metropolitan Region Analysis"
      ],
      "id": "c5d3eeee"
    },
    {
      "cell_type": "code",
      "metadata": {},
      "source": [
        "#| label: filter-rm-data\n",
        "#| include: false\n",
        "\n",
        "# Obtener lista de comunas de la RM desde el parquet de población\n",
        "rm_comunas_pop = population_detail[population_detail['region'] == 'Metropolitana']['comuna'].unique().tolist()\n",
        "\n",
        "def normalize_comuna(x):\n",
        "    if pd.isna(x):\n",
        "        return None\n",
        "    s = str(x).upper().strip()\n",
        "    replacements = {'Á': 'A', 'É': 'E', 'Í': 'I', 'Ó': 'O', 'Ú': 'U', 'Ñ': 'N'}\n",
        "    for old, new in replacements.items():\n",
        "        s = s.replace(old, new)\n",
        "    return s\n",
        "\n",
        "rm_comunas_norm = set(normalize_comuna(c) for c in rm_comunas_pop if pd.notna(c))\n",
        "\n",
        "# Filtrar datos de RM por comunas válidas\n",
        "regional_data['comuna_norm'] = regional_data['comuna'].apply(normalize_comuna)\n",
        "rm_data = regional_data[regional_data['comuna_norm'].isin(rm_comunas_norm)].copy()\n",
        "\n",
        "total_by_comuna = rm_data.groupby('comuna').size().reset_index(name='total_hospitalizations')\n",
        "total_by_comuna = total_by_comuna.sort_values('total_hospitalizations', ascending=False)\n",
        "\n",
        "comuna_counts = rm_data.groupby(['year', 'comuna']).size().reset_index(name='hospitalizations')\n",
        "\n",
        "# Población de la RM por comuna\n",
        "pop_rm = population_detail[population_detail['region'] == 'Metropolitana'].copy()\n",
        "pop_rm['comuna_norm'] = pop_rm['comuna'].apply(normalize_comuna)\n",
        "\n",
        "def calculate_comuna_asr(df, pop_df, per=100000):\n",
        "    \"\"\"Calculate ASR by comuna using RM population.\"\"\"\n",
        "    who_weights = pd.DataFrame([\n",
        "        {'age_group': k, 'who_weight': v} for k, v in WHO_STANDARD_POPULATION.items()\n",
        "    ])\n",
        "    \n",
        "    df['comuna_norm'] = df['comuna'].apply(normalize_comuna)\n",
        "    hosp_agg = df.groupby(['comuna_norm', 'year', 'age_group', 'sex']).size().reset_index(name='hospitalizations')\n",
        "    \n",
        "    pop_agg = pop_df.groupby(['comuna_norm', 'year', 'age_group', 'sex'])['population'].sum().reset_index()\n",
        "    \n",
        "    merged = hosp_agg.merge(\n",
        "        pop_agg,\n",
        "        on=['comuna_norm', 'year', 'age_group', 'sex'],\n",
        "        how='left'\n",
        "    )\n",
        "    \n",
        "    merged = merged.dropna(subset=['population'])\n",
        "    merged = merged[merged['population'] > 0]\n",
        "    \n",
        "    merged['age_specific_rate'] = (merged['hospitalizations'] / merged['population']) * per\n",
        "    merged = merged.merge(who_weights, on='age_group', how='left')\n",
        "    merged['weighted_rate'] = merged['age_specific_rate'] * merged['who_weight']\n",
        "    \n",
        "    result = merged.groupby('comuna_norm').agg({\n",
        "        'hospitalizations': 'sum',\n",
        "        'weighted_rate': 'sum'\n",
        "    }).reset_index()\n",
        "    \n",
        "    result['asr'] = (result['weighted_rate'] / TOTAL_WHO_WEIGHT).round(2)\n",
        "    \n",
        "    # Recuperar nombre original de comuna\n",
        "    comuna_map = df.drop_duplicates('comuna_norm')[['comuna', 'comuna_norm']]\n",
        "    result = result.merge(comuna_map, on='comuna_norm', how='left')\n",
        "    \n",
        "    return result[['comuna', 'hospitalizations', 'asr']]\n",
        "\n",
        "\n",
        "def calculate_comuna_icd_asr(df, pop_df, per=100000):\n",
        "    \"\"\"Calculate ASR by comuna and ICD code.\"\"\"\n",
        "    who_weights = pd.DataFrame([\n",
        "        {'age_group': k, 'who_weight': v} for k, v in WHO_STANDARD_POPULATION.items()\n",
        "    ])\n",
        "    \n",
        "    df['comuna_norm'] = df['comuna'].apply(normalize_comuna)\n",
        "    hosp_agg = df.groupby(['comuna_norm', 'icd_code', 'year', 'age_group', 'sex']).size().reset_index(name='hospitalizations')\n",
        "    \n",
        "    pop_agg = pop_df.groupby(['comuna_norm', 'year', 'age_group', 'sex'])['population'].sum().reset_index()\n",
        "    \n",
        "    merged = hosp_agg.merge(\n",
        "        pop_agg,\n",
        "        on=['comuna_norm', 'year', 'age_group', 'sex'],\n",
        "        how='left'\n",
        "    )\n",
        "    \n",
        "    merged = merged.dropna(subset=['population'])\n",
        "    merged = merged[merged['population'] > 0]\n",
        "    \n",
        "    merged['age_specific_rate'] = (merged['hospitalizations'] / merged['population']) * per\n",
        "    merged = merged.merge(who_weights, on='age_group', how='left')\n",
        "    merged['weighted_rate'] = merged['age_specific_rate'] * merged['who_weight']\n",
        "    \n",
        "    result = merged.groupby(['comuna_norm', 'icd_code']).agg({\n",
        "        'hospitalizations': 'sum',\n",
        "        'weighted_rate': 'sum'\n",
        "    }).reset_index()\n",
        "    \n",
        "    result['asr'] = (result['weighted_rate'] / TOTAL_WHO_WEIGHT).round(2)\n",
        "    result['description'] = result['icd_code'].map(ALL_NEURODEG_CODES)\n",
        "    \n",
        "    comuna_map = df.drop_duplicates('comuna_norm')[['comuna', 'comuna_norm']]\n",
        "    result = result.merge(comuna_map, on='comuna_norm', how='left')\n",
        "    \n",
        "    return result[['comuna', 'icd_code', 'description', 'hospitalizations', 'asr']]\n",
        "\n",
        "\n",
        "comuna_asr = calculate_comuna_asr(rm_data, pop_rm)\n",
        "comuna_icd_asr = calculate_comuna_icd_asr(rm_data, pop_rm)\n",
        "\n",
        "main_disease_comuna = comuna_icd_asr.loc[\n",
        "    comuna_icd_asr.groupby('comuna')['hospitalizations'].idxmax()\n",
        "][['comuna', 'icd_code', 'description', 'hospitalizations', 'asr']]\n",
        "\n",
        "mean_asr_comuna = comuna_asr.sort_values('asr', ascending=False)"
      ],
      "id": "filter-rm-data",
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "markdown",
      "metadata": {},
      "source": [
        "### Hospitalizations by Comuna - Metropolitan Region"
      ],
      "id": "883ba97f"
    },
    {
      "cell_type": "code",
      "metadata": {},
      "source": [
        "#| label: tbl-rm-summary\n",
        "#| tbl-cap: All comunas with ASR - Metropolitan Region\n",
        "#| tbl-cap-location: bottom\n",
        "\n",
        "rm_summary = total_by_comuna.merge(\n",
        "    mean_asr_comuna[['comuna', 'asr']], \n",
        "    on='comuna', \n",
        "    how='left'\n",
        ").merge(\n",
        "    main_disease_comuna[['comuna', 'icd_code', 'description']], \n",
        "    on='comuna', \n",
        "    how='left'\n",
        ")\n",
        "rm_summary.columns = ['Comuna', 'Total Hosp.', 'ASR', 'Main ICD', 'Main Disease']\n",
        "rm_summary = rm_summary.sort_values('ASR', ascending=False)\n",
        "\n",
        "rm_summary.style.format({\n",
        "    'Total Hosp.': '{:,.0f}',\n",
        "    'ASR': '{:.2f}'\n",
        "}, na_rep='-').hide(axis=\"index\")"
      ],
      "id": "tbl-rm-summary",
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "code",
      "metadata": {
        "fig-width": 16,
        "fig-height": 14
      },
      "source": [
        "#| label: fig-rm-bars\n",
        "#| fig-cap: Metropolitan Region hospitalizations by comuna\n",
        "\n",
        "fig, axes = plt.subplots(1, 2, figsize=(16, 14))\n",
        "\n",
        "ax1 = axes[0]\n",
        "data_sorted = total_by_comuna.sort_values('total_hospitalizations', ascending=True)\n",
        "colors = plt.cm.Blues(np.linspace(0.3, 0.9, len(data_sorted)))\n",
        "ax1.barh(data_sorted['comuna'], data_sorted['total_hospitalizations'], color=colors)\n",
        "ax1.set_xlabel('Total Hospitalizations')\n",
        "ax1.set_title('All Comunas - Metropolitan Region', fontweight='bold')\n",
        "ax1.grid(True, alpha=0.3, axis='x')\n",
        "\n",
        "ax2 = axes[1]\n",
        "all_comunas = total_by_comuna['comuna'].tolist()\n",
        "for comuna in all_comunas:\n",
        "    df_com = comuna_counts[comuna_counts['comuna'] == comuna]\n",
        "    if not df_com.empty:\n",
        "        ax2.plot(df_com['year'], df_com['hospitalizations'], marker='o', linewidth=1.5, \n",
        "                 markersize=4, label=comuna, alpha=0.7)\n",
        "\n",
        "ax2.set_xlabel('Year')\n",
        "ax2.set_ylabel('Hospitalizations')\n",
        "ax2.set_title('Annual Trend - All Comunas', fontweight='bold')\n",
        "ax2.legend(bbox_to_anchor=(1.02, 1), loc='upper left', fontsize=6, ncol=2)\n",
        "ax2.grid(True, alpha=0.3)\n",
        "ax2.set_xticks(YEARS)\n",
        "\n",
        "plt.tight_layout()\n",
        "save_figure(fig, 'rm_hospitalizations.png')\n",
        "plt.show()"
      ],
      "id": "fig-rm-bars",
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "markdown",
      "metadata": {},
      "source": [
        "### Most Prevalent Disease by Comuna"
      ],
      "id": "56a91e1a"
    },
    {
      "cell_type": "code",
      "metadata": {},
      "source": [
        "#| label: tbl-top-disease-comuna\n",
        "#| tbl-cap: Most prevalent disease by comuna - All comunas with ASR\n",
        "#| tbl-cap-location: bottom\n",
        "\n",
        "main_disease_display = main_disease_comuna.merge(total_by_comuna, on='comuna')\n",
        "main_disease_display = main_disease_display.merge(mean_asr_comuna[['comuna', 'asr']], on='comuna', how='left', suffixes=('_icd', '_total'))\n",
        "main_disease_display = main_disease_display.sort_values('asr_total', ascending=False)\n",
        "main_disease_display = main_disease_display[['comuna', 'total_hospitalizations', 'asr_total', 'icd_code', 'description', 'asr_icd']]\n",
        "main_disease_display.columns = ['Comuna', 'Total Hosp.', 'Mean ASR', 'Main ICD', 'Disease', 'ICD ASR']\n",
        "\n",
        "main_disease_display.style.format({\n",
        "    'Total Hosp.': '{:,.0f}',\n",
        "    'Mean ASR': '{:.2f}',\n",
        "    'ICD ASR': '{:.2f}'\n",
        "}, na_rep='-').hide(axis=\"index\")"
      ],
      "id": "tbl-top-disease-comuna",
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "code",
      "metadata": {
        "fig-width": 18,
        "fig-height": 16
      },
      "source": [
        "#| label: fig-disease-by-comuna\n",
        "#| fig-cap: Disease ASR distribution by comuna - All comunas\n",
        "\n",
        "all_icd_rm = rm_data['icd_code'].unique().tolist()\n",
        "all_comunas_rm = total_by_comuna['comuna'].tolist()\n",
        "\n",
        "heatmap_data = comuna_icd_asr.pivot_table(\n",
        "    index='comuna',\n",
        "    columns='icd_code',\n",
        "    values='asr',\n",
        "    aggfunc='first'\n",
        ").fillna(0)\n",
        "\n",
        "order = [c for c in all_comunas_rm if c in heatmap_data.index]\n",
        "heatmap_data = heatmap_data.loc[order]\n",
        "\n",
        "fig, axes = plt.subplots(1, 2, figsize=(18, 16))\n",
        "\n",
        "ax1 = axes[0]\n",
        "sns.heatmap(heatmap_data, annot=True, fmt='.1f', cmap='YlOrRd', \n",
        "            cbar_kws={'label': 'ASR (per 100,000)'}, ax=ax1, annot_kws={'size': 6})\n",
        "ax1.set_title('Disease ASR by Comuna - All ICD Codes', fontweight='bold')\n",
        "ax1.set_xlabel('ICD-10 Code')\n",
        "ax1.set_ylabel('Comuna')\n",
        "\n",
        "ax2 = axes[1]\n",
        "heatmap_data.plot(kind='barh', stacked=True, ax=ax2, colormap='Set2')\n",
        "ax2.set_xlabel('Cumulative ASR (per 100,000)')\n",
        "ax2.set_title('Disease Composition by Comuna (ASR)', fontweight='bold')\n",
        "ax2.legend(title='ICD Code', bbox_to_anchor=(1.02, 1), loc='upper left', fontsize=7)\n",
        "ax2.grid(True, alpha=0.3, axis='x')\n",
        "\n",
        "plt.tight_layout()\n",
        "save_figure(fig, 'disease_by_comuna.png')\n",
        "plt.show()"
      ],
      "id": "fig-disease-by-comuna",
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "markdown",
      "metadata": {},
      "source": [
        "\\newpage\n",
        "\n",
        "### Metropolitan Region Map - Hospitalizations by Comuna"
      ],
      "id": "88140a49"
    },
    {
      "cell_type": "code",
      "metadata": {},
      "source": [
        "#| label: load-rm-shapefile\n",
        "#| include: false\n",
        "\n",
        "def load_rm_comunas_gdf():\n",
        "    local_shp = os.path.join(data_path, 'comunas_rm.shp')\n",
        "    if os.path.exists(local_shp):\n",
        "        return gpd.read_file(local_shp)\n",
        "    \n",
        "    # Try to load all comunas and filter for RM\n",
        "    comunas_shp = os.path.join(data_path, 'shapefiles_comunas')\n",
        "    if os.path.exists(comunas_shp):\n",
        "        shp_files = glob.glob(os.path.join(comunas_shp, '**/*.shp'), recursive=True)\n",
        "        if shp_files:\n",
        "            gdf = gpd.read_file(shp_files[0])\n",
        "            for col in gdf.columns:\n",
        "                if 'region' in col.lower() or 'cod_regi' in col.lower():\n",
        "                    gdf = gdf[gdf[col].astype(str).str.contains('13|Metropolitana|Santiago', case=False, na=False)]\n",
        "                    break\n",
        "            return gdf\n",
        "    \n",
        "    url = \"https://www.bcn.cl/obtienearchivo?id=repositorio/10221/10400/2/Comunas.zip\"\n",
        "    try:\n",
        "        response = requests.get(url, timeout=60)\n",
        "        if response.status_code == 200:\n",
        "            os.makedirs(os.path.join(data_path, 'shapefiles_comunas'), exist_ok=True)\n",
        "            with zipfile.ZipFile(BytesIO(response.content)) as z:\n",
        "                z.extractall(os.path.join(data_path, 'shapefiles_comunas'))\n",
        "            shp_files = glob.glob(os.path.join(data_path, 'shapefiles_comunas', '**/*.shp'), recursive=True)\n",
        "            if shp_files:\n",
        "                gdf = gpd.read_file(shp_files[0])\n",
        "                for col in gdf.columns:\n",
        "                    if 'region' in col.lower() or 'cod_regi' in col.lower():\n",
        "                        gdf = gdf[gdf[col].astype(str).str.contains('13|Metropolitana|Santiago', case=False, na=False)]\n",
        "                        break\n",
        "                return gdf\n",
        "    except Exception as e:\n",
        "        pass\n",
        "    return None\n",
        "\n",
        "try:\n",
        "    gdf_rm = load_rm_comunas_gdf()\n",
        "    has_rm_shapefile = gdf_rm is not None and len(gdf_rm) > 0\n",
        "except:\n",
        "    has_rm_shapefile = False"
      ],
      "id": "load-rm-shapefile",
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "code",
      "metadata": {
        "fig-width": 12,
        "fig-height": 12
      },
      "source": [
        "#| label: fig-rm-map-asr\n",
        "#| fig-cap: Mean ASR by comuna - Metropolitan Region map\n",
        "\n",
        "def normalize_comuna_name(name):\n",
        "    \"\"\"Normalize comuna name for matching.\"\"\"\n",
        "    if pd.isna(name):\n",
        "        return None\n",
        "    name_str = str(name).upper().strip()\n",
        "    replacements = {'Á': 'A', 'É': 'E', 'Í': 'I', 'Ó': 'O', 'Ú': 'U', 'Ñ': 'N'}\n",
        "    for old, new in replacements.items():\n",
        "        name_str = name_str.replace(old, new)\n",
        "    return name_str\n",
        "\n",
        "if has_rm_shapefile:\n",
        "    comuna_col = None\n",
        "    for col in gdf_rm.columns:\n",
        "        col_lower = col.lower()\n",
        "        if 'comuna' in col_lower or 'nom_com' in col_lower or 'nombre' in col_lower:\n",
        "            comuna_col = col\n",
        "            break\n",
        "    \n",
        "    has_asr_comuna = len(mean_asr_comuna) > 0 and 'asr' in mean_asr_comuna.columns and mean_asr_comuna['asr'].sum() > 0\n",
        "    \n",
        "    if comuna_col and has_asr_comuna:\n",
        "        gdf_rm['comuna_normalized'] = gdf_rm[comuna_col].apply(normalize_comuna_name)\n",
        "        mean_asr_comuna_copy = mean_asr_comuna.copy()\n",
        "        mean_asr_comuna_copy['comuna_normalized'] = mean_asr_comuna_copy['comuna'].apply(normalize_comuna_name)\n",
        "        \n",
        "        gdf_rm_merged = gdf_rm.merge(\n",
        "            mean_asr_comuna_copy[['comuna_normalized', 'asr']],\n",
        "            on='comuna_normalized',\n",
        "            how='left'\n",
        "        )\n",
        "        gdf_rm_merged['asr'] = gdf_rm_merged['asr'].fillna(0)\n",
        "        \n",
        "        fig, ax = plt.subplots(1, 1, figsize=(12, 12))\n",
        "        \n",
        "        vmin = mean_asr_comuna_copy['asr'].min()\n",
        "        vmax = mean_asr_comuna_copy['asr'].max()\n",
        "        if vmax == 0 or vmax == vmin:\n",
        "            vmax = vmin + 1\n",
        "        \n",
        "        gdf_rm_merged.plot(\n",
        "            column='asr',\n",
        "            cmap='YlOrRd',\n",
        "            linewidth=0.5,\n",
        "            ax=ax,\n",
        "            edgecolor='0.3',\n",
        "            legend=True,\n",
        "            vmin=vmin,\n",
        "            vmax=vmax,\n",
        "            legend_kwds={\n",
        "                'label': 'Mean ASR (per 100,000)',\n",
        "                'orientation': 'horizontal',\n",
        "                'shrink': 0.6,\n",
        "                'pad': 0.02\n",
        "            },\n",
        "            missing_kwds={'color': 'lightgrey', 'label': 'No data'}\n",
        "        )\n",
        "        \n",
        "        top_10_asr = mean_asr_comuna_copy.head(10)['comuna_normalized'].tolist()\n",
        "        for idx, row in gdf_rm_merged.iterrows():\n",
        "            if row['comuna_normalized'] in top_10_asr and row['asr'] > 0:\n",
        "                centroid = row.geometry.centroid\n",
        "                ax.annotate(\n",
        "                    f\"{row[comuna_col][:10]}\\n{row['asr']:.1f}\", \n",
        "                    xy=(centroid.x, centroid.y),\n",
        "                    fontsize=6,\n",
        "                    ha='center',\n",
        "                    va='center',\n",
        "                    color='black',\n",
        "                    fontweight='bold'\n",
        "                )\n",
        "        \n",
        "        ax.set_title('Neurodegenerative Disease ASR\\nMetropolitan Region by Comuna (2019-2024)', \n",
        "                     fontsize=14, fontweight='bold')\n",
        "        ax.axis('off')\n",
        "        \n",
        "        plt.tight_layout()\n",
        "        save_figure(fig, 'rm_map_asr.png')\n",
        "        plt.show()\n",
        "    else:\n",
        "        fig, ax = plt.subplots(figsize=(14, 16))\n",
        "        if has_asr_comuna:\n",
        "            data_sorted = mean_asr_comuna.sort_values('asr', ascending=True)\n",
        "            max_val = data_sorted['asr'].max()\n",
        "            if max_val == 0:\n",
        "                max_val = 1\n",
        "            colors = plt.cm.YlOrRd(data_sorted['asr'] / max_val)\n",
        "            ax.barh(range(len(data_sorted)), data_sorted['asr'], color=colors)\n",
        "            ax.set_yticks(range(len(data_sorted)))\n",
        "            ax.set_yticklabels(data_sorted['comuna'], fontsize=7)\n",
        "            ax.set_xlabel('Mean ASR (per 100,000)')\n",
        "        else:\n",
        "            data_sorted = total_by_comuna.sort_values('total_hospitalizations', ascending=True)\n",
        "            ax.barh(range(len(data_sorted)), data_sorted['total_hospitalizations'], color='steelblue')\n",
        "            ax.set_yticks(range(len(data_sorted)))\n",
        "            ax.set_yticklabels(data_sorted['comuna'], fontsize=7)\n",
        "            ax.set_xlabel('Total Hospitalizations')\n",
        "        ax.set_title('All Comunas - Metropolitan Region', fontweight='bold')\n",
        "        ax.grid(True, alpha=0.3, axis='x')\n",
        "        plt.tight_layout()\n",
        "        save_figure(fig, 'rm_map_asr.png')\n",
        "        plt.show()\n",
        "else:\n",
        "    fig, ax = plt.subplots(figsize=(14, 16))\n",
        "    if len(mean_asr_comuna) > 0 and 'asr' in mean_asr_comuna.columns and mean_asr_comuna['asr'].sum() > 0:\n",
        "        data_sorted = mean_asr_comuna.sort_values('asr', ascending=True)\n",
        "        max_val = data_sorted['asr'].max()\n",
        "        if max_val == 0:\n",
        "            max_val = 1\n",
        "        colors = plt.cm.YlOrRd(data_sorted['asr'] / max_val)\n",
        "        ax.barh(range(len(data_sorted)), data_sorted['asr'], color=colors)\n",
        "        ax.set_yticks(range(len(data_sorted)))\n",
        "        ax.set_yticklabels(data_sorted['comuna'], fontsize=7)\n",
        "        ax.set_xlabel('Mean ASR (per 100,000)')\n",
        "    else:\n",
        "        data_sorted = total_by_comuna.sort_values('total_hospitalizations', ascending=True)\n",
        "        ax.barh(range(len(data_sorted)), data_sorted['total_hospitalizations'], color='steelblue')\n",
        "        ax.set_yticks(range(len(data_sorted)))\n",
        "        ax.set_yticklabels(data_sorted['comuna'], fontsize=7)\n",
        "        ax.set_xlabel('Total Hospitalizations')\n",
        "    ax.set_title('All Comunas by ASR - Metropolitan Region', fontweight='bold')\n",
        "    ax.grid(True, alpha=0.3, axis='x')\n",
        "    plt.tight_layout()\n",
        "    save_figure(fig, 'rm_map_asr.png')\n",
        "    plt.show()"
      ],
      "id": "fig-rm-map-asr",
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "code",
      "metadata": {
        "fig-width": 14,
        "fig-height": 16
      },
      "source": [
        "#| label: fig-rm-heatmap-year\n",
        "#| fig-cap: Hospitalizations by comuna and year - All comunas\n",
        "\n",
        "all_comunas_list = total_by_comuna['comuna'].tolist()\n",
        "heatmap_year = comuna_counts.pivot_table(\n",
        "    index='comuna',\n",
        "    columns='year',\n",
        "    values='hospitalizations',\n",
        "    aggfunc='sum'\n",
        ").fillna(0)\n",
        "\n",
        "heatmap_year['total'] = heatmap_year.sum(axis=1)\n",
        "heatmap_year = heatmap_year.sort_values('total', ascending=False).drop(columns='total')\n",
        "\n",
        "fig, ax = plt.subplots(figsize=(14, 16))\n",
        "sns.heatmap(heatmap_year, annot=True, fmt='.0f', cmap='Blues', \n",
        "            cbar_kws={'label': 'Hospitalizations'}, ax=ax, annot_kws={'size': 7})\n",
        "ax.set_title('Hospitalizations by Comuna and Year - All Comunas (RM)', fontweight='bold', fontsize=14)\n",
        "ax.set_xlabel('Year')\n",
        "ax.set_ylabel('Comuna')\n",
        "\n",
        "plt.tight_layout()\n",
        "save_figure(fig, 'rm_comuna_year_heatmap.png')\n",
        "plt.show()"
      ],
      "id": "fig-rm-heatmap-year",
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "code",
      "metadata": {},
      "source": [
        "#| label: tbl-rm-stats\n",
        "#| tbl-cap: Summary statistics - Metropolitan Region\n",
        "#| tbl-cap-location: bottom\n",
        "\n",
        "main_icd_rm = rm_data.groupby('icd_code').size().idxmax()\n",
        "main_icd_desc = ALL_NEURODEG_CODES.get(main_icd_rm, '')\n",
        "\n",
        "rm_stats = pd.DataFrame({\n",
        "    'Metric': [\n",
        "        'Total Hospitalizations',\n",
        "        'Unique Comunas',\n",
        "        'Years Covered',\n",
        "        'Mean Annual Hospitalizations',\n",
        "        'Main Comuna',\n",
        "        'Most Common Disease (RM)',\n",
        "        'ICD Codes Present'\n",
        "    ],\n",
        "    'Value': [\n",
        "        f\"{len(rm_data):,}\",\n",
        "        rm_data['comuna'].nunique(),\n",
        "        f\"{rm_data['year'].nunique()} ({rm_data['year'].min()}-{rm_data['year'].max()})\",\n",
        "        f\"{len(rm_data) / rm_data['year'].nunique():,.0f}\",\n",
        "        total_by_comuna.iloc[0]['comuna'] if len(total_by_comuna) > 0 else 'N/A',\n",
        "        f\"{main_icd_rm} ({main_icd_desc})\",\n",
        "        rm_data['icd_code'].nunique()\n",
        "    ]\n",
        "})\n",
        "\n",
        "rm_stats.style.hide(axis=\"index\")"
      ],
      "id": "tbl-rm-stats",
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "markdown",
      "metadata": {},
      "source": [
        "\\newpage\n",
        "\n",
        "## Separate Analysis: F-codes (Dementia) vs G-codes (Neurological)"
      ],
      "id": "562fa46c"
    },
    {
      "cell_type": "code",
      "metadata": {},
      "source": [
        "#| label: separate-fg-data\n",
        "#| include: false\n",
        "\n",
        "# Separar códigos F (demencias) y G (otras enfermedades neurológicas)\n",
        "F_CODES = list(NEURODEG_CODES_MAIN.keys())\n",
        "G_CODES = list(NEURODEG_CODES_OTHER.keys())\n",
        "\n",
        "# Filtrar datos nacionales\n",
        "hosp_f = hospitalizations[hospitalizations['icd_code'].isin(F_CODES)].copy()\n",
        "hosp_g = hospitalizations[hospitalizations['icd_code'].isin(G_CODES)].copy()\n",
        "\n",
        "# Filtrar datos regionales\n",
        "regional_f = regional_data[regional_data['icd_code'].isin(F_CODES)].copy()\n",
        "regional_g = regional_data[regional_data['icd_code'].isin(G_CODES)].copy()\n",
        "\n",
        "# Calcular ASR nacional para F y G\n",
        "asr_f = calculate_asr_sex_columns(hosp_f, population)\n",
        "asr_g = calculate_asr_sex_columns(hosp_g, population)\n",
        "\n",
        "# Calcular ASR regional para F y G\n",
        "regional_asr_f = calculate_regional_asr(regional_f, population_regional if population_regional is not None else population)\n",
        "regional_asr_g = calculate_regional_asr(regional_g, population_regional if population_regional is not None else population)\n",
        "\n",
        "mean_asr_f = regional_asr_f.groupby('region')['asr'].mean().reset_index()\n",
        "mean_asr_f.columns = ['region', 'mean_asr_f']\n",
        "\n",
        "mean_asr_g = regional_asr_g.groupby('region')['asr'].mean().reset_index()\n",
        "mean_asr_g.columns = ['region', 'mean_asr_g']"
      ],
      "id": "separate-fg-data",
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "markdown",
      "metadata": {},
      "source": [
        "### F-codes: Dementia and Mental Disorders (F00-F07)"
      ],
      "id": "5154570b"
    },
    {
      "cell_type": "code",
      "metadata": {},
      "source": [
        "#| label: tbl-f-codes-list\n",
        "#| tbl-cap: F-codes included in analysis\n",
        "#| tbl-cap-location: bottom\n",
        "\n",
        "f_codes_df = pd.DataFrame([\n",
        "    {'ICD Code': k, 'Description': v} for k, v in NEURODEG_CODES_MAIN.items()\n",
        "])\n",
        "f_codes_df.style.hide(axis=\"index\")"
      ],
      "id": "tbl-f-codes-list",
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "code",
      "metadata": {},
      "source": [
        "#| label: tbl-asr-f-national\n",
        "#| tbl-cap: Age-standardized rates - F-codes (Dementia) - National\n",
        "#| tbl-cap-location: bottom\n",
        "\n",
        "asr_f.style.format({\n",
        "    'hosp_male': '{:,.0f}', 'hosp_female': '{:,.0f}', 'hosp_total': '{:,.0f}',\n",
        "    'pop_male': '{:,.0f}', 'pop_female': '{:,.0f}', 'pop_total': '{:,.0f}',\n",
        "    'crude_rate_male': '{:.2f}', 'crude_rate_female': '{:.2f}', 'crude_rate_total': '{:.2f}',\n",
        "    'asr_male': '{:.2f}', 'asr_female': '{:.2f}', 'asr_total': '{:.2f}'\n",
        "}).hide(axis=\"index\")"
      ],
      "id": "tbl-asr-f-national",
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "code",
      "metadata": {},
      "source": [
        "#| label: tbl-asr-f-regional\n",
        "#| tbl-cap: Mean ASR by region - F-codes (Dementia)\n",
        "#| tbl-cap-location: bottom\n",
        "\n",
        "regional_asr_f_pivot = regional_asr_f.pivot_table(\n",
        "    index='region', columns='year', values='asr', aggfunc='first'\n",
        ").reset_index()\n",
        "regional_asr_f_pivot['Mean ASR'] = regional_asr_f_pivot[[c for c in regional_asr_f_pivot.columns if c != 'region']].mean(axis=1).round(2)\n",
        "regional_asr_f_pivot = regional_asr_f_pivot.sort_values('Mean ASR', ascending=False)\n",
        "\n",
        "year_cols = [c for c in regional_asr_f_pivot.columns if isinstance(c, (int, float)) and c != 'Mean ASR']\n",
        "format_dict = {col: '{:.2f}' for col in year_cols + ['Mean ASR']}\n",
        "regional_asr_f_pivot.style.format(format_dict, na_rep='-').background_gradient(\n",
        "    cmap='Blues', subset=['Mean ASR']\n",
        ").hide(axis=\"index\")"
      ],
      "id": "tbl-asr-f-regional",
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "code",
      "metadata": {
        "fig-width": 12,
        "fig-height": 5
      },
      "source": [
        "#| label: fig-asr-f-trend\n",
        "#| fig-cap: ASR trend - F-codes (Dementia) by sex\n",
        "\n",
        "fig, axes = plt.subplots(1, 2, figsize=(12, 5))\n",
        "\n",
        "ax1 = axes[0]\n",
        "ax1.plot(asr_f['year'], asr_f['asr_male'], marker='o', linewidth=2, label='Male', color='steelblue')\n",
        "ax1.plot(asr_f['year'], asr_f['asr_female'], marker='s', linewidth=2, label='Female', color='coral')\n",
        "ax1.plot(asr_f['year'], asr_f['asr_total'], marker='^', linewidth=2, label='Total', color='forestgreen', linestyle='--')\n",
        "ax1.set_xlabel('Year')\n",
        "ax1.set_ylabel('ASR (per 100,000)')\n",
        "ax1.set_title('F-codes (Dementia) - ASR by Sex', fontweight='bold')\n",
        "ax1.legend()\n",
        "ax1.grid(True, alpha=0.3)\n",
        "ax1.set_xticks(YEARS)\n",
        "\n",
        "ax2 = axes[1]\n",
        "all_regions_f = mean_asr_f['region'].tolist()\n",
        "for region in all_regions_f:\n",
        "    df_reg = regional_asr_f[regional_asr_f['region'] == region]\n",
        "    ax2.plot(df_reg['year'], df_reg['asr'], marker='o', linewidth=1.5, markersize=4, label=region)\n",
        "ax2.set_xlabel('Year')\n",
        "ax2.set_ylabel('ASR (per 100,000)')\n",
        "ax2.set_title('F-codes - All Regions', fontweight='bold')\n",
        "ax2.legend(bbox_to_anchor=(1.02, 1), loc='upper left', fontsize=7)\n",
        "ax2.grid(True, alpha=0.3)\n",
        "ax2.set_xticks(YEARS)\n",
        "\n",
        "plt.tight_layout()\n",
        "save_figure(fig, 'asr_f_codes.png')\n",
        "plt.show()"
      ],
      "id": "fig-asr-f-trend",
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "markdown",
      "metadata": {},
      "source": [
        "\\newpage\n",
        "\n",
        "### G-codes: Neurological Disorders (G10-G35)"
      ],
      "id": "7ceef934"
    },
    {
      "cell_type": "code",
      "metadata": {},
      "source": [
        "#| label: tbl-g-codes-list\n",
        "#| tbl-cap: G-codes included in analysis\n",
        "#| tbl-cap-location: bottom\n",
        "\n",
        "g_codes_df = pd.DataFrame([\n",
        "    {'ICD Code': k, 'Description': v} for k, v in NEURODEG_CODES_OTHER.items()\n",
        "])\n",
        "g_codes_df.style.hide(axis=\"index\")"
      ],
      "id": "tbl-g-codes-list",
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "code",
      "metadata": {},
      "source": [
        "#| label: tbl-asr-g-national\n",
        "#| tbl-cap: Age-standardized rates - G-codes (Neurological) - National\n",
        "#| tbl-cap-location: bottom\n",
        "\n",
        "asr_g.style.format({\n",
        "    'hosp_male': '{:,.0f}', 'hosp_female': '{:,.0f}', 'hosp_total': '{:,.0f}',\n",
        "    'pop_male': '{:,.0f}', 'pop_female': '{:,.0f}', 'pop_total': '{:,.0f}',\n",
        "    'crude_rate_male': '{:.2f}', 'crude_rate_female': '{:.2f}', 'crude_rate_total': '{:.2f}',\n",
        "    'asr_male': '{:.2f}', 'asr_female': '{:.2f}', 'asr_total': '{:.2f}'\n",
        "}).hide(axis=\"index\")"
      ],
      "id": "tbl-asr-g-national",
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "code",
      "metadata": {},
      "source": [
        "#| label: tbl-asr-g-regional\n",
        "#| tbl-cap: Mean ASR by region - G-codes (Neurological)\n",
        "#| tbl-cap-location: bottom\n",
        "\n",
        "regional_asr_g_pivot = regional_asr_g.pivot_table(\n",
        "    index='region', columns='year', values='asr', aggfunc='first'\n",
        ").reset_index()\n",
        "regional_asr_g_pivot['Mean ASR'] = regional_asr_g_pivot[[c for c in regional_asr_g_pivot.columns if c != 'region']].mean(axis=1).round(2)\n",
        "regional_asr_g_pivot = regional_asr_g_pivot.sort_values('Mean ASR', ascending=False)\n",
        "\n",
        "year_cols = [c for c in regional_asr_g_pivot.columns if isinstance(c, (int, float)) and c != 'Mean ASR']\n",
        "format_dict = {col: '{:.2f}' for col in year_cols + ['Mean ASR']}\n",
        "regional_asr_g_pivot.style.format(format_dict, na_rep='-').background_gradient(\n",
        "    cmap='Greens', subset=['Mean ASR']\n",
        ").hide(axis=\"index\")"
      ],
      "id": "tbl-asr-g-regional",
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "code",
      "metadata": {
        "fig-width": 14,
        "fig-height": 6
      },
      "source": [
        "#| label: fig-asr-g-trend\n",
        "#| fig-cap: ASR trend - G-codes (Neurological) by sex\n",
        "\n",
        "fig, axes = plt.subplots(1, 2, figsize=(14, 6))\n",
        "\n",
        "ax1 = axes[0]\n",
        "ax1.plot(asr_g['year'], asr_g['asr_male'], marker='o', linewidth=2, label='Male', color='steelblue')\n",
        "ax1.plot(asr_g['year'], asr_g['asr_female'], marker='s', linewidth=2, label='Female', color='coral')\n",
        "ax1.plot(asr_g['year'], asr_g['asr_total'], marker='^', linewidth=2, label='Total', color='forestgreen', linestyle='--')\n",
        "ax1.set_xlabel('Year')\n",
        "ax1.set_ylabel('ASR (per 100,000)')\n",
        "ax1.set_title('G-codes (Neurological) - ASR by Sex', fontweight='bold')\n",
        "ax1.legend()\n",
        "ax1.grid(True, alpha=0.3)\n",
        "ax1.set_xticks(YEARS)\n",
        "\n",
        "ax2 = axes[1]\n",
        "all_regions_g = mean_asr_g['region'].tolist()\n",
        "for region in all_regions_g:\n",
        "    df_reg = regional_asr_g[regional_asr_g['region'] == region]\n",
        "    ax2.plot(df_reg['year'], df_reg['asr'], marker='o', linewidth=1.5, markersize=4, label=region)\n",
        "ax2.set_xlabel('Year')\n",
        "ax2.set_ylabel('ASR (per 100,000)')\n",
        "ax2.set_title('G-codes - All Regions', fontweight='bold')\n",
        "ax2.legend(bbox_to_anchor=(1.02, 1), loc='upper left', fontsize=7)\n",
        "ax2.grid(True, alpha=0.3)\n",
        "ax2.set_xticks(YEARS)\n",
        "\n",
        "plt.tight_layout()\n",
        "save_figure(fig, 'asr_g_codes.png')\n",
        "plt.show()"
      ],
      "id": "fig-asr-g-trend",
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "markdown",
      "metadata": {},
      "source": [
        "\\newpage\n",
        "\n",
        "### F vs G Comparison"
      ],
      "id": "8b0b8add"
    },
    {
      "cell_type": "code",
      "metadata": {
        "fig-width": 14,
        "fig-height": 10
      },
      "source": [
        "#| label: fig-fg-comparison\n",
        "#| fig-cap: Comparison of F-codes (Dementia) vs G-codes (Neurological)\n",
        "\n",
        "fig, axes = plt.subplots(2, 2, figsize=(14, 10))\n",
        "\n",
        "# Nacional F vs G\n",
        "ax1 = axes[0, 0]\n",
        "ax1.plot(asr_f['year'], asr_f['asr_total'], marker='o', linewidth=2, label='F-codes (Dementia)', color='royalblue')\n",
        "ax1.plot(asr_g['year'], asr_g['asr_total'], marker='s', linewidth=2, label='G-codes (Neurological)', color='seagreen')\n",
        "ax1.set_xlabel('Year')\n",
        "ax1.set_ylabel('ASR (per 100,000)')\n",
        "ax1.set_title('National ASR: F vs G codes', fontweight='bold')\n",
        "ax1.legend()\n",
        "ax1.grid(True, alpha=0.3)\n",
        "ax1.set_xticks(YEARS)\n",
        "\n",
        "# Comparación regional\n",
        "ax2 = axes[0, 1]\n",
        "comparison = mean_asr_f.merge(mean_asr_g, on='region', how='outer')\n",
        "comparison = comparison.sort_values('mean_asr_f', ascending=True)\n",
        "y_pos = range(len(comparison))\n",
        "ax2.barh([y - 0.2 for y in y_pos], comparison['mean_asr_f'], height=0.4, label='F-codes', color='royalblue')\n",
        "ax2.barh([y + 0.2 for y in y_pos], comparison['mean_asr_g'], height=0.4, label='G-codes', color='seagreen')\n",
        "ax2.set_yticks(y_pos)\n",
        "ax2.set_yticklabels(comparison['region'])\n",
        "ax2.set_xlabel('Mean ASR (per 100,000)')\n",
        "ax2.set_title('Regional Comparison: F vs G', fontweight='bold')\n",
        "ax2.legend()\n",
        "ax2.grid(True, alpha=0.3, axis='x')\n",
        "\n",
        "# Heatmap F by region\n",
        "ax3 = axes[1, 0]\n",
        "heatmap_f = regional_asr_f.pivot_table(index='region', columns='year', values='asr', aggfunc='first').fillna(0)\n",
        "heatmap_f = heatmap_f.reindex(mean_asr_f.sort_values('mean_asr_f', ascending=False)['region'])\n",
        "sns.heatmap(heatmap_f, annot=True, fmt='.1f', cmap='Blues', ax=ax3, cbar_kws={'label': 'ASR'})\n",
        "ax3.set_title('F-codes ASR by Region and Year', fontweight='bold')\n",
        "ax3.set_xlabel('Year')\n",
        "ax3.set_ylabel('Region')\n",
        "\n",
        "# Heatmap G by region\n",
        "ax4 = axes[1, 1]\n",
        "heatmap_g = regional_asr_g.pivot_table(index='region', columns='year', values='asr', aggfunc='first').fillna(0)\n",
        "heatmap_g = heatmap_g.reindex(mean_asr_g.sort_values('mean_asr_g', ascending=False)['region'])\n",
        "sns.heatmap(heatmap_g, annot=True, fmt='.1f', cmap='Greens', ax=ax4, cbar_kws={'label': 'ASR'})\n",
        "ax4.set_title('G-codes ASR by Region and Year', fontweight='bold')\n",
        "ax4.set_xlabel('Year')\n",
        "ax4.set_ylabel('Region')\n",
        "\n",
        "plt.tight_layout()\n",
        "save_figure(fig, 'fg_comparison.png')\n",
        "plt.show()"
      ],
      "id": "fig-fg-comparison",
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "code",
      "metadata": {},
      "source": [
        "#| label: tbl-fg-summary\n",
        "#| tbl-cap: Summary comparison F-codes vs G-codes\n",
        "#| tbl-cap-location: bottom\n",
        "\n",
        "total_f = hosp_f['hospitalizations'].sum()\n",
        "total_g = hosp_g['hospitalizations'].sum()\n",
        "\n",
        "summary_fg = pd.DataFrame({\n",
        "    'Category': ['F-codes (Dementia)', 'G-codes (Neurological)'],\n",
        "    'Total Hospitalizations': [total_f, total_g],\n",
        "    'Mean Annual ASR (Total)': [asr_f['asr_total'].mean().round(2), asr_g['asr_total'].mean().round(2)],\n",
        "    'Mean Annual ASR (Male)': [asr_f['asr_male'].mean().round(2), asr_g['asr_male'].mean().round(2)],\n",
        "    'Mean Annual ASR (Female)': [asr_f['asr_female'].mean().round(2), asr_g['asr_female'].mean().round(2)],\n",
        "    'Regions with data': [regional_asr_f['region'].nunique(), regional_asr_g['region'].nunique()]\n",
        "})\n",
        "\n",
        "summary_fg.style.format({\n",
        "    'Total Hospitalizations': '{:,.0f}',\n",
        "    'Mean Annual ASR (Total)': '{:.2f}',\n",
        "    'Mean Annual ASR (Male)': '{:.2f}',\n",
        "    'Mean Annual ASR (Female)': '{:.2f}'\n",
        "}).hide(axis=\"index\")"
      ],
      "id": "tbl-fg-summary",
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "markdown",
      "metadata": {},
      "source": [
        "\\newpage\n",
        "\n",
        "### F vs G Analysis - Metropolitan Region Comunas"
      ],
      "id": "70da4ceb"
    },
    {
      "cell_type": "code",
      "metadata": {},
      "source": [
        "#| label: fg-rm-data\n",
        "#| include: false\n",
        "\n",
        "rm_f = rm_data[rm_data['icd_code'].isin(F_CODES)].copy()\n",
        "rm_g = rm_data[rm_data['icd_code'].isin(G_CODES)].copy()\n",
        "\n",
        "def calculate_comuna_asr_subset(df, pop_df, per=100000):\n",
        "    \"\"\"Calculate ASR by comuna for a subset of data.\"\"\"\n",
        "    who_weights = pd.DataFrame([\n",
        "        {'age_group': k, 'who_weight': v} for k, v in WHO_STANDARD_POPULATION.items()\n",
        "    ])\n",
        "    \n",
        "    if len(df) == 0:\n",
        "        return pd.DataFrame(columns=['comuna', 'hospitalizations', 'asr'])\n",
        "    \n",
        "    df = df.copy()\n",
        "    df['comuna_norm'] = df['comuna'].apply(normalize_comuna)\n",
        "    hosp_agg = df.groupby(['comuna_norm', 'year', 'age_group', 'sex']).size().reset_index(name='hospitalizations')\n",
        "    \n",
        "    pop_agg = pop_df.groupby(['comuna_norm', 'year', 'age_group', 'sex'])['population'].sum().reset_index()\n",
        "    \n",
        "    merged = hosp_agg.merge(pop_agg, on=['comuna_norm', 'year', 'age_group', 'sex'], how='left')\n",
        "    merged = merged.dropna(subset=['population'])\n",
        "    merged = merged[merged['population'] > 0]\n",
        "    \n",
        "    if len(merged) == 0:\n",
        "        return pd.DataFrame(columns=['comuna', 'hospitalizations', 'asr'])\n",
        "    \n",
        "    merged['age_specific_rate'] = (merged['hospitalizations'] / merged['population']) * per\n",
        "    merged = merged.merge(who_weights, on='age_group', how='left')\n",
        "    merged['weighted_rate'] = merged['age_specific_rate'] * merged['who_weight']\n",
        "    \n",
        "    result = merged.groupby('comuna_norm').agg({\n",
        "        'hospitalizations': 'sum',\n",
        "        'weighted_rate': 'sum'\n",
        "    }).reset_index()\n",
        "    \n",
        "    result['asr'] = (result['weighted_rate'] / TOTAL_WHO_WEIGHT).round(2)\n",
        "    \n",
        "    comuna_map = df.drop_duplicates('comuna_norm')[['comuna', 'comuna_norm']]\n",
        "    result = result.merge(comuna_map, on='comuna_norm', how='left')\n",
        "    \n",
        "    return result[['comuna', 'hospitalizations', 'asr']]\n",
        "\n",
        "comuna_asr_f = calculate_comuna_asr_subset(rm_f, pop_rm)\n",
        "comuna_asr_g = calculate_comuna_asr_subset(rm_g, pop_rm)\n",
        "\n",
        "comuna_asr_f = comuna_asr_f.sort_values('asr', ascending=False)\n",
        "comuna_asr_g = comuna_asr_g.sort_values('asr', ascending=False)\n",
        "\n",
        "total_by_comuna_f = rm_f.groupby('comuna').size().reset_index(name='total_f')\n",
        "total_by_comuna_g = rm_g.groupby('comuna').size().reset_index(name='total_g')"
      ],
      "id": "fg-rm-data",
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "code",
      "metadata": {},
      "source": [
        "#| label: tbl-rm-f-comunas\n",
        "#| tbl-cap: F-codes (Dementia) ASR by Comuna - Metropolitan Region\n",
        "#| tbl-cap-location: bottom\n",
        "\n",
        "display_f = comuna_asr_f.merge(total_by_comuna_f, on='comuna', how='left')\n",
        "display_f = display_f[['comuna', 'total_f', 'asr']].copy()\n",
        "display_f.columns = ['Comuna', 'Hospitalizations', 'ASR']\n",
        "display_f = display_f.sort_values('ASR', ascending=False)\n",
        "display_f.style.format({'Hospitalizations': '{:,.0f}', 'ASR': '{:.2f}'}, na_rep='-').hide(axis=\"index\")"
      ],
      "id": "tbl-rm-f-comunas",
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "code",
      "metadata": {},
      "source": [
        "#| label: tbl-rm-g-comunas\n",
        "#| tbl-cap: G-codes (Neurological) ASR by Comuna - Metropolitan Region\n",
        "#| tbl-cap-location: bottom\n",
        "\n",
        "display_g = comuna_asr_g.merge(total_by_comuna_g, on='comuna', how='left')\n",
        "display_g = display_g[['comuna', 'total_g', 'asr']].copy()\n",
        "display_g.columns = ['Comuna', 'Hospitalizations', 'ASR']\n",
        "display_g = display_g.sort_values('ASR', ascending=False)\n",
        "display_g.style.format({'Hospitalizations': '{:,.0f}', 'ASR': '{:.2f}'}, na_rep='-').hide(axis=\"index\")"
      ],
      "id": "tbl-rm-g-comunas",
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "code",
      "metadata": {
        "fig-width": 18,
        "fig-height": 16
      },
      "source": [
        "#| label: fig-fg-rm-comparison\n",
        "#| fig-cap: F vs G codes comparison - Metropolitan Region Comunas\n",
        "\n",
        "fig, axes = plt.subplots(2, 2, figsize=(18, 16))\n",
        "\n",
        "# Todas comunas F-codes\n",
        "ax1 = axes[0, 0]\n",
        "if len(comuna_asr_f) > 0:\n",
        "    all_f = comuna_asr_f.sort_values('asr', ascending=True)\n",
        "    colors_f = plt.cm.Blues(np.linspace(0.3, 0.9, len(all_f)))\n",
        "    ax1.barh(all_f['comuna'], all_f['asr'], color=colors_f)\n",
        "    ax1.set_xlabel('ASR (per 100,000)')\n",
        "    ax1.set_title('F-codes (Dementia) - All Comunas', fontweight='bold')\n",
        "    ax1.grid(True, alpha=0.3, axis='x')\n",
        "else:\n",
        "    ax1.text(0.5, 0.5, 'No data', ha='center', va='center', transform=ax1.transAxes)\n",
        "    ax1.set_title('F-codes (Dementia)', fontweight='bold')\n",
        "\n",
        "# Todas comunas G-codes\n",
        "ax2 = axes[0, 1]\n",
        "if len(comuna_asr_g) > 0:\n",
        "    all_g = comuna_asr_g.sort_values('asr', ascending=True)\n",
        "    colors_g = plt.cm.Greens(np.linspace(0.3, 0.9, len(all_g)))\n",
        "    ax2.barh(all_g['comuna'], all_g['asr'], color=colors_g)\n",
        "    ax2.set_xlabel('ASR (per 100,000)')\n",
        "    ax2.set_title('G-codes (Neurological) - All Comunas', fontweight='bold')\n",
        "    ax2.grid(True, alpha=0.3, axis='x')\n",
        "else:\n",
        "    ax2.text(0.5, 0.5, 'No data', ha='center', va='center', transform=ax2.transAxes)\n",
        "    ax2.set_title('G-codes (Neurological)', fontweight='bold')\n",
        "\n",
        "# Comparación F vs G por comuna\n",
        "ax3 = axes[1, 0]\n",
        "if len(comuna_asr_f) > 0 and len(comuna_asr_g) > 0:\n",
        "    comparison_rm = comuna_asr_f[['comuna', 'asr']].rename(columns={'asr': 'asr_f'}).merge(\n",
        "        comuna_asr_g[['comuna', 'asr']].rename(columns={'asr': 'asr_g'}),\n",
        "        on='comuna', how='outer'\n",
        "    ).fillna(0)\n",
        "    comparison_rm['total_asr'] = comparison_rm['asr_f'] + comparison_rm['asr_g']\n",
        "    comparison_rm = comparison_rm.sort_values('total_asr', ascending=True)\n",
        "    \n",
        "    y_pos = range(len(comparison_rm))\n",
        "    ax3.barh([y - 0.2 for y in y_pos], comparison_rm['asr_f'], height=0.4, label='F-codes', color='royalblue')\n",
        "    ax3.barh([y + 0.2 for y in y_pos], comparison_rm['asr_g'], height=0.4, label='G-codes', color='seagreen')\n",
        "    ax3.set_yticks(y_pos)\n",
        "    ax3.set_yticklabels(comparison_rm['comuna'], fontsize=7)\n",
        "    ax3.set_xlabel('ASR (per 100,000)')\n",
        "    ax3.set_title('F vs G Comparison - All Comunas', fontweight='bold')\n",
        "    ax3.legend()\n",
        "    ax3.grid(True, alpha=0.3, axis='x')\n",
        "else:\n",
        "    ax3.text(0.5, 0.5, 'Insufficient data', ha='center', va='center', transform=ax3.transAxes)\n",
        "    ax3.set_title('F vs G Comparison', fontweight='bold')\n",
        "\n",
        "# Scatter F vs G\n",
        "ax4 = axes[1, 1]\n",
        "if len(comuna_asr_f) > 0 and len(comuna_asr_g) > 0:\n",
        "    scatter_data = comuna_asr_f[['comuna', 'asr']].rename(columns={'asr': 'asr_f'}).merge(\n",
        "        comuna_asr_g[['comuna', 'asr']].rename(columns={'asr': 'asr_g'}),\n",
        "        on='comuna', how='inner'\n",
        "    )\n",
        "    if len(scatter_data) > 0:\n",
        "        ax4.scatter(scatter_data['asr_f'], scatter_data['asr_g'], alpha=0.6, s=50, c='purple')\n",
        "        for _, row in scatter_data.iterrows():\n",
        "            ax4.annotate(row['comuna'][:12], (row['asr_f'], row['asr_g']), fontsize=6)\n",
        "        ax4.set_xlabel('F-codes ASR (per 100,000)')\n",
        "        ax4.set_ylabel('G-codes ASR (per 100,000)')\n",
        "        ax4.set_title('F vs G ASR Scatter - All Comunas RM', fontweight='bold')\n",
        "        ax4.grid(True, alpha=0.3)\n",
        "        max_val = max(scatter_data['asr_f'].max(), scatter_data['asr_g'].max())\n",
        "        ax4.plot([0, max_val], [0, max_val], 'k--', alpha=0.3, label='Equal line')\n",
        "    else:\n",
        "        ax4.text(0.5, 0.5, 'No matching data', ha='center', va='center', transform=ax4.transAxes)\n",
        "else:\n",
        "    ax4.text(0.5, 0.5, 'Insufficient data', ha='center', va='center', transform=ax4.transAxes)\n",
        "    ax4.set_title('F vs G ASR Scatter', fontweight='bold')\n",
        "\n",
        "plt.tight_layout()\n",
        "save_figure(fig, 'fg_rm_comparison.png')\n",
        "plt.show()"
      ],
      "id": "fig-fg-rm-comparison",
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "code",
      "metadata": {},
      "source": [
        "#| label: tbl-fg-rm-summary\n",
        "#| tbl-cap: F vs G Summary - Metropolitan Region\n",
        "#| tbl-cap-location: bottom\n",
        "\n",
        "total_f_rm = len(rm_f)\n",
        "total_g_rm = len(rm_g)\n",
        "\n",
        "mean_asr_f_rm = comuna_asr_f['asr'].mean() if len(comuna_asr_f) > 0 else 0\n",
        "mean_asr_g_rm = comuna_asr_g['asr'].mean() if len(comuna_asr_g) > 0 else 0\n",
        "\n",
        "main_comuna_f = comuna_asr_f.iloc[0]['comuna'] if len(comuna_asr_f) > 0 else 'N/A'\n",
        "main_comuna_g = comuna_asr_g.iloc[0]['comuna'] if len(comuna_asr_g) > 0 else 'N/A'\n",
        "\n",
        "summary_fg_rm = pd.DataFrame({\n",
        "    'Category': ['F-codes (Dementia)', 'G-codes (Neurological)'],\n",
        "    'Total Hospitalizations (RM)': [total_f_rm, total_g_rm],\n",
        "    'Mean ASR (Comunas)': [round(mean_asr_f_rm, 2), round(mean_asr_g_rm, 2)],\n",
        "    'Comunas with data': [len(comuna_asr_f), len(comuna_asr_g)],\n",
        "    'Main Comuna (ASR)': [main_comuna_f, main_comuna_g]\n",
        "})\n",
        "\n",
        "summary_fg_rm.style.format({\n",
        "    'Total Hospitalizations (RM)': '{:,.0f}',\n",
        "    'Mean ASR (Comunas)': '{:.2f}'\n",
        "}).hide(axis=\"index\")"
      ],
      "id": "tbl-fg-rm-summary",
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "code",
      "metadata": {
        "fig-width": 18,
        "fig-height": 16
      },
      "source": [
        "#| label: fig-fg-rm-heatmaps\n",
        "#| fig-cap: F and G codes Hospitalizations by Comuna and Year - All Comunas RM\n",
        "\n",
        "fig, axes = plt.subplots(1, 2, figsize=(18, 16))\n",
        "\n",
        "# Heatmap F por comuna y año\n",
        "ax1 = axes[0]\n",
        "if len(rm_f) > 0:\n",
        "    all_comunas_f = comuna_asr_f['comuna'].tolist()\n",
        "    rm_f_yearly = rm_f.groupby(['comuna', 'year']).size().reset_index(name='count')\n",
        "    heatmap_f_data = rm_f_yearly.pivot_table(\n",
        "        index='comuna', columns='year', values='count', aggfunc='sum'\n",
        "    ).fillna(0)\n",
        "    heatmap_f_data['total'] = heatmap_f_data.sum(axis=1)\n",
        "    heatmap_f_data = heatmap_f_data.sort_values('total', ascending=False).drop(columns='total')\n",
        "    sns.heatmap(heatmap_f_data, annot=True, fmt='.0f', cmap='Blues', ax=ax1, \n",
        "                cbar_kws={'label': 'Hospitalizations'}, annot_kws={'size': 7})\n",
        "    ax1.set_title('F-codes by Comuna and Year - All Comunas', fontweight='bold')\n",
        "    ax1.set_xlabel('Year')\n",
        "    ax1.set_ylabel('Comuna')\n",
        "else:\n",
        "    ax1.text(0.5, 0.5, 'No F-code data', ha='center', va='center', transform=ax1.transAxes)\n",
        "    ax1.set_title('F-codes', fontweight='bold')\n",
        "\n",
        "# Heatmap G por comuna y año\n",
        "ax2 = axes[1]\n",
        "if len(rm_g) > 0:\n",
        "    all_comunas_g = comuna_asr_g['comuna'].tolist()\n",
        "    rm_g_yearly = rm_g.groupby(['comuna', 'year']).size().reset_index(name='count')\n",
        "    heatmap_g_data = rm_g_yearly.pivot_table(\n",
        "        index='comuna', columns='year', values='count', aggfunc='sum'\n",
        "    ).fillna(0)\n",
        "    heatmap_g_data['total'] = heatmap_g_data.sum(axis=1)\n",
        "    heatmap_g_data = heatmap_g_data.sort_values('total', ascending=False).drop(columns='total')\n",
        "    sns.heatmap(heatmap_g_data, annot=True, fmt='.0f', cmap='Greens', ax=ax2, \n",
        "                cbar_kws={'label': 'Hospitalizations'}, annot_kws={'size': 7})\n",
        "    ax2.set_title('G-codes by Comuna and Year - All Comunas', fontweight='bold')\n",
        "    ax2.set_xlabel('Year')\n",
        "    ax2.set_ylabel('Comuna')\n",
        "else:\n",
        "    ax2.text(0.5, 0.5, 'No G-code data', ha='center', va='center', transform=ax2.transAxes)\n",
        "    ax2.set_title('G-codes', fontweight='bold')\n",
        "\n",
        "plt.tight_layout()\n",
        "save_figure(fig, 'fg_rm_heatmaps.png')\n",
        "plt.show()"
      ],
      "id": "fig-fg-rm-heatmaps",
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "markdown",
      "metadata": {},
      "source": [
        "\\newpage\n",
        "\n",
        "## Spatial Analysis - F and G codes (Gran Santiago)"
      ],
      "id": "551b890c"
    },
    {
      "cell_type": "code",
      "metadata": {},
      "source": [
        "#| label: load-spatial-libs\n",
        "#| include: false\n",
        "\n",
        "from libpysal.weights import Queen\n",
        "from esda.moran import Moran, Moran_Local\n",
        "from splot.esda import moran_scatterplot, plot_moran\n",
        "from matplotlib.patches import Patch\n",
        "\n",
        "shp_candidates = [\n",
        "    os.path.join(data_path, 'comunas.shp'),\n",
        "    '/mnt/user-data/uploads/comunas.shp',\n",
        "    os.path.join(os.getcwd(), 'comunas.shp'),\n",
        "    os.path.join(os.getcwd(), 'data', 'comunas.shp')\n",
        "]\n",
        "\n",
        "shp_path = None\n",
        "for candidate in shp_candidates:\n",
        "    if os.path.exists(candidate):\n",
        "        shp_path = candidate\n",
        "        break\n",
        "\n",
        "gdf_gs = gpd.read_file(shp_path)\n",
        "\n",
        "def normalize_comuna_spatial(x):\n",
        "    if pd.isna(x):\n",
        "        return None\n",
        "    s = str(x).upper().strip()\n",
        "    s = s.encode('latin-1', errors='ignore').decode('latin-1', errors='ignore')\n",
        "    replacements = {\n",
        "        'Á': 'A', 'É': 'E', 'Í': 'I', 'Ó': 'O', 'Ú': 'U', 'Ñ': 'N',\n",
        "        'Ã\\x81': 'A', 'Ã\\x89': 'E', 'Ã\\x8d': 'I', 'Ã\\x93': 'O', 'Ã\\x9a': 'U',\n",
        "        'Ã\\x91': 'N', 'Ã±': 'N', 'Ã\"': 'O', 'Ã‰': 'E', 'Ã\\x89': 'E'\n",
        "    }\n",
        "    for old, new in replacements.items():\n",
        "        s = s.replace(old, new)\n",
        "    s = ''.join(c for c in s if c.isalnum() or c == ' ')\n",
        "    return s.strip()\n",
        "\n",
        "gdf_gs = gpd.read_file(shp_path)\n",
        "\n",
        "# 1) Filtrar a Región Metropolitana completa (codregion = 13)\n",
        "gdf_gs[\"codregion\"] = pd.to_numeric(gdf_gs[\"codregion\"], errors=\"coerce\")\n",
        "gdf_gs = gdf_gs[gdf_gs[\"codregion\"] == 13].copy()\n",
        "\n",
        "# 2) Normalizar comuna usando la columna correcta\n",
        "COMUNA_COL = \"Comuna\"\n",
        "gdf_gs[\"comuna_norm\"] = gdf_gs[COMUNA_COL].apply(normalize_comuna_spatial)\n",
        "gdf_gs[\"comuna_name\"] = gdf_gs[COMUNA_COL].astype(str)  # para tablas/anotaciones\n",
        "\n",
        "comuna_asr_f_copy = comuna_asr_f.copy()\n",
        "comuna_asr_f_copy['comuna_norm'] = comuna_asr_f_copy['comuna'].apply(normalize_comuna_spatial)\n",
        "\n",
        "comuna_asr_g_copy = comuna_asr_g.copy()\n",
        "comuna_asr_g_copy['comuna_norm'] = comuna_asr_g_copy['comuna'].apply(normalize_comuna_spatial)\n",
        "\n",
        "gdf_f = gdf_gs.merge(\n",
        "    comuna_asr_f_copy[['comuna_norm', 'asr']], \n",
        "    on='comuna_norm', \n",
        "    how='left'\n",
        ").rename(columns={'asr': 'asr_f'})\n",
        "\n",
        "gdf_fg = gdf_f.merge(\n",
        "    comuna_asr_g_copy[['comuna_norm', 'asr']], \n",
        "    on='comuna_norm', \n",
        "    how='left'\n",
        ").rename(columns={'asr': 'asr_g'})\n",
        "\n",
        "gdf_fg['asr_f'] = gdf_fg['asr_f'].fillna(0)\n",
        "gdf_fg['asr_g'] = gdf_fg['asr_g'].fillna(0)\n",
        "\n",
        "has_f_data = gdf_fg['asr_f'].sum() > 0\n",
        "has_g_data = gdf_fg['asr_g'].sum() > 0"
      ],
      "id": "load-spatial-libs",
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "markdown",
      "metadata": {},
      "source": [
        "### Choropleth Maps - ASR Distribution"
      ],
      "id": "209299cf"
    },
    {
      "cell_type": "code",
      "metadata": {
        "fig-width": 16,
        "fig-height": 8
      },
      "source": [
        "#| label: fig-spatial-choropleth\n",
        "#| fig-cap: ASR Distribution - F-codes (Dementia) and G-codes (Neurological) - Gran Santiago\n",
        "\n",
        "fig, axes = plt.subplots(1, 2, figsize=(16, 8))\n",
        "\n",
        "ax1 = axes[0]\n",
        "if has_f_data:\n",
        "    gdf_fg.plot(column='asr_f', cmap='Blues', linewidth=0.5, ax=ax1, edgecolor='0.5',\n",
        "                legend=True, legend_kwds={'label': 'ASR (per 100,000)', 'shrink': 0.6})\n",
        "    ax1.set_title('F-codes (Dementia) - ASR by Comuna', fontweight='bold', fontsize=12)\n",
        "else:\n",
        "    gdf_fg.plot(ax=ax1, color='lightgrey', edgecolor='0.5', linewidth=0.5)\n",
        "    ax1.set_title('F-codes - No data available', fontweight='bold', fontsize=12)\n",
        "ax1.set_axis_off()\n",
        "\n",
        "ax2 = axes[1]\n",
        "if has_g_data:\n",
        "    gdf_fg.plot(column='asr_g', cmap='Greens', linewidth=0.5, ax=ax2, edgecolor='0.5',\n",
        "                legend=True, legend_kwds={'label': 'ASR (per 100,000)', 'shrink': 0.6})\n",
        "    ax2.set_title('G-codes (Neurological) - ASR by Comuna', fontweight='bold', fontsize=12)\n",
        "else:\n",
        "    gdf_fg.plot(ax=ax2, color='lightgrey', edgecolor='0.5', linewidth=0.5)\n",
        "    ax2.set_title('G-codes - No data available', fontweight='bold', fontsize=12)\n",
        "ax2.set_axis_off()\n",
        "\n",
        "plt.suptitle('Age-Standardized Hospitalization Rates - Gran Santiago (2019-2024)', fontsize=14, fontweight='bold', y=1.02)\n",
        "plt.tight_layout()\n",
        "save_figure(fig, 'spatial_choropleth_fg.png')\n",
        "plt.show()"
      ],
      "id": "fig-spatial-choropleth",
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "markdown",
      "metadata": {},
      "source": [
        "### Global Moran's I - Spatial Autocorrelation"
      ],
      "id": "c2af806c"
    },
    {
      "cell_type": "code",
      "metadata": {},
      "source": [
        "#| label: spatial-moran-global\n",
        "#| include: false\n",
        "\n",
        "pesos = Queen.from_dataframe(gdf_fg)\n",
        "\n",
        "moran_f = None\n",
        "moran_g = None\n",
        "\n",
        "if has_f_data and gdf_fg['asr_f'].var() > 0:\n",
        "    moran_f = Moran(gdf_fg['asr_f'], pesos)\n",
        "\n",
        "if has_g_data and gdf_fg['asr_g'].var() > 0:\n",
        "    moran_g = Moran(gdf_fg['asr_g'], pesos)"
      ],
      "id": "spatial-moran-global",
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "code",
      "metadata": {},
      "source": [
        "#| label: tbl-moran-global\n",
        "#| tbl-cap: Global Moran's I - Spatial Autocorrelation Test\n",
        "#| tbl-cap-location: bottom\n",
        "\n",
        "moran_results = []\n",
        "\n",
        "if moran_f is not None:\n",
        "    moran_results.append({\n",
        "        'Variable': 'F-codes (Dementia)',\n",
        "        \"Moran's I\": round(moran_f.I, 4),\n",
        "        'E[I]': round(moran_f.EI, 4),\n",
        "        'Variance': round(moran_f.VI_norm, 6),\n",
        "        'Z-score': round(moran_f.z_norm, 4),\n",
        "        'P-value': round(moran_f.p_norm, 4),\n",
        "        'Interpretation': 'Clustered' if moran_f.I > 0 and moran_f.p_norm < 0.05 else ('Dispersed' if moran_f.I < 0 and moran_f.p_norm < 0.05 else 'Random')\n",
        "    })\n",
        "\n",
        "if moran_g is not None:\n",
        "    moran_results.append({\n",
        "        'Variable': 'G-codes (Neurological)',\n",
        "        \"Moran's I\": round(moran_g.I, 4),\n",
        "        'E[I]': round(moran_g.EI, 4),\n",
        "        'Variance': round(moran_g.VI_norm, 6),\n",
        "        'Z-score': round(moran_g.z_norm, 4),\n",
        "        'P-value': round(moran_g.p_norm, 4),\n",
        "        'Interpretation': 'Clustered' if moran_g.I > 0 and moran_g.p_norm < 0.05 else ('Dispersed' if moran_g.I < 0 and moran_g.p_norm < 0.05 else 'Random')\n",
        "    })\n",
        "\n",
        "moran_df = pd.DataFrame(moran_results)\n",
        "moran_df.style.format({\n",
        "    \"Moran's I\": '{:.4f}',\n",
        "    'E[I]': '{:.4f}',\n",
        "    'Variance': '{:.6f}',\n",
        "    'Z-score': '{:.4f}',\n",
        "    'P-value': '{:.4f}'\n",
        "}).hide(axis=\"index\")"
      ],
      "id": "tbl-moran-global",
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "code",
      "metadata": {
        "fig-width": 14,
        "fig-height": 6
      },
      "source": [
        "#| label: fig-moran-scatterplot\n",
        "#| fig-cap: Moran Scatterplot - Spatial Autocorrelation Visualization\n",
        "\n",
        "fig, axes = plt.subplots(1, 2, figsize=(14, 6))\n",
        "\n",
        "if moran_f is not None:\n",
        "    moran_scatterplot(moran_f, zstandard=True, ax=axes[0])\n",
        "    axes[0].set_title(f\"F-codes - Moran's I = {moran_f.I:.4f} (p = {moran_f.p_norm:.4f})\", fontweight='bold')\n",
        "else:\n",
        "    axes[0].text(0.5, 0.5, 'Insufficient F-code data\\nfor Moran analysis', ha='center', va='center', transform=axes[0].transAxes, fontsize=12)\n",
        "    axes[0].set_title('F-codes (Dementia)', fontweight='bold')\n",
        "\n",
        "if moran_g is not None:\n",
        "    moran_scatterplot(moran_g, zstandard=True, ax=axes[1])\n",
        "    axes[1].set_title(f\"G-codes - Moran's I = {moran_g.I:.4f} (p = {moran_g.p_norm:.4f})\", fontweight='bold')\n",
        "else:\n",
        "    axes[1].text(0.5, 0.5, 'Insufficient G-code data\\nfor Moran analysis', ha='center', va='center', transform=axes[1].transAxes, fontsize=12)\n",
        "    axes[1].set_title('G-codes (Neurological)', fontweight='bold')\n",
        "\n",
        "plt.suptitle(\"Global Moran's I - Spatial Autocorrelation\", fontsize=14, fontweight='bold', y=1.02)\n",
        "plt.tight_layout()\n",
        "save_figure(fig, 'moran_scatterplot_fg.png')\n",
        "plt.show()"
      ],
      "id": "fig-moran-scatterplot",
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "markdown",
      "metadata": {},
      "source": [
        "\\newpage\n",
        "\n",
        "### LISA - Local Indicators of Spatial Association"
      ],
      "id": "c9be3003"
    },
    {
      "cell_type": "code",
      "metadata": {},
      "source": [
        "#| label: lisa-calculation\n",
        "#| include: false\n",
        "\n",
        "def clasificar_lisa(lisa, data):\n",
        "    significativo = lisa.p_sim < 0.05\n",
        "    q = lisa.q\n",
        "    cluster_labels = ['No significativo'] * len(data)\n",
        "    for i in range(len(data)):\n",
        "        if significativo[i]:\n",
        "            if q[i] == 1: \n",
        "                cluster_labels[i] = 'High-High (Hot Spot)'\n",
        "            elif q[i] == 2: \n",
        "                cluster_labels[i] = 'Low-High'\n",
        "            elif q[i] == 3: \n",
        "                cluster_labels[i] = 'Low-Low (Cold Spot)'\n",
        "            elif q[i] == 4: \n",
        "                cluster_labels[i] = 'High-Low'\n",
        "    return cluster_labels\n",
        "\n",
        "lisa_f = None\n",
        "lisa_g = None\n",
        "\n",
        "if has_f_data and gdf_fg['asr_f'].var() > 0:\n",
        "    lisa_f = Moran_Local(gdf_fg['asr_f'], pesos)\n",
        "    gdf_fg['cluster_f'] = clasificar_lisa(lisa_f, gdf_fg)\n",
        "    gdf_fg['lisa_p_f'] = lisa_f.p_sim\n",
        "else:\n",
        "    gdf_fg['cluster_f'] = 'No data'\n",
        "    gdf_fg['lisa_p_f'] = 1.0\n",
        "\n",
        "if has_g_data and gdf_fg['asr_g'].var() > 0:\n",
        "    lisa_g = Moran_Local(gdf_fg['asr_g'], pesos)\n",
        "    gdf_fg['cluster_g'] = clasificar_lisa(lisa_g, gdf_fg)\n",
        "    gdf_fg['lisa_p_g'] = lisa_g.p_sim\n",
        "else:\n",
        "    gdf_fg['cluster_g'] = 'No data'\n",
        "    gdf_fg['lisa_p_g'] = 1.0"
      ],
      "id": "lisa-calculation",
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "code",
      "metadata": {},
      "source": [
        "#| label: tbl-lisa-clusters-f\n",
        "#| tbl-cap: LISA Clusters - F-codes (Dementia)\n",
        "#| tbl-cap-location: bottom\n",
        "\n",
        "clusters_f = gdf_fg.groupby('cluster_f').size().reset_index(name='N Comunas')\n",
        "clusters_f.columns = ['Cluster', 'N Comunas']\n",
        "clusters_f = clusters_f.sort_values('N Comunas', ascending=False)\n",
        "clusters_f.style.hide(axis=\"index\")"
      ],
      "id": "tbl-lisa-clusters-f",
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "code",
      "metadata": {},
      "source": [
        "#| label: tbl-lisa-clusters-g\n",
        "#| tbl-cap: LISA Clusters - G-codes (Neurological)\n",
        "#| tbl-cap-location: bottom\n",
        "\n",
        "clusters_g = gdf_fg.groupby('cluster_g').size().reset_index(name='N Comunas')\n",
        "clusters_g.columns = ['Cluster', 'N Comunas']\n",
        "clusters_g = clusters_g.sort_values('N Comunas', ascending=False)\n",
        "clusters_g.style.hide(axis=\"index\")"
      ],
      "id": "tbl-lisa-clusters-g",
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "code",
      "metadata": {
        "fig-width": 16,
        "fig-height": 8
      },
      "source": [
        "#| label: fig-lisa-maps\n",
        "#| fig-cap: LISA Cluster Maps - F-codes and G-codes\n",
        "\n",
        "colors_dict = {\n",
        "    'High-High (Hot Spot)': '#d73027',\n",
        "    'Low-Low (Cold Spot)': '#4575b4',\n",
        "    'High-Low': '#fdae61',\n",
        "    'Low-High': '#abd9e9',\n",
        "    'No significativo': '#f0f0f0',\n",
        "    'No data': '#d9d9d9'\n",
        "}\n",
        "\n",
        "fig, axes = plt.subplots(1, 2, figsize=(16, 8))\n",
        "\n",
        "ax1 = axes[0]\n",
        "gdf_fg.plot(ax=ax1, color=gdf_fg['cluster_f'].map(colors_dict), edgecolor='gray', linewidth=0.5)\n",
        "ax1.set_title('LISA Clusters - F-codes (Dementia)', fontsize=12, fontweight='bold')\n",
        "ax1.set_axis_off()\n",
        "\n",
        "ax2 = axes[1]\n",
        "gdf_fg.plot(ax=ax2, color=gdf_fg['cluster_g'].map(colors_dict), edgecolor='gray', linewidth=0.5)\n",
        "ax2.set_title('LISA Clusters - G-codes (Neurological)', fontsize=12, fontweight='bold')\n",
        "ax2.set_axis_off()\n",
        "\n",
        "legend_elements = [Patch(facecolor=color, edgecolor='black', label=label) \n",
        "                   for label, color in colors_dict.items() if label != 'No data']\n",
        "fig.legend(handles=legend_elements, loc='lower center', ncol=5, fontsize=10, \n",
        "           frameon=True, bbox_to_anchor=(0.5, -0.02))\n",
        "\n",
        "plt.suptitle('Local Indicators of Spatial Association (LISA)\\nGran Santiago - Neurodegenerative Disease ASR (2019-2024)', \n",
        "             fontsize=14, fontweight='bold', y=1.02)\n",
        "plt.tight_layout()\n",
        "save_figure(fig, 'lisa_clusters_fg.png')\n",
        "plt.show()"
      ],
      "id": "fig-lisa-maps",
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "code",
      "metadata": {},
      "source": [
        "#| label: tbl-lisa-hotspots\n",
        "#| tbl-cap: Significant LISA Clusters - Comunas Detail\n",
        "#| tbl-cap-location: bottom\n",
        "\n",
        "hotspots_f = gdf_fg[gdf_fg['cluster_f'] != 'No significativo'][['Comuna', 'asr_f', 'cluster_f', 'lisa_p_f']].copy()\n",
        "hotspots_f.columns = ['Comuna', 'ASR F', 'Cluster F', 'P-value F']\n",
        "hotspots_f = hotspots_f.sort_values('ASR F', ascending=False)\n",
        "\n",
        "hotspots_g = gdf_fg[gdf_fg['cluster_g'] != 'No significativo'][['Comuna', 'asr_g', 'cluster_g', 'lisa_p_g']].copy()\n",
        "hotspots_g.columns = ['Comuna', 'ASR G', 'Cluster G', 'P-value G']\n",
        "hotspots_g = hotspots_g.sort_values('ASR G', ascending=False)\n",
        "\n",
        "significant_clusters = gdf_fg[\n",
        "    (gdf_fg['cluster_f'] != 'No significativo') | (gdf_fg['cluster_g'] != 'No significativo')\n",
        "][['Comuna', 'asr_f', 'cluster_f', 'lisa_p_f', 'asr_g', 'cluster_g', 'lisa_p_g']].copy()\n",
        "significant_clusters.columns = ['Comuna', 'ASR F', 'Cluster F', 'P-value F', 'ASR G', 'Cluster G', 'P-value G']\n",
        "significant_clusters = significant_clusters.sort_values('ASR F', ascending=False)\n",
        "\n",
        "significant_clusters.style.format({\n",
        "    'ASR F': '{:.2f}',\n",
        "    'P-value F': '{:.4f}',\n",
        "    'ASR G': '{:.2f}',\n",
        "    'P-value G': '{:.4f}'\n",
        "}, na_rep='-').hide(axis=\"index\")"
      ],
      "id": "tbl-lisa-hotspots",
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "code",
      "metadata": {
        "fig-width": 16,
        "fig-height": 8
      },
      "source": [
        "#| label: fig-lisa-significance\n",
        "#| fig-cap: LISA Significance Maps (p < 0.05)\n",
        "\n",
        "fig, axes = plt.subplots(1, 2, figsize=(16, 8))\n",
        "\n",
        "gdf_fg['sig_f'] = gdf_fg['lisa_p_f'] < 0.05\n",
        "gdf_fg.plot(column='sig_f', cmap='RdYlGn_r', ax=axes[0], edgecolor='gray', linewidth=0.5, legend=False)\n",
        "for idx, row in gdf_fg[gdf_fg['sig_f']].iterrows():\n",
        "    centroid = row.geometry.centroid\n",
        "    axes[0].annotate(row['Comuna'][:8], xy=(centroid.x, centroid.y), fontsize=6, ha='center', fontweight='bold')\n",
        "axes[0].set_title('F-codes - Significant Clusters (p < 0.05)', fontsize=12, fontweight='bold')\n",
        "axes[0].set_axis_off()\n",
        "\n",
        "gdf_fg['sig_g'] = gdf_fg['lisa_p_g'] < 0.05\n",
        "gdf_fg.plot(column='sig_g', cmap='RdYlGn_r', ax=axes[1], edgecolor='gray', linewidth=0.5, legend=False)\n",
        "for idx, row in gdf_fg[gdf_fg['sig_g']].iterrows():\n",
        "    centroid = row.geometry.centroid\n",
        "    axes[1].annotate(row['Comuna'][:8], xy=(centroid.x, centroid.y), fontsize=6, ha='center', fontweight='bold')\n",
        "axes[1].set_title('G-codes - Significant Clusters (p < 0.05)', fontsize=12, fontweight='bold')\n",
        "axes[1].set_axis_off()\n",
        "\n",
        "plt.suptitle('LISA Significance Maps - Gran Santiago', fontsize=14, fontweight='bold', y=1.02)\n",
        "plt.tight_layout()\n",
        "save_figure(fig, 'lisa_significance_fg.png')\n",
        "plt.show()"
      ],
      "id": "fig-lisa-significance",
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "markdown",
      "metadata": {},
      "source": [
        "### Spatial Analysis Summary"
      ],
      "id": "69c15deb"
    },
    {
      "cell_type": "code",
      "metadata": {},
      "source": [
        "#| label: tbl-spatial-summary\n",
        "#| tbl-cap: Spatial Analysis Summary - F and G codes\n",
        "#| tbl-cap-location: bottom\n",
        "\n",
        "spatial_summary = pd.DataFrame({\n",
        "    'Metric': [\n",
        "        'Comunas analyzed',\n",
        "        'Comunas with F-code data',\n",
        "        'Comunas with G-code data',\n",
        "        'Mean ASR F-codes',\n",
        "        'Mean ASR G-codes',\n",
        "        \"Moran's I (F-codes)\",\n",
        "        \"Moran's I (G-codes)\",\n",
        "        'F-codes Hot Spots',\n",
        "        'F-codes Cold Spots',\n",
        "        'G-codes Hot Spots',\n",
        "        'G-codes Cold Spots'\n",
        "    ],\n",
        "    'Value': [\n",
        "        len(gdf_fg),\n",
        "        (gdf_fg['asr_f'] > 0).sum(),\n",
        "        (gdf_fg['asr_g'] > 0).sum(),\n",
        "        f\"{gdf_fg['asr_f'].mean():.2f}\",\n",
        "        f\"{gdf_fg['asr_g'].mean():.2f}\",\n",
        "        f\"{moran_f.I:.4f} (p={moran_f.p_norm:.4f})\" if moran_f else 'N/A',\n",
        "        f\"{moran_g.I:.4f} (p={moran_g.p_norm:.4f})\" if moran_g else 'N/A',\n",
        "        (gdf_fg['cluster_f'] == 'High-High (Hot Spot)').sum(),\n",
        "        (gdf_fg['cluster_f'] == 'Low-Low (Cold Spot)').sum(),\n",
        "        (gdf_fg['cluster_g'] == 'High-High (Hot Spot)').sum(),\n",
        "        (gdf_fg['cluster_g'] == 'Low-Low (Cold Spot)').sum()\n",
        "    ]\n",
        "})\n",
        "\n",
        "spatial_summary.style.hide(axis=\"index\")"
      ],
      "id": "tbl-spatial-summary",
      "execution_count": null,
      "outputs": []
    }
  ],
  "metadata": {
    "kernelspec": {
      "name": "python3",
      "language": "python",
      "display_name": "Python 3 (ipykernel)",
      "path": "C:\\Users\\amaru\\miniconda3\\envs\\spyder-env\\share\\jupyter\\kernels\\python3"
    }
  },
  "nbformat": 4,
  "nbformat_minor": 5
}